<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kickr Core Power Emulation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
        }
        .connected { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .power-display {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
        }
        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üö¥‚Äç‚ôÇÔ∏è Kickr Core Power Emulation Test</h1>
    <p>Connect to your real Wahoo Kickr Core and test power data emission</p>

    <div id="status" class="status info">
        Ready to connect to Kickr Core...
    </div>

    <div class="control-panel">
        <h3>Connection Controls</h3>
        <button id="connect-btn" class="btn-primary">üîó Connect Kickr Core</button>
        <button id="disconnect-btn" class="btn-warning" disabled>‚ùå Disconnect</button>
        <button id="start-spin-btn" class="btn-success" disabled>üå™Ô∏è Start Spin Down Test</button>
    </div>

    <div class="power-display" id="power-display">
        Power: -- W
    </div>

    <div class="metrics">
        <div class="metric">
            <div id="cadence-value" class="metric-value">--</div>
            <div class="metric-label">Cadence (RPM)</div>
        </div>
        <div class="metric">
            <div id="speed-value" class="metric-value">--</div>
            <div class="metric-label">Speed (km/h)</div>
        </div>
        <div class="metric">
            <div id="resistance-value" class="metric-value">--</div>
            <div class="metric-label">Resistance Level</div>
        </div>
        <div class="metric">
            <div id="trainer-status" class="metric-value">--</div>
            <div class="metric-label">Trainer Status</div>
        </div>
    </div>

    <div class="control-panel">
        <h3>Resistance Control</h3>
        <p>Set resistance to make pedaling generate power:</p>
        <input type="range" id="resistance-slider" min="0" max="100" value="20" style="width: 100%;">
        <div style="text-align: center; margin-top: 10px;">
            Resistance: <span id="resistance-display">20%</span>
        </div>
        <button id="set-resistance-btn" class="btn-primary" disabled>Set Resistance</button>
    </div>

    <div class="control-panel">
        <h3>üí° How to Generate Power Data:</h3>
        <ol>
            <li><strong>Connect</strong> your Kickr Core above</li>
            <li><strong>Set resistance</strong> using the slider (20-50% works well)</li>
            <li><strong>Start pedaling</strong> - even light pedaling will generate power</li>
            <li><strong>Watch real power data</strong> appear in real-time</li>
            <li><strong>Alternative:</strong> Use spin-down test to make trainer active</li>
        </ol>
        
        <h4>üéØ Pro Tips:</h4>
        <ul>
            <li><strong>Light Pedaling:</strong> Even 30-50W will show data flow</li>
            <li><strong>Resistance Matters:</strong> Higher resistance = more power for same effort</li>
            <li><strong>Spin Down:</strong> Kickr's built-in test generates movement data</li>
            <li><strong>ERG Mode:</strong> Set target power and trainer will adjust resistance</li>
        </ul>
    </div>

    <div id="log" style="background: #000; color: #0f0; padding: 15px; border-radius: 5px; height: 200px; overflow-y: auto; font-family: monospace;">
        <div>üöÄ Kickr Core Power Test Ready...</div>
    </div>

    <script>
        class KickrCorePowerTest {
            constructor() {
                this.device = null;
                this.server = null;
                this.powerService = null;
                this.fitnessService = null;
                this.controlService = null;
                this.isConnected = false;
                
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('connect-btn').addEventListener('click', () => this.connect());
                document.getElementById('disconnect-btn').addEventListener('click', () => this.disconnect());
                document.getElementById('start-spin-btn').addEventListener('click', () => this.startSpinDown());
                document.getElementById('set-resistance-btn').addEventListener('click', () => this.setResistance());
                
                const slider = document.getElementById('resistance-slider');
                slider.addEventListener('input', (e) => {
                    document.getElementById('resistance-display').textContent = e.target.value + '%';
                });
            }

            async connect() {
                try {
                    this.log('üîç Searching for Kickr Core...');
                    this.updateStatus('Connecting to Kickr Core...', 'info');

                    this.device = await navigator.bluetooth.requestDevice({
                        filters: [
                            { namePrefix: 'KICKR CORE' },
                            { namePrefix: 'KICKR' },
                            { namePrefix: 'Wahoo' },
                            { services: ['cycling_power'] },
                            { services: ['fitness_machine'] }
                        ],
                        optionalServices: [
                            'cycling_power',           // 0x1818 - Power data
                            'fitness_machine',         // 0x1826 - Trainer control  
                            'cycling_speed_and_cadence', // 0x1816 - Speed/cadence
                            'device_information',      // 0x180A - Device info
                            'battery_service'          // 0x180F - Battery
                        ]
                    });

                    this.log(`‚úÖ Found device: ${this.device.name}`);
                    
                    this.server = await this.device.gatt.connect();
                    this.log('üîó GATT connection established');

                    // Connect to power service
                    await this.setupPowerService();
                    
                    // Connect to fitness machine service for control
                    await this.setupFitnessService();

                    this.isConnected = true;
                    this.updateStatus(`Connected to ${this.device.name}`, 'connected');
                    this.updateUI(true);

                } catch (error) {
                    this.log(`‚ùå Connection failed: ${error.message}`);
                    this.updateStatus(`Connection failed: ${error.message}`, 'error');
                }
            }

            async setupPowerService() {
                try {
                    this.powerService = await this.server.getPrimaryService('cycling_power');
                    this.log('‚ö° Power service connected');

                    // Get power measurement characteristic
                    const powerChar = await this.powerService.getCharacteristic('cycling_power_measurement');
                    await powerChar.startNotifications();
                    
                    powerChar.addEventListener('characteristicvaluechanged', (event) => {
                        this.handlePowerData(event.target.value);
                    });

                    this.log('üìä Power notifications started');

                    // Get power feature characteristic
                    try {
                        const featureChar = await this.powerService.getCharacteristic('cycling_power_feature');
                        const features = await featureChar.readValue();
                        this.log(`üîß Power features: ${this.parsePowerFeatures(features)}`);
                    } catch (e) {
                        this.log('‚ö†Ô∏è Could not read power features');
                    }

                } catch (error) {
                    this.log(`‚ùå Power service setup failed: ${error.message}`);
                }
            }

            async setupFitnessService() {
                try {
                    this.fitnessService = await this.server.getPrimaryService('fitness_machine');
                    this.log('üèãÔ∏è Fitness machine service connected');

                    // Get indoor bike data characteristic
                    const bikeDataChar = await this.fitnessService.getCharacteristic('indoor_bike_data');
                    await bikeDataChar.startNotifications();
                    
                    bikeDataChar.addEventListener('characteristicvaluechanged', (event) => {
                        this.handleBikeData(event.target.value);
                    });

                    // Get fitness machine control point
                    this.controlChar = await this.fitnessService.getCharacteristic('fitness_machine_control_point');
                    this.log('üéÆ Trainer control ready');

                    this.log('üö¥ Bike data notifications started');

                } catch (error) {
                    this.log(`‚ùå Fitness service setup failed: ${error.message}`);
                }
            }

            handlePowerData(dataValue) {
                const flags = dataValue.getUint16(0, true);
                let index = 2;
                
                // Instantaneous power
                const power = dataValue.getUint16(index, true);
                index += 2;
                
                document.getElementById('power-display').textContent = `Power: ${power} W`;
                
                // Handle crank revolution data for cadence
                if (flags & 0x20) {
                    const crankRevolutions = dataValue.getUint16(index, true);
                    const lastCrankEventTime = dataValue.getUint16(index + 2, true);
                    
                    if (this.lastCrankData) {
                        const revDiff = crankRevolutions - this.lastCrankData.revolutions;
                        const timeDiff = (lastCrankEventTime - this.lastCrankData.time) / 1024;
                        
                        if (timeDiff > 0) {
                            const cadence = Math.round((revDiff / timeDiff) * 60);
                            document.getElementById('cadence-value').textContent = cadence;
                        }
                    }
                    
                    this.lastCrankData = { revolutions: crankRevolutions, time: lastCrankEventTime };
                }
                
                this.log(`‚ö° Power: ${power}W`);
            }

            handleBikeData(dataValue) {
                const flags = dataValue.getUint16(0, true);
                let index = 2;
                
                // Instantaneous speed
                if (flags & 0x1) {
                    const speed = dataValue.getUint16(index, true) * 0.01;
                    document.getElementById('speed-value').textContent = speed.toFixed(1);
                    index += 2;
                }
                
                // Instantaneous cadence
                if (flags & 0x4) {
                    const cadence = dataValue.getUint16(index, true) * 0.5;
                    document.getElementById('cadence-value').textContent = Math.round(cadence);
                    index += 2;
                }
                
                // Resistance level
                if (flags & 0x20) {
                    const resistance = dataValue.getInt16(index, true);
                    document.getElementById('resistance-value').textContent = resistance;
                    index += 2;
                }
                
                document.getElementById('trainer-status').textContent = 'Active';
                this.log(`üö¥ Bike data updated`);
            }

            async setResistance() {
                if (!this.controlChar) {
                    this.log('‚ùå No control characteristic available');
                    return;
                }

                try {
                    const resistanceLevel = parseInt(document.getElementById('resistance-slider').value);
                    
                    // Set resistance level command
                    const command = new Uint8Array([0x04, resistanceLevel]);
                    await this.controlChar.writeValue(command);
                    
                    this.log(`üéöÔ∏è Resistance set to ${resistanceLevel}%`);
                    this.log('üö¥ Start pedaling to generate power data!');

                } catch (error) {
                    this.log(`‚ùå Failed to set resistance: ${error.message}`);
                }
            }

            async startSpinDown() {
                if (!this.controlChar) {
                    this.log('‚ùå No control characteristic available');
                    return;
                }

                try {
                    // Start spin down test command
                    const command = new Uint8Array([0x01]); // Spin down test
                    await this.controlChar.writeValue(command);
                    
                    this.log('üå™Ô∏è Spin down test started');
                    this.log('‚è≥ This will make the trainer active and may generate some power readings');

                } catch (error) {
                    this.log(`‚ùå Failed to start spin down: ${error.message}`);
                }
            }

            async disconnect() {
                if (this.device && this.device.gatt.connected) {
                    this.device.gatt.disconnect();
                }
                
                this.isConnected = false;
                this.updateStatus('Disconnected', 'info');
                this.updateUI(false);
                this.log('‚ùå Disconnected from Kickr Core');
            }

            parsePowerFeatures(dataValue) {
                const features = dataValue.getUint32(0, true);
                const featureList = [];
                
                if (features & 0x1) featureList.push('Pedal Power Balance');
                if (features & 0x2) featureList.push('Accumulated Torque');
                if (features & 0x4) featureList.push('Wheel Revolution Data');
                if (features & 0x8) featureList.push('Crank Revolution Data');
                
                return featureList.join(', ') || 'Basic Power';
            }

            updateStatus(message, type) {
                const statusEl = document.getElementById('status');
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
            }

            updateUI(connected) {
                document.getElementById('connect-btn').disabled = connected;
                document.getElementById('disconnect-btn').disabled = !connected;
                document.getElementById('start-spin-btn').disabled = !connected;
                document.getElementById('set-resistance-btn').disabled = !connected;
            }

            log(message) {
                const logEl = document.getElementById('log');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.textContent = `[${timestamp}] ${message}`;
                logEl.appendChild(logEntry);
                logEl.scrollTop = logEl.scrollHeight;
                console.log(message);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.kickrTest = new KickrCorePowerTest();
        });
    </script>
</body>
</html>