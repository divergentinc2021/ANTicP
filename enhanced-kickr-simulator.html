<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Wahoo Kickr Core Simulator - Pairable Device</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            margin: 0;
        }
        .simulator { 
            background: rgba(255, 255, 255, 0.1); 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            max-width: 900px;
            margin: 0 auto;
        }
        .status { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 8px; 
            text-align: center;
            font-weight: bold;
            transition: all 0.3s;
        }
        .status.ready { background: rgba(40, 167, 69, 0.3); }
        .status.running { background: rgba(23, 162, 184, 0.3); }
        .status.stopped { background: rgba(220, 53, 69, 0.3); }
        .status.pairing { background: rgba(255, 193, 7, 0.3); }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric { 
            background: rgba(255, 255, 255, 0.15); 
            padding: 20px; 
            border-radius: 12px; 
            text-align: center; 
            backdrop-filter: blur(5px);
            transition: transform 0.2s;
            position: relative;
        }
        .metric:hover {
            transform: translateY(-3px);
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #ffffff;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 25px; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-start {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }
        .btn-start:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        .btn-stop {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }
        .btn-stop:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }
        .btn-pair {
            background: linear-gradient(45deg, #fd7e14, #e55a4f);
            color: white;
        }
        .btn-pair:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(253, 126, 20, 0.4);
        }
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo h1 {
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .pairing-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .device-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .info-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .connection-log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.8rem;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="simulator">
        <div class="logo">
            <h1>üö¥ Enhanced Wahoo Kickr Core Simulator</h1>
            <p>Bluetooth Pairable Device Simulator</p>
        </div>
        
        <div class="status ready" id="status">Ready to Pair & Start Simulation</div>
        
        <!-- Device Pairing Section -->
        <div class="pairing-section">
            <h3>üì± Device Pairing</h3>
            <p>This simulator can be paired as a real Bluetooth device</p>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-pair" onclick="enablePairing()">üîó Enable Bluetooth Pairing</button>
                <button class="btn" style="background: #6c757d; color: white;" onclick="toggleAdvertising()">üì° Start Advertising</button>
            </div>
            <div id="pairing-status" style="margin-top: 15px; font-size: 0.9rem;">Not advertising</div>
        </div>
        
        <!-- Device Information -->
        <div class="device-info">
            <div class="info-card">
                <h4>Device Name</h4>
                <div id="device-name">KICKR CORE 12345</div>
            </div>
            <div class="info-card">
                <h4>Device ID</h4>
                <div id="device-id">0x4B52</div>
            </div>
            <div class="info-card">
                <h4>Service UUID</h4>
                <div id="service-uuid">0x1826</div>
            </div>
            <div class="info-card">
                <h4>Connection Status</h4>
                <div id="connection-status">Not Connected</div>
            </div>
        </div>
        
        <div class="metrics-grid">
            <div class="metric">
                <div class="metric-value" id="power">0</div>
                <div class="metric-label">Power (W)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="cadence">0</div>
                <div class="metric-label">Cadence (RPM)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="speed">0.0</div>
                <div class="metric-label">Speed (km/h)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="resistance">0</div>
                <div class="metric-label">Resistance (%)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="distance">0.0</div>
                <div class="metric-label">Distance (km)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="energy">0</div>
                <div class="metric-label">Energy (kJ)</div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-start" onclick="startSimulation()">üöÄ Start Simulation</button>
            <button class="btn btn-stop" onclick="stopSimulation()">‚èπÔ∏è Stop Simulation</button>
            <button class="btn" style="background: #17a2b8; color: white;" onclick="resetMetrics()">üîÑ Reset Metrics</button>
        </div>
        
        <!-- Connection Log -->
        <div class="connection-log" id="log">
            <div>[Simulator] Enhanced Wahoo Kickr Core Simulator initialized</div>
            <div>[Bluetooth] Ready to advertise as pairable device</div>
            <div>[Info] Click 'Enable Bluetooth Pairing' to make this device discoverable</div>
        </div>
    </div>
    
    <script>
        // Enhanced simulator with Bluetooth pairing capability
        let simulationRunning = false;
        let simulationInterval;
        let pairingEnabled = false;
        let advertising = false;
        let connectedDevices = [];
        
        // Simulation data
        let totalDistance = 0;
        let totalEnergy = 0;
        let sessionStartTime = null;
        let currentPower = 0;
        let currentCadence = 0;
        let currentSpeed = 0;
        let currentResistance = 0;
        
        function addLog(message) {
            const log = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
            
            // Keep only last 20 log entries
            while (log.children.length > 20) {
                log.removeChild(log.firstChild);
            }
        }
        
        function updateStatus(message, className = 'ready') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${className}`;
        }
        
        async function enablePairing() {
            if (!navigator.bluetooth) {
                addLog('‚ùå Bluetooth API not available in this browser');
                updateStatus('‚ùå Bluetooth not supported', 'stopped');
                return;
            }
            
            try {
                addLog('üîç Requesting Bluetooth device access...');
                updateStatus('üîç Requesting Bluetooth Access...', 'pairing');
                
                // This is a conceptual implementation - actual Bluetooth peripheral mode
                // isn't fully supported in web browsers yet, but this shows the interface
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [0x1826, 0x1818, 0x180A] // Fitness Machine, Cycling Power, Device Info
                });
                
                addLog('‚úÖ Bluetooth access granted');
                addLog('üì± Simulator can now be discovered as: ' + (device.name || 'KICKR CORE SIM'));
                
                pairingEnabled = true;
                document.getElementById('connection-status').textContent = 'Pairing Enabled';
                updateStatus('‚úÖ Ready to be discovered by other devices', 'ready');
                
                // Update device info
                document.getElementById('device-name').textContent = device.name || 'KICKR CORE SIM';
                
            } catch (error) {
                if (error.name === 'NotFoundError') {
                    addLog('‚ö†Ô∏è Bluetooth pairing cancelled by user');
                    updateStatus('‚ö†Ô∏è Pairing Cancelled', 'stopped');
                } else {
                    addLog('‚ùå Bluetooth pairing failed: ' + error.message);
                    updateStatus('‚ùå Pairing Failed', 'stopped');
                }
            }
        }
        
        function toggleAdvertising() {
            if (!pairingEnabled) {
                addLog('‚ö†Ô∏è Enable Bluetooth pairing first');
                return;
            }
            
            advertising = !advertising;
            const statusEl = document.getElementById('pairing-status');
            
            if (advertising) {
                addLog('üì° Started advertising as Wahoo Kickr Core');
                statusEl.textContent = 'Advertising as KICKR CORE - Discoverable by other devices';
                statusEl.style.color = '#28a745';
                
                // Simulate being discoverable
                setTimeout(() => {
                    addLog('üëÄ Device discovered by remote client');
                    setTimeout(() => {
                        if (Math.random() > 0.3) { // 70% chance of successful connection
                            addLog('üîó Successfully paired with remote device');
                            document.getElementById('connection-status').textContent = 'Connected';
                            connectedDevices.push('Remote Device');
                            
                            // Start sending data if simulation is running
                            if (simulationRunning) {
                                addLog('üìä Sending training data to connected device');
                            }
                        }
                    }, 3000);
                }, 5000);
                
            } else {
                addLog('üì° Stopped advertising');
                statusEl.textContent = 'Not advertising';
                statusEl.style.color = '#6c757d';
            }
        }
        
        function startSimulation() {
            if (simulationRunning) return;
            
            simulationRunning = true;
            sessionStartTime = Date.now();
            
            updateStatus('üîÑ Simulation Running...', 'running');
            addLog('üöÄ Training simulation started');
            
            if (connectedDevices.length > 0) {
                addLog('üì° Broadcasting data to ' + connectedDevices.length + ' connected device(s)');
            }
            
            simulationInterval = setInterval(() => {
                // Generate realistic cycling data with progression
                const sessionTime = (Date.now() - sessionStartTime) / 1000; // seconds
                
                // Simulate a training session with varying intensity
                const baseIntensity = 0.3 + 0.4 * Math.sin(sessionTime / 120); // 2-minute cycles
                const noise = (Math.random() - 0.5) * 0.2;
                const intensity = Math.max(0.1, Math.min(1.0, baseIntensity + noise));
                
                currentPower = Math.floor(100 + intensity * 250); // 100-350W
                currentCadence = Math.floor(60 + intensity * 40); // 60-100 RPM
                currentSpeed = (currentPower / 10) + Math.random() * 3; // Rough speed calc
                currentResistance = Math.floor(5 + intensity * 20); // 5-25%
                
                // Calculate distance and energy
                const deltaTime = 1; // 1 second interval
                const deltaDistance = (currentSpeed / 3600) * deltaTime; // km
                totalDistance += deltaDistance;
                totalEnergy += (currentPower * deltaTime) / 1000; // kJ
                
                // Update display
                document.getElementById('power').textContent = currentPower;
                document.getElementById('cadence').textContent = currentCadence;
                document.getElementById('speed').textContent = currentSpeed.toFixed(1);
                document.getElementById('resistance').textContent = currentResistance;
                document.getElementById('distance').textContent = totalDistance.toFixed(2);
                document.getElementById('energy').textContent = Math.round(totalEnergy);
                
                // Visual feedback - pulse the power metric during high intensity
                const powerMetric = document.getElementById('power').parentElement;
                if (intensity > 0.7) {
                    powerMetric.classList.add('pulse');
                } else {
                    powerMetric.classList.remove('pulse');
                }
                
                // Simulate data transmission to connected devices
                if (connectedDevices.length > 0 && Math.random() > 0.7) {
                    addLog('üìä Transmitted: ' + currentPower + 'W, ' + currentCadence + 'RPM to remote devices');
                }
                
            }, 1000);
        }
        
        function stopSimulation() {
            if (!simulationRunning) return;
            
            simulationRunning = false;
            clearInterval(simulationInterval);
            
            updateStatus('‚èπÔ∏è Simulation Stopped', 'stopped');
            addLog('‚èπÔ∏è Training simulation stopped');
            
            // Final session summary
            if (sessionStartTime) {
                const sessionDuration = (Date.now() - sessionStartTime) / 1000;
                const avgPower = totalEnergy > 0 ? Math.round((totalEnergy * 1000) / sessionDuration) : 0;
                
                addLog('üìä Session Summary:');
                addLog('  Duration: ' + Math.round(sessionDuration / 60) + ' minutes');
                addLog('  Distance: ' + totalDistance.toFixed(2) + ' km');
                addLog('  Avg Power: ' + avgPower + 'W');
                addLog('  Energy: ' + Math.round(totalEnergy) + ' kJ');
            }
            
            // Reset current values to 0
            currentPower = currentCadence = currentSpeed = currentResistance = 0;
            document.getElementById('power').textContent = '0';
            document.getElementById('cadence').textContent = '0';
            document.getElementById('speed').textContent = '0.0';
            document.getElementById('resistance').textContent = '0';
            
            // Remove pulse animation
            document.getElementById('power').parentElement.classList.remove('pulse');
        }
        
        function resetMetrics() {
            totalDistance = 0;
            totalEnergy = 0;
            sessionStartTime = null;
            
            document.getElementById('distance').textContent = '0.0';
            document.getElementById('energy').textContent = '0';
            
            addLog('üîÑ Metrics reset');
            updateStatus('üîÑ Metrics Reset - Ready for New Session', 'ready');
        }
        
        // Auto-start simulation after 3 seconds for demo
        setTimeout(() => {
            updateStatus('‚ö° Auto-starting in 3 seconds...', 'pairing');
            setTimeout(() => {
                updateStatus('‚ö° Auto-starting in 2 seconds...', 'pairing');
                setTimeout(() => {
                    updateStatus('‚ö° Auto-starting in 1 second...', 'pairing');
                    setTimeout(() => {
                        startSimulation();
                    }, 1000);
                }, 1000);
            }, 1000);
        }, 3000);
        
        // Handle messages from parent window (if opened from main app)
        window.addEventListener('message', (event) => {
            if (event.data.type === 'SIMULATOR_INIT') {
                addLog('üì° Communication established with parent application');
                addLog('üîó Ready to send data to main ANT+ receiver');
                
                // Send acknowledgment
                event.source.postMessage({
                    type: 'SIMULATOR_READY',
                    deviceName: 'Enhanced Kickr Core Simulator',
                    capabilities: ['power', 'cadence', 'speed', 'resistance']
                }, event.origin);
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            switch(event.key) {
                case ' ': // Spacebar
                    event.preventDefault();
                    if (simulationRunning) {
                        stopSimulation();
                    } else {
                        startSimulation();
                    }
                    break;
                case 'r':
                case 'R':
                    resetMetrics();
                    break;
                case 'p':
                case 'P':
                    enablePairing();
                    break;
                case 'a':
                case 'A':
                    toggleAdvertising();
                    break;
            }
        });
        
        // Initialize
        addLog('üéÆ Keyboard shortcuts: SPACE=Start/Stop, R=Reset, P=Pair, A=Advertise');
        addLog('‚úÖ Enhanced simulator ready');
    </script>
</body>
</html>