<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zwift Click Button Pattern Debugger - Fixed</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: #48bb78;
            color: white;
        }
        .btn-danger {
            background: #f56565;
            color: white;
        }
        .pattern-section {
            margin: 30px 0;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        .pattern-item {
            padding: 12px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }
        .pattern-item.up {
            border-left-color: #48bb78;
        }
        .pattern-item.down {
            border-left-color: #4299e1;
        }
        .pattern-item.unknown {
            border-left-color: #ed8936;
        }
        .byte-display {
            font-size: 14px;
            color: #2d3748;
        }
        .button-label {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .button-label.up {
            background: #48bb78;
            color: white;
        }
        .button-label.down {
            background: #4299e1;
            color: white;
        }
        .button-label.unknown {
            background: #ed8936;
            color: white;
        }
        .log-area {
            background: #1a202c;
            color: #68d391;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        .instructions {
            background: #bee3f8;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #90cdf4;
        }
        .gear-display {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Zwift Click Button Pattern Debugger - Fixed Version</h1>
        
        <div class="status disconnected" id="status">
            Not Connected
        </div>

        <div class="instructions">
            <strong>üìã How to identify your button patterns:</strong>
            <ol>
                <li>Press any button on your Zwift Click to wake it (LED should pulse blue)</li>
                <li>Click "Connect Zwift Click" and select your device</li>
                <li>Wait for handshake to complete</li>
                <li>Press the <strong>UP/PLUS</strong> button 3 times slowly</li>
                <li>Click "Mark Previous as UP"</li>
                <li>Press the <strong>DOWN/MINUS</strong> button 3 times slowly</li>
                <li>Click "Mark Previous as DOWN"</li>
                <li>The patterns will be saved and buttons will work!</li>
            </ol>
        </div>

        <div class="button-group">
            <button class="btn-primary" onclick="zwiftDebugger.connect()">üîó Connect Zwift Click</button>
            <button class="btn-success" onclick="zwiftDebugger.markAsUp()">‚¨ÜÔ∏è Mark Previous as UP</button>
            <button class="btn-success" onclick="zwiftDebugger.markAsDown()">‚¨áÔ∏è Mark Previous as DOWN</button>
            <button class="btn-danger" onclick="zwiftDebugger.clearPatterns()">üóëÔ∏è Clear Patterns</button>
            <button class="btn-primary" onclick="zwiftDebugger.exportPatterns()">üì• Export Patterns</button>
        </div>

        <div class="gear-display" id="gear-display">
            Gear: --/24
        </div>

        <div class="pattern-section">
            <h3>üéØ Detected Patterns</h3>
            <div id="pattern-list">
                <div style="color: #718096; text-align: center; padding: 20px;">
                    No patterns detected yet. Connect and press buttons!
                </div>
            </div>
        </div>

        <div class="pattern-section">
            <h3>‚úÖ Learned Button Patterns</h3>
            <div id="learned-patterns">
                <div style="color: #718096; text-align: center; padding: 20px;">
                    No patterns learned yet.
                </div>
            </div>
        </div>

        <div class="log-area" id="log">
            Ready to debug Zwift Click buttons...
        </div>
    </div>

    <script>
        class ZwiftClickDebugger {
            constructor() {
                this.device = null;
                this.server = null;
                this.service = null;
                this.characteristics = {};
                this.patterns = [];
                this.lastPattern = null;
                this.learnedPatterns = {
                    up: null,
                    down: null
                };
                this.currentGear = 12;
                this.maxGears = 24;
                
                // Load saved patterns from localStorage
                this.loadPatterns();
            }
            
            log(message) {
                const logEl = document.getElementById('log');
                const timestamp = new Date().toLocaleTimeString();
                const logMessage = `[${timestamp}] ${message}`;
                logEl.innerHTML += logMessage + '\n';
                logEl.scrollTop = logEl.scrollHeight;
                console.log(logMessage);
            }
            
            async connect() {
                try {
                    this.log('üîç Searching for Zwift Click...');
                    this.log('üí° Make sure LED is pulsing blue (press a button to wake)');
                    
                    // Request device with proper filters
                    this.device = await navigator.bluetooth.requestDevice({
                        filters: [
                            { namePrefix: 'Zwift Click' },
                            { namePrefix: 'CLICK' },
                            { namePrefix: 'Click' }
                        ],
                        optionalServices: [
                            '00000001-19ca-4651-86e5-fa29dcdd09d1',  // Zwift service
                            '0000180f-0000-1000-8000-00805f9b34fb'   // Battery service
                        ]
                    });
                    
                    this.log(`‚úÖ Found: ${this.device.name}`);
                    
                    // Connect to GATT server
                    this.server = await this.device.gatt.connect();
                    this.log('‚úÖ Connected to GATT server');
                    
                    // Get the Zwift service
                    this.service = await this.server.getPrimaryService('00000001-19ca-4651-86e5-fa29dcdd09d1');
                    this.log('‚úÖ Got Zwift service');
                    
                    // Get all characteristics
                    const characteristics = await this.service.getCharacteristics();
                    this.log(`üìã Found ${characteristics.length} characteristics`);
                    
                    // Map characteristics by UUID suffix for easier access
                    for (const char of characteristics) {
                        const uuid = char.uuid;
                        const shortUuid = uuid.slice(-4);
                        this.characteristics[shortUuid] = char;
                        this.log(`  - Characteristic: ${shortUuid} (${char.properties.notify ? 'notify' : ''} ${char.properties.write ? 'write' : ''} ${char.properties.read ? 'read' : ''})`);
                    }
                    
                    // Setup notifications on measurement characteristic (0002)
                    if (this.characteristics['09d1']) {  // This is 0002 characteristic
                        await this.characteristics['09d1'].startNotifications();
                        this.characteristics['09d1'].addEventListener('characteristicvaluechanged', (event) => {
                            this.handleButtonData(event.target.value);
                        });
                        this.log('üîî Listening for button presses on measurement characteristic');
                    }
                    
                    // Setup notifications on response characteristic (0004)
                    const responseChar = this.characteristics['cdd0'];  // This is 0004 characteristic
                    if (responseChar && responseChar.properties.notify) {
                        await responseChar.startNotifications();
                        responseChar.addEventListener('characteristicvaluechanged', (event) => {
                            this.handleResponseData(event.target.value);
                        });
                        this.log('üîî Listening on response characteristic');
                    }
                    
                    // Send handshake to control characteristic (0003)
                    const controlChar = this.characteristics['dfe7'];  // This is 0003 characteristic
                    if (controlChar && controlChar.properties.write) {
                        // Send "RideOn" handshake
                        const handshake = new TextEncoder().encode('RideOn');
                        await controlChar.writeValue(handshake);
                        this.log('üì§ Sent handshake: "RideOn"');
                        
                        // Alternative: Try sending a different init sequence
                        // Some implementations use different init sequences
                        await this.delay(100);
                        
                        // Try sending an unlock/init command (based on research)
                        const initCommand = new Uint8Array([0x00, 0x01]);  // Basic init
                        try {
                            await controlChar.writeValue(initCommand);
                            this.log('üì§ Sent init command');
                        } catch (e) {
                            this.log(`‚ö†Ô∏è Init command failed: ${e.message}`);
                        }
                    }
                    
                    // Update status
                    document.getElementById('status').className = 'status connected';
                    document.getElementById('status').textContent = `Connected to ${this.device.name}`;
                    
                    this.log('üéÆ Ready! Press buttons to see patterns.');
                    this.log('üí° If no data appears, try pressing buttons multiple times');
                    
                    // Try reading battery level if available
                    try {
                        const batteryService = await this.server.getPrimaryService('0000180f-0000-1000-8000-00805f9b34fb');
                        const batteryChar = await batteryService.getCharacteristic('00002a19-0000-1000-8000-00805f9b34fb');
                        const batteryValue = await batteryChar.readValue();
                        const batteryLevel = batteryValue.getUint8(0);
                        this.log(`üîã Battery level: ${batteryLevel}%`);
                    } catch (e) {
                        this.log('‚ö†Ô∏è Could not read battery level');
                    }
                    
                } catch (error) {
                    this.log(`‚ùå Error: ${error.message}`);
                    document.getElementById('status').className = 'status disconnected';
                    document.getElementById('status').textContent = 'Connection Failed';
                }
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            handleButtonData(dataValue) {
                const data = new Uint8Array(dataValue.buffer);
                const hexString = Array.from(data).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
                
                this.log(`üì¶ Raw data received: ${hexString}`);
                
                // Store as last pattern
                this.lastPattern = hexString;
                
                // Try to decode button press
                // Based on research, button messages typically have specific patterns
                // Message type 0x37 is common for button state
                if (data.length >= 5 && data[0] === 0x37) {
                    const stateByte = data[2];  // 0x00 = pressed, 0x01 = released
                    const buttonByte = data[4]; // Identifies which button
                    
                    let buttonType = 'unknown';
                    let buttonState = stateByte === 0x00 ? 'PRESSED' : 'RELEASED';
                    
                    // Try to identify button
                    if (buttonByte === 0x01) {
                        buttonType = 'up';
                        this.log(`üîº UP button ${buttonState}`);
                    } else if (buttonByte === 0x00) {
                        buttonType = 'down';
                        this.log(`üîΩ DOWN button ${buttonState}`);
                    } else {
                        this.log(`‚ùì Unknown button (byte: 0x${buttonByte.toString(16)}) ${buttonState}`);
                    }
                    
                    // Only track press events for patterns
                    if (stateByte === 0x00) {
                        this.trackPattern(hexString, buttonType);
                        
                        if (buttonType === 'up') {
                            this.handleGearChange('up');
                        } else if (buttonType === 'down') {
                            this.handleGearChange('down');
                        }
                    }
                } else {
                    // Track any pattern we receive
                    this.trackPattern(hexString, 'unknown');
                }
            }
            
            handleResponseData(dataValue) {
                const data = new Uint8Array(dataValue.buffer);
                const hexString = Array.from(data).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
                this.log(`üì® Response data: ${hexString}`);
            }
            
            trackPattern(hexString, buttonType) {
                // Check if this is a learned pattern
                if (this.learnedPatterns.up === hexString) {
                    buttonType = 'up';
                } else if (this.learnedPatterns.down === hexString) {
                    buttonType = 'down';
                }
                
                // Add to patterns list if new
                if (!this.patterns.some(p => p.hex === hexString)) {
                    this.patterns.push({
                        hex: hexString,
                        type: buttonType,
                        count: 1,
                        timestamp: Date.now()
                    });
                    this.log(`‚ú® New pattern detected: ${hexString}`);
                } else {
                    // Increment count
                    const pattern = this.patterns.find(p => p.hex === hexString);
                    pattern.count++;
                    pattern.timestamp = Date.now();
                }
                
                this.updatePatternDisplay();
            }
            
            handleGearChange(direction) {
                if (direction === 'up' && this.currentGear < this.maxGears) {
                    this.currentGear++;
                } else if (direction === 'down' && this.currentGear > 1) {
                    this.currentGear--;
                }
                
                document.getElementById('gear-display').textContent = `Gear: ${this.currentGear}/${this.maxGears}`;
                this.log(`‚öôÔ∏è Gear ${direction} ‚Üí ${this.currentGear}/${this.maxGears}`);
            }
            
            markAsUp() {
                if (this.lastPattern) {
                    this.learnedPatterns.up = this.lastPattern;
                    const pattern = this.patterns.find(p => p.hex === this.lastPattern);
                    if (pattern) pattern.type = 'up';
                    this.updatePatternDisplay();
                    this.savePatterns();
                    this.log(`‚úÖ Marked "${this.lastPattern}" as UP button`);
                } else {
                    this.log('‚ö†Ô∏è No recent pattern to mark. Press a button first!');
                }
            }
            
            markAsDown() {
                if (this.lastPattern) {
                    this.learnedPatterns.down = this.lastPattern;
                    const pattern = this.patterns.find(p => p.hex === this.lastPattern);
                    if (pattern) pattern.type = 'down';
                    this.updatePatternDisplay();
                    this.savePatterns();
                    this.log(`‚úÖ Marked "${this.lastPattern}" as DOWN button`);
                } else {
                    this.log('‚ö†Ô∏è No recent pattern to mark. Press a button first!');
                }
            }
            
            updatePatternDisplay() {
                // Update detected patterns
                const patternList = document.getElementById('pattern-list');
                if (this.patterns.length === 0) {
                    patternList.innerHTML = '<div style="color: #718096; text-align: center; padding: 20px;">No patterns detected yet.</div>';
                } else {
                    patternList.innerHTML = this.patterns
                        .sort((a, b) => b.timestamp - a.timestamp)
                        .map(p => `
                            <div class="pattern-item ${p.type}">
                                <span class="byte-display">${p.hex}</span>
                                <span>
                                    <span class="button-label ${p.type}">${p.type}</span>
                                    <span style="margin-left: 10px; color: #718096;">√ó${p.count}</span>
                                </span>
                            </div>
                        `).join('');
                }
                
                // Update learned patterns
                const learnedDiv = document.getElementById('learned-patterns');
                const learned = [];
                if (this.learnedPatterns.up) {
                    learned.push(`
                        <div class="pattern-item up">
                            <span class="byte-display">${this.learnedPatterns.up}</span>
                            <span class="button-label up">UP BUTTON</span>
                        </div>
                    `);
                }
                if (this.learnedPatterns.down) {
                    learned.push(`
                        <div class="pattern-item down">
                            <span class="byte-display">${this.learnedPatterns.down}</span>
                            <span class="button-label down">DOWN BUTTON</span>
                        </div>
                    `);
                }
                
                if (learned.length > 0) {
                    learnedDiv.innerHTML = learned.join('');
                } else {
                    learnedDiv.innerHTML = '<div style="color: #718096; text-align: center; padding: 20px;">No patterns learned yet.</div>';
                }
            }
            
            clearPatterns() {
                this.patterns = [];
                this.learnedPatterns = { up: null, down: null };
                this.lastPattern = null;
                this.updatePatternDisplay();
                localStorage.removeItem('zwiftClickPatterns');
                this.log('üóëÔ∏è Cleared all patterns');
            }
            
            savePatterns() {
                localStorage.setItem('zwiftClickPatterns', JSON.stringify(this.learnedPatterns));
            }
            
            loadPatterns() {
                const saved = localStorage.getItem('zwiftClickPatterns');
                if (saved) {
                    this.learnedPatterns = JSON.parse(saved);
                    this.log('üìÇ Loaded saved patterns');
                    this.updatePatternDisplay();
                }
            }
            
            exportPatterns() {
                const exportData = {
                    learnedPatterns: this.learnedPatterns,
                    allPatterns: this.patterns,
                    deviceName: this.device?.name || 'Unknown',
                    timestamp: new Date().toISOString()
                };
                
                const json = JSON.stringify(exportData, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'zwift-click-patterns.json';
                a.click();
                
                this.log('üì• Exported patterns to file');
            }
        }
        
        // Create global instance
        const zwiftDebugger = new ZwiftClickDebugger();
    </script>
</body>
</html>