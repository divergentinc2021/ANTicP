<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANT+ Railway Bridge Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        .btn:hover { background: #0056b3; transform: translateY(-2px); }
        .btn:disabled { background: #6c757d; cursor: not-allowed; transform: none; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-railway { background: #6366f1; }
        .btn-railway:hover { background: #4f46e5; }
        
        .hero-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .hero-section h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .railway-banner {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .status-panel {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 25px;
            margin: 25px 0;
        }
        
        .status-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 12px;
        }
        .status-connected { background: #28a745; }
        .status-connecting { background: #ffc107; }
        .status-error { background: #dc3545; }
        .status-offline { background: #6c757d; }
        
        .url-display {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            margin: 15px 0;
            word-break: break-all;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 20px 0;
        }
        
        .data-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .device-card {
            background: #fff;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        
        .device-card.active {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .info-box {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="hero-section">
            <h1>üöÇ ANT+ Railway Bridge</h1>
            <p>Cloud-hosted ANT+ middleware running on Railway</p>
        </div>
        
        <div class="railway-banner">
            <h3>üåê Running on Railway Platform</h3>
            <p>Your ANT+ bridge is hosted in the cloud with automatic scaling and global CDN</p>
            <div class="url-display" id="bridge-url">
                Detecting Railway URL...
            </div>
        </div>

        <div class="status-panel">
            <h3>üìä Connection Status</h3>
            <div id="bridge-status">
                <span class="status-indicator status-offline"></span>
                Railway Bridge: <span id="bridge-text">Connecting...</span>
            </div>
            <div id="ant-status" style="margin-top: 15px;">
                <span class="status-indicator status-offline"></span>
                ANT+ Device: <span id="ant-text">Not connected</span>
            </div>
        </div>

        <div class="info-box">
            <h3>‚ÑπÔ∏è Railway Bridge Benefits</h3>
            <ul>
                <li><strong>üåç Global Access:</strong> Your bridge works from anywhere with internet</li>
                <li><strong>‚ö° Auto-scaling:</strong> Railway handles traffic spikes automatically</li>
                <li><strong>üîÑ Auto-restart:</strong> Server restarts automatically if it goes down</li>
                <li><strong>üîí HTTPS/WSS:</strong> Secure WebSocket connections</li>
                <li><strong>üìä Built-in monitoring:</strong> Railway tracks performance and uptime</li>
            </ul>
        </div>

        <div class="controls">
            <button class="btn btn-railway" onclick="connectToRailway()" id="connect-btn">üöÇ Connect to Railway Bridge</button>
            <button class="btn btn-success" onclick="connectANT(50000)" disabled id="ant-50k-btn">‚ö° 50K Hz</button>
            <button class="btn btn-success" onclick="connectANT(57600)" disabled id="ant-57k-btn">‚ö° 57.6K Hz</button>
            <button class="btn btn-success" onclick="connectANT(115200)" disabled id="ant-115k-btn">‚ö° 115.2K Hz</button>
            <button class="btn btn-success" onclick="connectANT(2000000)" disabled id="ant-2m-btn">üöÄ 2MHz</button>
            <button class="btn btn-success" onclick="connectANT(3000000)" disabled id="ant-3m-btn">üí® 3MHz</button>
            <button class="btn btn-danger" onclick="disconnectANT()" disabled id="disconnect-btn">üîå Disconnect ANT+</button>
            <button class="btn" onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div class="data-panel">
            <div class="device-card" id="trainer-card">
                <h4>üö¥ Trainer/FE-C</h4>
                <div id="trainer-data">No data</div>
            </div>
            <div class="device-card" id="hr-card">
                <h4>‚ù§Ô∏è Heart Rate</h4>
                <div id="hr-data">No data</div>
            </div>
            <div class="device-card" id="power-card">
                <h4>‚ö° Power Meter</h4>
                <div id="power-data">No data</div>
            </div>
        </div>

        <div class="log" id="log">
ANT+ Railway Bridge Test
========================
üöÇ Cloud-hosted ANT+ middleware on Railway platform

Features:
‚Ä¢ Automatic Railway URL detection
‚Ä¢ Global accessibility via CDN
‚Ä¢ Secure WebSocket connections (WSS)
‚Ä¢ All 5 transfer rates (50K - 3MHz)
‚Ä¢ Real-time device data streaming

Connecting to Railway bridge server...
        </div>
    </div>

    <script type="module">
        // Railway-compatible ANT+ Bridge Client
        class RailwayANTBridgeClient {
            constructor() {
                this.ws = null;
                this.connected = false;
                this.antConnected = false;
                this.listeners = new Map();
                this.serverUrl = this.detectRailwayUrl();
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
            }

            detectRailwayUrl() {
                const hostname = window.location.hostname;
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                
                // Railway detection
                if (hostname.includes('railway.app') || hostname.includes('.railway.')) {
                    return `${protocol}//${hostname}`;
                }
                
                // Check URL parameters for custom bridge URL
                const urlParams = new URLSearchParams(window.location.search);
                const bridgeUrl = urlParams.get('bridge_url');
                if (bridgeUrl) {
                    return bridgeUrl.startsWith('ws') ? bridgeUrl : `wss://${bridgeUrl}`;
                }
                
                // Default to localhost for local development
                return 'ws://localhost:8888';
            }

            on(event, callback) {
                if (!this.listeners.has(event)) {
                    this.listeners.set(event, []);
                }
                this.listeners.get(event).push(callback);
            }

            emit(event, data) {
                if (this.listeners.has(event)) {
                    this.listeners.get(event).forEach(callback => {
                        try {
                            callback(data);
                        } catch (error) {
                            console.error(`Error in ${event} callback:`, error);
                        }
                    });
                }
            }

            async connect() {
                return new Promise((resolve, reject) => {
                    try {
                        console.log(`üöÇ Connecting to Railway bridge: ${this.serverUrl}`);
                        this.emit('connecting', { url: this.serverUrl });

                        this.ws = new WebSocket(this.serverUrl);

                        // Longer timeout for Railway cold starts
                        const timeout = setTimeout(() => {
                            if (this.ws.readyState !== WebSocket.OPEN) {
                                this.ws.close();
                                reject(new Error('Railway server connection timeout - server may be starting up'));
                            }
                        }, 20000);

                        this.ws.onopen = () => {
                            clearTimeout(timeout);
                            console.log('‚úÖ Connected to Railway bridge');
                            this.connected = true;
                            this.reconnectAttempts = 0;
                            this.emit('bridge-connected', { url: this.serverUrl });
                            resolve();
                        };

                        this.ws.onmessage = (event) => {
                            try {
                                const message = JSON.parse(event.data);
                                this.handleMessage(message);
                            } catch (error) {
                                console.error('‚ùå Invalid message:', error);
                            }
                        };

                        this.ws.onclose = (event) => {
                            clearTimeout(timeout);
                            console.log(`üîå Railway bridge disconnected (${event.code})`);
                            this.connected = false;
                            this.antConnected = false;
                            this.emit('bridge-disconnected', { code: event.code });
                            
                            // Auto-reconnect for Railway
                            if (this.reconnectAttempts < this.maxReconnectAttempts && event.code !== 1000) {
                                this.reconnectAttempts++;
                                console.log(`üîÑ Reconnection attempt ${this.reconnectAttempts}`);
                                setTimeout(() => this.connect(), 5000);
                            }
                        };

                        this.ws.onerror = (error) => {
                            clearTimeout(timeout);
                            console.error('‚ùå Railway connection error:', error);
                            this.emit('bridge-error', { error });
                            reject(error);
                        };

                    } catch (error) {
                        reject(error);
                    }
                });
            }

            handleMessage(message) {
                switch (message.type) {
                    case 'status':
                        this.emit('status', message);
                        break;
                    case 'connecting':
                        this.emit('ant-connecting', message);
                        break;
                    case 'connected':
                        this.antConnected = true;
                        this.emit('ant-connected', message);
                        break;
                    case 'disconnected':
                        this.antConnected = false;
                        this.emit('ant-disconnected', message);
                        break;
                    case 'data':
                    case 'broadcast':
                        this.emit('ant-data', message);
                        this.processData(message);
                        break;
                    case 'event':
                        this.emit('ant-event', message);
                        break;
                    case 'error':
                        this.emit('error', message);
                        break;
                }
            }

            processData(data) {
                if (data.trainer) {
                    this.emit('trainer-data', {
                        power: data.trainer.power,
                        speed: data.trainer.speed_kmh,
                        deviceId: data.device_id,
                        channel: data.channel,
                        rate: data.rate
                    });
                }

                if (data.heart_rate) {
                    this.emit('heart-rate-data', {
                        heartRate: data.heart_rate.bpm,
                        deviceId: data.device_id,
                        channel: data.channel,
                        rate: data.rate
                    });
                }

                if (data.power) {
                    this.emit('power-data', {
                        power: data.power.watts,
                        cadence: data.power.cadence,
                        deviceId: data.device_id,
                        channel: data.channel,
                        rate: data.rate
                    });
                }
            }

            async connectANT(rate) {
                if (!this.connected) throw new Error('Bridge not connected');
                this.sendMessage({ type: 'connect', rate });
            }

            async disconnectANT() {
                if (!this.connected) throw new Error('Bridge not connected');
                this.sendMessage({ type: 'disconnect' });
            }

            sendMessage(message) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(message));
                }
            }

            disconnect() {
                if (this.ws) {
                    this.ws.close(1000);
                    this.ws = null;
                }
                this.connected = false;
                this.antConnected = false;
            }
        }

        // Global variables
        let bridge = null;
        let bridgeConnected = false;
        let antConnected = false;

        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logEl.textContent += logMessage + '\n';
            logEl.scrollTop = logEl.scrollHeight;
            console.log(logMessage);
        }

        function updateBridgeStatus(connected, text) {
            const indicator = document.querySelector('#bridge-status .status-indicator');
            const textEl = document.getElementById('bridge-text');
            
            indicator.className = `status-indicator status-${connected ? 'connected' : 'offline'}`;
            textEl.textContent = text;
            bridgeConnected = connected;
            updateButtons();
        }

        function updateANTStatus(connected, text) {
            const indicator = document.querySelector('#ant-status .status-indicator');
            const textEl = document.getElementById('ant-text');
            
            indicator.className = `status-indicator status-${connected ? 'connected' : 'offline'}`;
            textEl.textContent = text;
            antConnected = connected;
            updateButtons();
        }

        function updateButtons() {
            const connectBtn = document.getElementById('connect-btn');
            const antButtons = ['ant-50k-btn', 'ant-57k-btn', 'ant-115k-btn', 'ant-2m-btn', 'ant-3m-btn'];
            const disconnectBtn = document.getElementById('disconnect-btn');

            connectBtn.disabled = bridgeConnected;
            connectBtn.textContent = bridgeConnected ? '‚úÖ Railway Connected' : 'üöÇ Connect to Railway Bridge';

            antButtons.forEach(id => {
                document.getElementById(id).disabled = !bridgeConnected || antConnected;
            });

            disconnectBtn.disabled = !antConnected;
        }

        function updateDeviceCard(cardId, data, active = true) {
            const card = document.getElementById(cardId);
            if (active) {
                card.classList.add('active');
            }
            
            const dataEl = card.querySelector('div');
            dataEl.innerHTML = data;
        }

        async function connectToRailway() {
            try {
                log('üöÇ Connecting to Railway bridge server...');
                updateBridgeStatus(false, 'Connecting...');

                bridge = new RailwayANTBridgeClient();

                // Update URL display
                const urlDisplay = document.getElementById('bridge-url');
                urlDisplay.textContent = `WebSocket URL: ${bridge.serverUrl}`;

                // Set up event listeners
                bridge.on('bridge-connected', (data) => {
                    log(`‚úÖ Connected to Railway bridge: ${data.url}`);
                    updateBridgeStatus(true, 'Connected to Railway');
                });

                bridge.on('bridge-disconnected', () => {
                    log('üîå Railway bridge disconnected');
                    updateBridgeStatus(false, 'Disconnected');
                    updateANTStatus(false, 'Disconnected');
                });

                bridge.on('ant-connecting', (data) => {
                    log(`üîå ${data.message}`);
                    updateANTStatus(false, 'Connecting...');
                });

                bridge.on('ant-connected', (data) => {
                    log(`‚úÖ ANT+ connected: ${data.message}`);
                    updateANTStatus(true, `Connected @ ${data.rate} Hz`);
                });

                bridge.on('ant-disconnected', (data) => {
                    log(`üîå ANT+ disconnected: ${data.message}`);
                    updateANTStatus(false, 'Disconnected');
                    
                    // Clear device cards
                    updateDeviceCard('trainer-card', 'No data', false);
                    updateDeviceCard('hr-card', 'No data', false);
                    updateDeviceCard('power-card', 'No data', false);
                });

                bridge.on('trainer-data', (data) => {
                    log(`üö¥ Trainer: ${data.power}W, ${data.speed.toFixed(1)}km/h`);
                    updateDeviceCard('trainer-card', `
                        <strong>Power:</strong> ${data.power} watts<br>
                        <strong>Speed:</strong> ${data.speed.toFixed(1)} km/h<br>
                        <strong>Device ID:</strong> ${data.deviceId}<br>
                        <strong>Rate:</strong> ${data.rate} Hz
                    `);
                });

                bridge.on('heart-rate-data', (data) => {
                    log(`‚ù§Ô∏è Heart Rate: ${data.heartRate} BPM`);
                    updateDeviceCard('hr-card', `
                        <strong>Heart Rate:</strong> ${data.heartRate} BPM<br>
                        <strong>Device ID:</strong> ${data.deviceId}<br>
                        <strong>Rate:</strong> ${data.rate} Hz
                    `);
                });

                bridge.on('power-data', (data) => {
                    log(`‚ö° Power: ${data.power}W, Cadence: ${data.cadence} RPM`);
                    updateDeviceCard('power-card', `
                        <strong>Power:</strong> ${data.power} watts<br>
                        <strong>Cadence:</strong> ${data.cadence} RPM<br>
                        <strong>Device ID:</strong> ${data.deviceId}<br>
                        <strong>Rate:</strong> ${data.rate} Hz
                    `);
                });

                bridge.on('error', (error) => {
                    log(`‚ùå Error: ${error.message || error.error}`);
                });

                // Connect to Railway bridge
                await bridge.connect();

            } catch (error) {
                log(`‚ùå Failed to connect to Railway: ${error.message}`);
                updateBridgeStatus(false, 'Connection failed');
                
                if (error.message.includes('timeout')) {
                    log('üí° Railway server may be starting up (cold start)');
                    log('üîÑ This can take 30-60 seconds for first connection');
                    log('‚è±Ô∏è Please wait and try again...');
                }
            }
        }

        async function connectANT(rate) {
            if (!bridge || !bridgeConnected) {
                log('‚ùå Railway bridge not connected');
                return;
            }

            try {
                log(`üîå Connecting to ANT+ device at ${rate} Hz via Railway...`);
                await bridge.connectANT(rate);
            } catch (error) {
                log(`‚ùå Failed to connect ANT+: ${error.message}`);
            }
        }

        async function disconnectANT() {
            if (!bridge || !antConnected) {
                log('‚ùå ANT+ device not connected');
                return;
            }

            try {
                log('üîå Disconnecting ANT+ device...');
                await bridge.disconnectANT();
            } catch (error) {
                log(`‚ùå Failed to disconnect ANT+: ${error.message}`);
            }
        }

        function clearLog() {
            document.getElementById('log').textContent = 'Log cleared.\nANT+ Railway Bridge ready...\n';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const railwayBridge = new RailwayANTBridgeClient();
            const urlDisplay = document.getElementById('bridge-url');
            urlDisplay.textContent = `WebSocket URL: ${railwayBridge.serverUrl}`;
            
            updateButtons();
            log('üöÇ ANT+ Railway Bridge Ready');
            log(`üåê Detected Railway URL: ${railwayBridge.serverUrl}`);
            log('üí° This bridge runs in the cloud with global access');
            log('üîí Secure WebSocket connections via Railway platform');
        });

        // Make functions available globally
        window.connectToRailway = connectToRailway;
        window.connectANT = connectANT;
        window.disconnectANT = disconnectANT;
        window.clearLog = clearLog;
    </script>
</body>
</html>
