<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANTicP - Smart Trainer Control Platform</title>
    <style>
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
            --zwift-orange: #fc5200;
            --zwift-blue: #0074d9;
            
            /* Zone colors */
            --zone1-color: #4CAF50;  /* Green - Recovery */
            --zone2-color: #8BC34A;  /* Light Green - Endurance */
            --zone3-color: #FFEB3B;  /* Yellow - Tempo */
            --zone4-color: #FFC107;  /* Amber - Threshold */
            --zone5-color: #FF9800;  /* Orange - VO2 Max */
            --zone6-color: #FF5722;  /* Deep Orange - Anaerobic */
            --zone7-color: #F44336;  /* Red - Neuromuscular */
            --zone8-color: #9C27B0;  /* Purple - Sprint */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--zwift-orange), var(--zwift-blue));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        /* Zone Display */
        .zone-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .zone-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        .zone-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            opacity: 0.3;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .zone-indicator.active {
            opacity: 1;
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        .zone-indicator:nth-child(1) { background: var(--zone1-color); }
        .zone-indicator:nth-child(2) { background: var(--zone2-color); }
        .zone-indicator:nth-child(3) { background: var(--zone3-color); }
        .zone-indicator:nth-child(4) { background: var(--zone4-color); }
        .zone-indicator:nth-child(5) { background: var(--zone5-color); }
        .zone-indicator:nth-child(6) { background: var(--zone6-color); }
        .zone-indicator:nth-child(7) { background: var(--zone7-color); }
        .zone-indicator:nth-child(8) { background: var(--zone8-color); }

        .zone-info {
            text-align: center;
            margin: 20px 0;
        }

        .zone-name {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .zone-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .zone-metric {
            text-align: center;
        }

        .zone-metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .zone-metric-label {
            font-size: 0.9rem;
            color: #666;
        }

        .controls-info {
            background: rgba(252, 82, 0, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
        }

        #controls-description {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
        }

        .controls-subtitle {
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
        }

        /* Interval Training Panel */
        .interval-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .interval-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .interval-toggle {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--success-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        .interval-display {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .current-interval {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .interval-progress {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .interval-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), var(--warning-color));
            transition: width 1s linear;
        }

        .interval-timer {
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
        }

        .lap-counter {
            background: var(--info-color);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }

        /* Sensor Pairing Panel */
        .sensor-pairing-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .sensor-card {
            background: var(--zwift-blue);
            color: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .sensor-card.connected {
            background: var(--success-color);
        }

        .sensor-card.connecting {
            background: var(--warning-color);
            animation: pulse 1.5s infinite;
        }

        /* Metrics Panel */
        .metrics-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .metric-item {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.05);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 0.9rem;
            color: #666;
        }

        /* Controls */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Activity Log */
        .log-panel {
            background: #1a1a1a;
            color: #00ff00;
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { background: var(--success-color); }
        .notification.error { background: var(--danger-color); }
        .notification.info { background: var(--info-color); }
        .notification.warning { background: var(--warning-color); }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🚴 ANTicP - Smart Trainer Control</h1>
            <p>Zone-based training with Wahoo KICKR Core & Zwift Click</p>
        </div>

        <!-- Zone Control Panel -->
        <div class="zone-panel">
            <h2 style="text-align: center; margin-bottom: 20px;">🎯 Training Zones</h2>
            
            <div class="zone-display">
                <div class="zone-indicator active" data-zone="1">Z1</div>
                <div class="zone-indicator" data-zone="2">Z2</div>
                <div class="zone-indicator" data-zone="3">Z3</div>
                <div class="zone-indicator" data-zone="4">Z4</div>
                <div class="zone-indicator" data-zone="5">Z5</div>
                <div class="zone-indicator" data-zone="6">Z6</div>
                <div class="zone-indicator" data-zone="7">Z7</div>
                <div class="zone-indicator" data-zone="8">Z8</div>
            </div>
            
            <div class="zone-info">
                <div class="zone-name" id="zone-name">Zone 1 - Recovery</div>
                <div class="zone-details">
                    <div class="zone-metric">
                        <div class="zone-metric-value" id="zone-resistance">0%</div>
                        <div class="zone-metric-label">Resistance</div>
                    </div>
                    <div class="zone-metric">
                        <div class="zone-metric-value" id="zone-power">50-60%</div>
                        <div class="zone-metric-label">FTP</div>
                    </div>
                    <div class="zone-metric">
                        <div class="zone-metric-value" id="zone-cadence">80+</div>
                        <div class="zone-metric-label">Target Cadence</div>
                    </div>
                </div>
            </div>
            
            <div class="controls-info">
                <div id="controls-description">
                    <strong>MANUAL MODE:</strong> UP = Next Zone | DOWN = Trigger Lap
                </div>
                <div class="controls-subtitle">
                    Toggle to AUTO mode for resistance adjustment (±5% with buttons)
                </div>
            </div>
        </div>

        <!-- Interval Training Panel -->
        <div class="interval-panel">
            <div class="interval-header">
                <h2>⏱️ Interval Training</h2>
                <div class="interval-toggle">
                    <span>Manual</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="auto-interval-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <span>Auto</span>
                    <input type="file" id="interval-file" accept=".json,.seconds" style="margin-left: 20px;">
                </div>
            </div>
            
            <div class="interval-display">
                <div class="current-interval" id="current-interval">No interval loaded</div>
                <div class="interval-progress">
                    <div class="interval-progress-bar" id="interval-progress" style="width: 0%"></div>
                </div>
                <div class="interval-timer">
                    <span id="interval-elapsed">0:00</span>
                    <span id="interval-remaining">0:00</span>
                </div>
            </div>
            
            <div class="lap-counter">
                Lap: <span id="lap-count">0</span> | 
                Set: <span id="set-count">0</span> / <span id="total-sets">0</span>
            </div>
        </div>

        <!-- Sensor Connections -->
        <div class="sensor-pairing-panel">
            <h2 style="text-align: center; margin-bottom: 20px;">📡 Sensors</h2>
            <div class="sensor-grid">
                <div class="sensor-card" id="trainer-card">
                    <div>🚴 KICKR Core</div>
                    <button class="btn btn-primary" id="connect-trainer" style="margin-top: 10px;">Connect</button>
                </div>
                <div class="sensor-card" id="zwiftclick-card">
                    <div>🎮 Zwift Click</div>
                    <button class="btn btn-primary" id="connect-zwiftclick" style="margin-top: 10px;">Connect</button>
                </div>
                <div class="sensor-card" id="hr-card">
                    <div>❤️ Heart Rate</div>
                    <button class="btn btn-primary" id="connect-hr" style="margin-top: 10px;">Connect</button>
                </div>
            </div>
        </div>

        <!-- Live Metrics -->
        <div class="metrics-panel">
            <h2 style="text-align: center; margin-bottom: 20px;">📊 Live Metrics</h2>
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-value" id="power-value">--</div>
                    <div class="metric-label">Power (W)</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="speed-value">--</div>
                    <div class="metric-label">Speed (km/h)</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="cadence-value">--</div>
                    <div class="metric-label">Cadence (RPM)</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="hr-value">--</div>
                    <div class="metric-label">Heart Rate</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="resistance-value">0</div>
                    <div class="metric-label">Resistance (%)</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="duration-value">00:00</div>
                    <div class="metric-label">Duration</div>
                </div>
            </div>
        </div>

        <!-- Session Controls -->
        <div style="text-align: center; margin: 20px 0;">
            <button class="btn btn-success" id="start-session">▶️ Start Session</button>
            <button class="btn btn-warning" id="pause-session" disabled>⏸️ Pause</button>
            <button class="btn btn-danger" id="stop-session" disabled>⏹️ Stop</button>
            <button class="btn btn-primary" id="export-session" disabled>📥 Export</button>
        </div>

        <!-- Activity Log -->
        <div class="metrics-panel">
            <h3 style="margin-bottom: 10px;">📝 Activity Log</h3>
            <div id="activity-log" class="log-panel"></div>
        </div>
    </div>

    <!-- Notification placeholder -->
    <div id="app-notification" class="notification"></div>

    <script>
        // ============================================================================
        // SIMPLE FIT FILE WRITER FOR STRAVA EXPORT
        // ============================================================================
        
        class SimpleFITWriter {
            constructor() {
                this.buffer = [];
                this.timestamp_offset = 631065600; // Seconds between Unix epoch and FIT epoch (Dec 31, 1989)
            }
            
            // Convert JavaScript Date to FIT timestamp
            dateToFIT(date) {
                return Math.floor(date.getTime() / 1000) - this.timestamp_offset;
            }
            
            // Write bytes to buffer
            writeBytes(bytes) {
                for (let byte of bytes) {
                    this.buffer.push(byte & 0xFF);
                }
            }
            
            // Write a single byte
            writeByte(value) {
                this.buffer.push(value & 0xFF);
            }
            
            // Write 16-bit value (little endian)
            writeShort(value) {
                this.writeByte(value & 0xFF);
                this.writeByte((value >> 8) & 0xFF);
            }
            
            // Write 32-bit value (little endian)
            writeInt(value) {
                this.writeByte(value & 0xFF);
                this.writeByte((value >> 8) & 0xFF);
                this.writeByte((value >> 16) & 0xFF);
                this.writeByte((value >> 24) & 0xFF);
            }
            
            // Create FIT file for indoor cycling session
            createIndoorCyclingFIT(sessionData, startTime) {
                // FIT File Header (14 bytes)
                this.writeByte(14);           // Header size
                this.writeByte(0x20);          // Protocol version
                this.writeShort(2140);         // Profile version
                this.writeInt(0);              // Data size (placeholder, will update)
                this.writeBytes([46, 70, 73, 84]); // ".FIT" in ASCII
                this.writeShort(0);            // Header CRC (placeholder)
                
                const dataStartIndex = this.buffer.length;
                
                // File ID Message (defines the file type)
                this.writeByte(0x40);          // Definition message header
                this.writeByte(0);             // Reserved
                this.writeByte(0);             // Architecture (little endian)
                this.writeShort(0);            // Global message number (file_id)
                this.writeByte(5);             // Number of fields
                
                // Field definitions for file_id
                this.writeByte(3); this.writeByte(4); this.writeByte(140); // serial_number
                this.writeByte(4); this.writeByte(4); this.writeByte(134); // time_created  
                this.writeByte(1); this.writeByte(2); this.writeByte(132); // manufacturer
                this.writeByte(2); this.writeByte(2); this.writeByte(132); // product
                this.writeByte(0); this.writeByte(1); this.writeByte(0);   // type
                
                // File ID Data
                this.writeByte(0x00);          // Data message header
                this.writeInt(0x12345678);     // Serial number
                this.writeInt(this.dateToFIT(new Date(startTime))); // Time created
                this.writeShort(1);            // Manufacturer (Garmin)
                this.writeShort(2080);         // Product
                this.writeByte(4);             // Type (activity)
                
                // Session Message Definition
                this.writeByte(0x41);          // Definition message header
                this.writeByte(0);             // Reserved
                this.writeByte(0);             // Architecture
                this.writeShort(18);           // Global message number (session)
                this.writeByte(17);            // Number of fields
                
                // Session field definitions
                this.writeByte(253); this.writeByte(4); this.writeByte(134); // timestamp
                this.writeByte(2); this.writeByte(4); this.writeByte(134);   // start_time
                this.writeByte(7); this.writeByte(4); this.writeByte(134);   // total_elapsed_time
                this.writeByte(9); this.writeByte(4); this.writeByte(134);   // total_distance
                this.writeByte(11); this.writeByte(2); this.writeByte(132);  // total_calories
                this.writeByte(13); this.writeByte(2); this.writeByte(132);  // avg_speed
                this.writeByte(14); this.writeByte(2); this.writeByte(132);  // max_speed
                this.writeByte(16); this.writeByte(1); this.writeByte(2);    // avg_heart_rate
                this.writeByte(17); this.writeByte(1); this.writeByte(2);    // max_heart_rate
                this.writeByte(18); this.writeByte(1); this.writeByte(2);    // avg_cadence
                this.writeByte(19); this.writeByte(1); this.writeByte(2);    // max_cadence
                this.writeByte(20); this.writeByte(2); this.writeByte(132);  // avg_power
                this.writeByte(21); this.writeByte(2); this.writeByte(132);  // max_power
                this.writeByte(5); this.writeByte(1); this.writeByte(0);     // sport
                this.writeByte(6); this.writeByte(1); this.writeByte(0);     // sub_sport
                this.writeByte(26); this.writeByte(2); this.writeByte(132);  // num_laps
                this.writeByte(48); this.writeByte(4); this.writeByte(134);  // total_work
                
                // Calculate session statistics
                const duration = sessionData.length;
                const totalDistance = sessionData.reduce((sum, d, i) => {
                    return sum + (i > 0 ? (d.speed || 0) / 3.6 : 0); // Convert km/h to m/s
                }, 0);
                
                const avgPower = Math.round(sessionData.reduce((sum, d) => sum + (d.power || 0), 0) / duration) || 0;
                const maxPower = Math.max(...sessionData.map(d => d.power || 0)) || 0;
                const avgCadence = Math.round(sessionData.reduce((sum, d) => sum + (d.cadence || 0), 0) / duration) || 0;
                const maxCadence = Math.max(...sessionData.map(d => d.cadence || 0)) || 0;
                const avgHR = Math.round(sessionData.reduce((sum, d) => sum + (d.heartRate || 0), 0) / duration) || 0;
                const maxHR = Math.max(...sessionData.map(d => d.heartRate || 0)) || 0;
                const avgSpeed = sessionData.reduce((sum, d) => sum + (d.speed || 0), 0) / duration || 0;
                const maxSpeed = Math.max(...sessionData.map(d => d.speed || 0)) || 0;
                const totalCalories = Math.round((avgPower * duration * 3.6) / 1000) || 0;
                const totalWork = avgPower * duration || 0; // joules
                
                // Session Data
                this.writeByte(0x01);          // Data message header
                this.writeInt(this.dateToFIT(new Date(startTime + duration * 1000)));
                this.writeInt(this.dateToFIT(new Date(startTime)));
                this.writeInt(duration * 1000); // ms
                this.writeInt(Math.round(totalDistance * 100)); // cm
                this.writeShort(totalCalories);
                this.writeShort(Math.round(avgSpeed * 1000 / 3.6)); // mm/s
                this.writeShort(Math.round(maxSpeed * 1000 / 3.6)); // mm/s
                this.writeByte(avgHR);
                this.writeByte(maxHR);
                this.writeByte(avgCadence);
                this.writeByte(maxCadence);
                this.writeShort(avgPower);
                this.writeShort(maxPower);
                this.writeByte(2);             // Sport: cycling
                this.writeByte(6);             // Sub-sport: indoor cycling
                this.writeShort(1);             // Number of laps
                this.writeInt(totalWork);      // Total work in joules
                
                // Record Messages (data points)
                // First, define the record message format
                this.writeByte(0x42);          // Definition message header
                this.writeByte(0);             // Reserved
                this.writeByte(0);             // Architecture
                this.writeShort(20);           // Global message number (record)
                this.writeByte(8);             // Number of fields
                
                // Record field definitions
                this.writeByte(253); this.writeByte(4); this.writeByte(134); // timestamp
                this.writeByte(5); this.writeByte(4); this.writeByte(134);   // distance
                this.writeByte(6); this.writeByte(2); this.writeByte(132);   // speed
                this.writeByte(3); this.writeByte(1); this.writeByte(2);     // heart_rate
                this.writeByte(4); this.writeByte(1); this.writeByte(2);     // cadence
                this.writeByte(7); this.writeByte(2); this.writeByte(132);   // power
                this.writeByte(2); this.writeByte(2); this.writeByte(131);   // altitude
                this.writeByte(9); this.writeByte(1); this.writeByte(1);     // grade
                
                // Write record data for each second
                let accumulatedDistance = 0;
                sessionData.forEach((point, index) => {
                    this.writeByte(0x02);      // Data message header for record
                    this.writeInt(this.dateToFIT(new Date(point.timestamp)));
                    
                    // Calculate distance
                    if (index > 0) {
                        accumulatedDistance += (point.speed || 0) / 3.6; // Add m/s
                    }
                    this.writeInt(Math.round(accumulatedDistance * 100)); // cm
                    
                    // Speed in mm/s
                    this.writeShort(Math.round((point.speed || 0) * 1000 / 3.6));
                    
                    // Heart rate, cadence, power
                    this.writeByte(point.heartRate || 0);
                    this.writeByte(point.cadence || 0);
                    this.writeShort(point.power || 0);
                    
                    // Altitude (fixed for indoor) and grade (resistance)
                    this.writeShort(1000); // 100m altitude (fixed)
                    this.writeByte(point.resistance || 0);
                });
                
                // Activity Message
                this.writeByte(0x43);          // Definition message header
                this.writeByte(0);             // Reserved
                this.writeByte(0);             // Architecture
                this.writeShort(34);           // Global message number (activity)
                this.writeByte(5);             // Number of fields
                
                // Activity field definitions
                this.writeByte(253); this.writeByte(4); this.writeByte(134); // timestamp
                this.writeByte(0); this.writeByte(4); this.writeByte(134);   // total_timer_time
                this.writeByte(1); this.writeByte(2); this.writeByte(132);   // num_sessions
                this.writeByte(2); this.writeByte(1); this.writeByte(0);     // type
                this.writeByte(3); this.writeByte(1); this.writeByte(0);     // event
                
                // Activity Data
                this.writeByte(0x03);          // Data message header
                this.writeInt(this.dateToFIT(new Date(startTime + duration * 1000)));
                this.writeInt(duration * 1000); // ms
                this.writeShort(1);            // One session
                this.writeByte(0);             // Type: manual
                this.writeByte(26);            // Event: activity
                
                // Update data size in header
                const dataSize = this.buffer.length - dataStartIndex;
                this.buffer[4] = dataSize & 0xFF;
                this.buffer[5] = (dataSize >> 8) & 0xFF;
                this.buffer[6] = (dataSize >> 16) & 0xFF;
                this.buffer[7] = (dataSize >> 24) & 0xFF;
                
                // Calculate and append CRC (simplified - just use 0)
                this.writeShort(0);
                
                return new Uint8Array(this.buffer);
            }
        }

        // ============================================================================
        // SMART TRAINER PLATFORM - COMPLETE FIXED VERSION
        // Fixed: Button detection, Mode-based behavior, Proper resistance values
        // ============================================================================

        class SmartTrainerPlatform {
            constructor() {
                // Training zones with ABSOLUTE resistance values
                this.zones = [
                    { id: 1, name: 'Recovery', resistance: 0, ftpRange: '50-60%', color: '#4CAF50', cadence: '80+' },
                    { id: 2, name: 'Endurance', resistance: 5, ftpRange: '60-70%', color: '#8BC34A', cadence: '80+' },
                    { id: 3, name: 'Tempo', resistance: 10, ftpRange: '70-80%', color: '#FFEB3B', cadence: '80+' },
                    { id: 4, name: 'Threshold', resistance: 15, ftpRange: '80-90%', color: '#FFC107', cadence: '80+' },
                    { id: 5, name: 'VO2 Max', resistance: 20, ftpRange: '90-105%', color: '#FF9800', cadence: '80+' },
                    { id: 6, name: 'Anaerobic', resistance: 25, ftpRange: '105-120%', color: '#FF5722', cadence: '80+' },
                    { id: 7, name: 'Neuromuscular', resistance: 30, ftpRange: '120-150%', color: '#F44336', cadence: '80+' },
                    { id: 8, name: 'Sprint', resistance: 35, ftpRange: '150%+', color: '#9C27B0', cadence: 'Max' }
                ];

                this.currentZone = 1;  // Always start at Zone 1
                this.lapCount = 0;
                this.setCount = 0;

                // Interval training
                this.intervalData = null;
                this.currentIntervalIndex = 0;
                this.intervalTimer = null;
                this.intervalStartTime = null;
                this.autoMode = false;

                // Connections
                this.connections = {
                    trainer: null,
                    zwiftClick: null,
                    heartRate: null
                };

                // Live metrics - Start with Zone 1 resistance
                this.metrics = {
                    power: 0,
                    speed: 0,
                    cadence: 0,
                    heartRate: 0,
                    resistance: 0  // Zone 1 = 0% resistance (easiest)
                };

                // Session
                this.session = {
                    active: false,
                    startTime: null,
                    data: []
                };

                // Zwift Click button state tracking - ENHANCED
                this.buttonState = {
                    pressed: false,
                    lastMessageTime: 0,
                    lastButtonPressed: null,
                    debugMode: true  // Enable for button debugging
                };

                this.initialize();
            }

            async initialize() {
                this.log('🚀 Initializing Smart Trainer Platform...');
                this.setupEventListeners();
                this.checkBrowserCompatibility();
                
                // Always start in Zone 1 for easy warm-up
                this.setZone(1);
                this.updateZoneDisplay();
                
                this.log('✅ Platform ready! Starting in Zone 1 (Recovery) - Easy warm-up');
                this.log('💡 MANUAL mode: UP=Zone, DOWN=Lap | AUTO mode: UP/DOWN=±5% resistance');
                this.showNotification('info', '🚴 Starting in Zone 1 - Easy pedaling (0% resistance)', 4000);
            }

            checkBrowserCompatibility() {
                if (!navigator.bluetooth) {
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                    const isAndroid = /Android/.test(navigator.userAgent);
                    
                    if (isIOS) {
                        this.log('⚠️ iOS detected - Use Bluefy browser or native app');
                        this.showNotification('warning', 'iOS: Please use Bluefy browser for Bluetooth', 10000);
                    } else if (isAndroid) {
                        this.log('⚠️ Android - Please use Chrome browser');
                        this.showNotification('warning', 'Please use Chrome browser for Bluetooth', 10000);
                    } else {
                        this.log('⚠️ Web Bluetooth not supported');
                        this.showNotification('error', 'Please use Chrome or Edge browser', 10000);
                    }
                    return false;
                }
                return true;
            }

            setupEventListeners() {
                // Sensor connections
                document.getElementById('connect-trainer')?.addEventListener('click', () => this.connectTrainer());
                document.getElementById('connect-zwiftclick')?.addEventListener('click', () => this.connectZwiftClick());
                document.getElementById('connect-hr')?.addEventListener('click', () => this.connectHeartRate());

                // Zone selection
                document.querySelectorAll('.zone-indicator').forEach(zone => {
                    zone.addEventListener('click', (e) => {
                        this.setZone(parseInt(e.target.dataset.zone));
                    });
                });

                // Interval controls with enhanced mode change notification
                document.getElementById('auto-interval-toggle')?.addEventListener('change', (e) => {
                    this.autoMode = e.target.checked;
                    
                    if (this.autoMode) {
                        this.log('🤖 AUTO MODE ACTIVATED: Buttons now adjust resistance ±5%');
                        this.showNotification('warning', '🤖 AUTO MODE: UP/DOWN = ±5% Resistance', 3000);
                        document.getElementById('controls-description').innerHTML = 
                            '<strong>AUTO MODE:</strong> UP = +5% Resistance | DOWN = -5% Resistance';
                    } else {
                        this.log('👤 MANUAL MODE ACTIVATED: UP cycles zones, DOWN triggers lap');
                        this.showNotification('info', '👤 MANUAL MODE: UP = Zone | DOWN = Lap', 3000);
                        document.getElementById('controls-description').innerHTML = 
                            '<strong>MANUAL MODE:</strong> UP = Next Zone | DOWN = Trigger Lap';
                    }
                });

                document.getElementById('interval-file')?.addEventListener('change', (e) => {
                    this.loadIntervalFile(e.target.files[0]);
                });

                // Session controls
                document.getElementById('start-session')?.addEventListener('click', () => this.startSession());
                document.getElementById('pause-session')?.addEventListener('click', () => this.pauseSession());
                document.getElementById('stop-session')?.addEventListener('click', () => this.stopSession());
                document.getElementById('export-session')?.addEventListener('click', () => this.exportSession());
            }

            // ============================================================================
            // ZONE MANAGEMENT
            // ============================================================================

            setZone(zoneId) {
                this.currentZone = zoneId;
                this.updateZoneDisplay();
                
                const zone = this.zones.find(z => z.id === zoneId);
                const targetResistance = zone.resistance;  // Direct resistance value
                
                this.setResistance(targetResistance);
                this.log(`🎯 Zone ${zoneId} - ${zone.name} (Resistance: ${targetResistance}%)`);
                this.showNotification('info', `Zone ${zoneId}: ${zone.name} (${targetResistance}% resistance)`, 2000);
            }

            cycleZone() {
                // Cycle through zones: 1→2→3→4→5→6→7→8→1
                this.currentZone = this.currentZone >= 8 ? 1 : this.currentZone + 1;
                this.setZone(this.currentZone);
            }

            updateZoneDisplay() {
                // Update zone indicators
                document.querySelectorAll('.zone-indicator').forEach(indicator => {
                    const zoneId = parseInt(indicator.dataset.zone);
                    if (zoneId === this.currentZone) {
                        indicator.classList.add('active');
                    } else {
                        indicator.classList.remove('active');
                    }
                });

                // Update zone info
                const zone = this.zones.find(z => z.id === this.currentZone);
                document.getElementById('zone-name').textContent = `Zone ${zone.id} - ${zone.name}`;
                document.getElementById('zone-resistance').textContent = `${zone.resistance}%`;
                document.getElementById('zone-power').textContent = zone.ftpRange;
                document.getElementById('zone-cadence').textContent = zone.cadence;
            }

            // ============================================================================
            // LAP MANAGEMENT
            // ============================================================================

            triggerLap() {
                this.lapCount++;
                document.getElementById('lap-count').textContent = this.lapCount;
                
                const timestamp = new Date().toLocaleTimeString();
                this.log(`🏁 LAP ${this.lapCount} triggered at ${timestamp}`);
                this.showNotification('success', `LAP ${this.lapCount}`, 2000);
                
                // If in auto mode and interval data loaded, move to next interval
                if (this.autoMode && this.intervalData) {
                    this.nextInterval();
                }
            }

            // ============================================================================
            // INTERVAL TRAINING
            // ============================================================================

            async loadIntervalFile(file) {
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    // Parse the interval data from the JSON structure
                    if (data.packs && data.packs[0] && data.packs[0].items[0]) {
                        const workout = data.packs[0].items[0];
                        this.intervalData = {
                            name: workout.name,
                            intervals: workout.intervals,
                            totalSets: workout.numberOfSets
                        };
                        
                        document.getElementById('total-sets').textContent = workout.numberOfSets;
                        this.log(`📋 Loaded workout: ${workout.name} (${workout.intervals.length} intervals)`);
                        this.showNotification('success', `Workout loaded: ${workout.name}`);
                        
                        // Display first interval
                        this.displayInterval(0);
                    }
                } catch (error) {
                    this.log(`❌ Failed to load interval file: ${error.message}`);
                    this.showNotification('error', 'Failed to load workout file');
                }
            }

            displayInterval(index) {
                if (!this.intervalData || index >= this.intervalData.intervals.length) return;
                
                const interval = this.intervalData.intervals[index];
                document.getElementById('current-interval').textContent = interval.name;
                
                // Map interval color to zone
                const colorToZone = {
                    0: 1, // Easy -> Zone 1 (0% resistance)
                    5: 2, // Endurance -> Zone 2 (5% resistance)
                    4: 3, // Tempo -> Zone 3 (10% resistance)
                    3: 4, // Threshold -> Zone 4 (15% resistance)
                    6: 5  // VO2 -> Zone 5 (20% resistance)
                };
                
                const targetZone = colorToZone[interval.color] || 2;
                if (this.autoMode) {
                    this.setZone(targetZone);
                }
                
                // Start interval timer
                this.startIntervalTimer(interval.duration);
            }

            startIntervalTimer(duration) {
                this.intervalStartTime = Date.now();
                const updateTimer = () => {
                    const elapsed = Math.floor((Date.now() - this.intervalStartTime) / 1000);
                    const remaining = Math.max(0, duration - elapsed);
                    const progress = (elapsed / duration) * 100;
                    
                    document.getElementById('interval-elapsed').textContent = this.formatTime(elapsed);
                    document.getElementById('interval-remaining').textContent = this.formatTime(remaining);
                    document.getElementById('interval-progress').style.width = `${progress}%`;
                    
                    if (remaining === 0 && this.autoMode) {
                        this.nextInterval();
                    }
                };
                
                if (this.intervalTimer) clearInterval(this.intervalTimer);
                this.intervalTimer = setInterval(updateTimer, 1000);
                updateTimer();
            }

            nextInterval() {
                this.currentIntervalIndex++;
                if (this.currentIntervalIndex >= this.intervalData.intervals.length) {
                    this.currentIntervalIndex = 0;
                    this.setCount++;
                    document.getElementById('set-count').textContent = this.setCount;
                }
                this.displayInterval(this.currentIntervalIndex);
            }

            // ============================================================================
            // ZWIFT CLICK CONNECTION - FIXED WITH PROPER BUTTON DETECTION
            // ============================================================================

            async connectZwiftClick() {
                try {
                    this.log('🎮 Connecting to Zwift Click...');
                    document.getElementById('zwiftclick-card').classList.add('connecting');
                    
                    const device = await navigator.bluetooth.requestDevice({
                        filters: [
                            { namePrefix: 'Zwift Click' },
                            { namePrefix: 'CLICK' }
                        ],
                        optionalServices: [
                            '00000001-19ca-4651-86e5-fa29dcdd09d1',
                            '0000180f-0000-1000-8000-00805f9b34fb'
                        ]
                    });

                    const server = await device.gatt.connect();
                    const service = await server.getPrimaryService('00000001-19ca-4651-86e5-fa29dcdd09d1');
                    
                    // Get characteristics
                    const measurementChar = await service.getCharacteristic('00000002-19ca-4651-86e5-fa29dcdd09d1');
                    const controlChar = await service.getCharacteristic('00000003-19ca-4651-86e5-fa29dcdd09d1');
                    const responseChar = await service.getCharacteristic('00000004-19ca-4651-86e5-fa29dcdd09d1');
                    
                    // Setup notifications
                    await measurementChar.startNotifications();
                    measurementChar.addEventListener('characteristicvaluechanged', (event) => {
                        this.handleZwiftClickData(event.target.value);
                    });
                    
                    await responseChar.startNotifications();
                    
                    // Send handshake
                    const handshake = new TextEncoder().encode('RideOn');
                    await controlChar.writeValueWithoutResponse(handshake);
                    
                    this.connections.zwiftClick = { device, server, service };
                    document.getElementById('zwiftclick-card').classList.remove('connecting');
                    document.getElementById('zwiftclick-card').classList.add('connected');
                    
                    this.log('✅ Zwift Click connected - Buttons ready!');
                    this.showNotification('success', 'Zwift Click connected!');
                    
                } catch (error) {
                    document.getElementById('zwiftclick-card').classList.remove('connecting');
                    this.log(`❌ Zwift Click connection failed: ${error.message}`);
                    this.showNotification('error', 'Zwift Click connection failed');
                }
            }

           handleZwiftClickData(dataValue) {
    const data = new Uint8Array(dataValue.buffer);
    
    // Debug logging if enabled
    if (this.buttonState.debugMode) {
        const hexString = Array.from(data).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
        console.log(`Zwift Click data: ${hexString}`);
    }
    
    // Check for the 0x37 message type (button state message)
    if (data.length >= 5 && data[0] === 0x37) {
        const currentTime = Date.now();
        
        // Extract button state information
        const stateByte = data[2];  // 0x00 = pressed, 0x01 = released
        const buttonId = data[4];   // 0x01 = UP, 0x00 = DOWN
        
        // Handle UP button on PRESS (normal behavior)
        if (stateByte === 0x00 && buttonId === 0x01) {
            // Debounce - prevent multiple triggers
            if (currentTime - this.buttonState.lastMessageTime < 200) return;
            this.buttonState.lastMessageTime = currentTime;
            
            this.handleUpButton();
            this.log('🎮 UP button pressed');
        }
        
        // SPECIAL HANDLING: DOWN button on RELEASE
        // Your Zwift Click DOWN button only sends RELEASE events
        // but no PRESS events, so we detect it on the first RELEASE
        if (stateByte === 0x01 && buttonId === 0x00) {
            // Initialize if needed
            if (!this.buttonState.lastDownReleaseTime) {
                this.buttonState.lastDownReleaseTime = 0;
            }
            
            // Check if this is a new button press (500ms gap)
            if (currentTime - this.buttonState.lastDownReleaseTime > 500) {
                // Trigger DOWN button action
                this.handleDownButton();
                this.log('🎮 DOWN button detected (via release)');
            }
            this.buttonState.lastDownReleaseTime = currentTime;
        }
    } else if (data.length === 3 && data[0] === 0x19) {
        // Keepalive message - ignore
        return;
    }
}

            handleUpButton() {
                // UP Button behavior depends on mode
                if (this.autoMode) {
                    // AUTO MODE: Increase resistance by 5%
                    const currentResistance = this.metrics.resistance;
                    const newResistance = Math.min(100, currentResistance + 5);
                    this.setResistance(newResistance);
                    this.log(`🎮 UP (Auto) → Resistance: ${newResistance}%`);
                    this.showNotification('info', `Resistance: ${newResistance}%`, 1500);
                } else {
                    // MANUAL MODE: Cycle to next zone
                    this.log('🎮 UP (Manual) → Next Zone');
                    this.cycleZone();
                }
            }

            handleDownButton() {
                // DOWN Button behavior depends on mode
                if (this.autoMode) {
                    // AUTO MODE: Decrease resistance by 5%
                    const currentResistance = this.metrics.resistance;
                    const newResistance = Math.max(0, currentResistance - 5);
                    this.setResistance(newResistance);
                    this.log(`🎮 DOWN (Auto) → Resistance: ${newResistance}%`);
                    this.showNotification('info', `Resistance: ${newResistance}%`, 1500);
                } else {
                    // MANUAL MODE: Trigger lap
                    this.log('🎮 DOWN (Manual) → LAP');
                    this.triggerLap();
                }
            }

            // ============================================================================
            // TRAINER CONNECTION
            // ============================================================================

            async connectTrainer() {
                try {
                    this.log('🚴 Connecting to KICKR Core...');
                    document.getElementById('trainer-card').classList.add('connecting');
                    
                    const device = await navigator.bluetooth.requestDevice({
                        filters: [
                            { namePrefix: 'KICKR' },
                            { namePrefix: 'Wahoo' }
                        ],
                        optionalServices: [
                            '00001826-0000-1000-8000-00805f9b34fb', // FTMS
                            '00001818-0000-1000-8000-00805f9b34fb'  // Cycling Power
                        ]
                    });

                    const server = await device.gatt.connect();
                    
                    // Get FTMS service
                    try {
                        const ftmsService = await server.getPrimaryService('00001826-0000-1000-8000-00805f9b34fb');
                        
                        // Indoor Bike Data
                        const bikeDataChar = await ftmsService.getCharacteristic('00002ad2-0000-1000-8000-00805f9b34fb');
                        await bikeDataChar.startNotifications();
                        bikeDataChar.addEventListener('characteristicvaluechanged', (event) => {
                            this.handleFTMSData(event.target.value);
                        });
                        
                        // Control Point
                        const controlChar = await ftmsService.getCharacteristic('00002ad9-0000-1000-8000-00805f9b34fb');
                        
                        this.connections.trainer = { device, server, ftmsService, controlChar };
                        
                        // Set initial resistance to Zone 1 (0%)
                        await this.setResistance(0);
                        
                    } catch (e) {
                        this.log(`⚠️ FTMS not available: ${e.message}`);
                    }
                    
                    document.getElementById('trainer-card').classList.remove('connecting');
                    document.getElementById('trainer-card').classList.add('connected');
                    
                    this.log('✅ KICKR Core connected');
                    this.showNotification('success', 'KICKR Core connected!');
                    
                } catch (error) {
                    document.getElementById('trainer-card').classList.remove('connecting');
                    this.log(`❌ Trainer connection failed: ${error.message}`);
                    this.showNotification('error', 'Trainer connection failed');
                }
            }

            handleFTMSData(dataValue) {
                const data = new Uint8Array(dataValue.buffer);
                if (data.length < 4) return;
                
                const flags = data[0] | (data[1] << 8);
                let index = 2;
                
                // Speed (always present)
                if (index + 1 < data.length) {
                    const speedRaw = data[index] | (data[index + 1] << 8);
                    this.metrics.speed = (speedRaw * 0.01).toFixed(1);
                    document.getElementById('speed-value').textContent = this.metrics.speed;
                    index += 2;
                }
                
                // Skip average speed if present
                if (flags & 0x0002) index += 2;
                
                // Cadence
                if (flags & 0x0004) {
                    if (index + 1 < data.length) {
                        const cadenceRaw = data[index] | (data[index + 1] << 8);
                        this.metrics.cadence = Math.round(cadenceRaw * 0.5);
                        document.getElementById('cadence-value').textContent = this.metrics.cadence;
                        index += 2;
                    }
                }
                
                // Skip to power if present
                if (flags & 0x0008) index += 2; // Average cadence
                if (flags & 0x0010) index += 3; // Distance
                if (flags & 0x0020) index += 1; // Resistance
                
                // Power
                if (flags & 0x0040) {
                    if (index + 1 < data.length) {
                        const powerRaw = data[index] | (data[index + 1] << 8);
                        this.metrics.power = powerRaw;
                        document.getElementById('power-value').textContent = powerRaw;
                    }
                }
            }

            // ============================================================================
            // HEART RATE CONNECTION
            // ============================================================================

            async connectHeartRate() {
                try {
                    this.log('❤️ Connecting to Heart Rate Monitor...');
                    document.getElementById('hr-card').classList.add('connecting');
                    
                    const device = await navigator.bluetooth.requestDevice({
                        filters: [{ services: ['0000180d-0000-1000-8000-00805f9b34fb'] }]
                    });

                    const server = await device.gatt.connect();
                    const service = await server.getPrimaryService('0000180d-0000-1000-8000-00805f9b34fb');
                    const characteristic = await service.getCharacteristic('00002a37-0000-1000-8000-00805f9b34fb');
                    
                    await characteristic.startNotifications();
                    characteristic.addEventListener('characteristicvaluechanged', (event) => {
                        const value = event.target.value;
                        const hr = value.getUint8(1);
                        this.metrics.heartRate = hr;
                        document.getElementById('hr-value').textContent = hr;
                    });

                    this.connections.heartRate = { device, server, service };
                    
                    document.getElementById('hr-card').classList.remove('connecting');
                    document.getElementById('hr-card').classList.add('connected');
                    
                    this.log('✅ Heart Rate Monitor connected');
                    this.showNotification('success', 'Heart Rate Monitor connected!');
                    
                } catch (error) {
                    document.getElementById('hr-card').classList.remove('connecting');
                    this.log(`❌ HR connection failed: ${error.message}`);
                    this.showNotification('error', 'HR connection failed');
                }
            }

            // ============================================================================
            // RESISTANCE CONTROL
            // ============================================================================

            async setResistance(value) {
                // Ensure value is within valid range (0-100%)
                value = Math.max(0, Math.min(100, value));
                
                this.metrics.resistance = value;
                document.getElementById('resistance-value').textContent = value;
                
                if (this.connections.trainer?.controlChar) {
                    try {
                        // FTMS Set Target Resistance command
                        const command = new Uint8Array([0x04, value]);
                        await this.connections.trainer.controlChar.writeValue(command);
                        this.log(`🎚️ Resistance set to ${value}%`);
                    } catch (error) {
                        this.log(`❌ Failed to set resistance: ${error.message}`);
                    }
                }
            }

            // ============================================================================
            // SESSION MANAGEMENT
            // ============================================================================

            startSession() {
                this.session.active = true;
                this.session.startTime = Date.now();
                this.session.data = [];
                this.lapCount = 0;
                this.setCount = 0;
                
                document.getElementById('start-session').disabled = true;
                document.getElementById('pause-session').disabled = false;
                document.getElementById('stop-session').disabled = false;
                
                // Start duration timer
                this.durationTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.session.startTime) / 1000);
                    document.getElementById('duration-value').textContent = this.formatTime(elapsed);
                }, 1000);
                
                // Start data collection
                this.dataCollector = setInterval(() => {
                    this.session.data.push({
                        timestamp: Date.now(),
                        zone: this.currentZone,
                        ...this.metrics
                    });
                }, 1000);
                
                this.log('🚀 Training session started');
                this.showNotification('success', 'Training started!');
            }

            pauseSession() {
                // Toggle pause state
                const btn = document.getElementById('pause-session');
                if (btn.textContent.includes('Pause')) {
                    clearInterval(this.durationTimer);
                    clearInterval(this.dataCollector);
                    btn.textContent = '▶️ Resume';
                    this.log('⏸️ Session paused');
                } else {
                    this.durationTimer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - this.session.startTime) / 1000);
                        document.getElementById('duration-value').textContent = this.formatTime(elapsed);
                    }, 1000);
                    this.dataCollector = setInterval(() => {
                        this.session.data.push({
                            timestamp: Date.now(),
                            zone: this.currentZone,
                            ...this.metrics
                        });
                    }, 1000);
                    btn.textContent = '⏸️ Pause';
                    this.log('▶️ Session resumed');
                }
            }

            stopSession() {
                this.session.active = false;
                clearInterval(this.durationTimer);
                clearInterval(this.dataCollector);
                clearInterval(this.intervalTimer);
                
                document.getElementById('start-session').disabled = false;
                document.getElementById('pause-session').disabled = true;
                document.getElementById('stop-session').disabled = true;
                document.getElementById('export-session').disabled = false;
                
                const duration = Math.floor((Date.now() - this.session.startTime) / 1000);
                this.log(`🏁 Session ended - Duration: ${this.formatTime(duration)}`);
                this.showNotification('success', `Session complete! Duration: ${this.formatTime(duration)}`);
            }

            exportSession() {
 if (this.session.data.length === 0) {
        this.showNotification('error', 'No data to export');
        return;
    }
    
    // Create export options dialog
    const exportDialog = document.createElement('div');
    exportDialog.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        z-index: 10000;
        text-align: center;
    `;
    
    exportDialog.innerHTML = `
        <h3 style="margin-bottom: 20px; color: #333;">Export Training Session</h3>
        <button id="export-fit-btn" style="
            padding: 15px 30px;
            margin: 10px;
            background: #fc4c02;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            display: block;
            width: 200px;
        ">
            🚴 Export for Strava (.FIT)
        </button>
        <button id="export-csv-btn" style="
            padding: 15px 30px;
            margin: 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            display: block;
            width: 200px;
        ">
            📊 Export as CSV
        </button>
        <button id="cancel-export-btn" style="
            padding: 10px 20px;
            margin: 10px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        ">
            Cancel
        </button>
    `;
    
    document.body.appendChild(exportDialog);
    
    // Handle FIT export
    document.getElementById('export-fit-btn').addEventListener('click', () => {
        try {
            const fitWriter = new SimpleFITWriter();
            const fitData = fitWriter.createIndoorCyclingFIT(this.session.data, this.session.startTime);
            
            const blob = new Blob([fitData], { type: 'application/vnd.ant.fit' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const date = new Date(this.session.startTime);
            const dateStr = date.toISOString().split('T')[0];
            const timeStr = date.toTimeString().split(' ')[0].replace(/:/g, '-');
            a.download = `Indoor_Cycling_${dateStr}_${timeStr}.fit`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            this.log('📥 Session exported as FIT file (Strava compatible)');
            this.showNotification('success', '🚴 FIT file ready for Strava upload!', 5000);
            
        } catch (error) {
            this.log(`❌ FIT export failed: ${error.message}`);
            this.showNotification('error', 'FIT export failed');
        }
        
        document.body.removeChild(exportDialog);
    });
    
    // Handle CSV export
    document.getElementById('export-csv-btn').addEventListener('click', () => {
        const csv = this.convertToCSV(this.session.data);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `training_${new Date().toISOString()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        this.log('📥 Session data exported as CSV');
        this.showNotification('success', '📊 CSV file exported successfully');
        
        document.body.removeChild(exportDialog);
    });
    
    // Handle cancel
    document.getElementById('cancel-export-btn').addEventListener('click', () => {
        document.body.removeChild(exportDialog);
    });
            }

            convertToCSV(data) {
                const headers = ['timestamp', 'zone', 'power', 'speed', 'cadence', 'heartRate', 'resistance'];
                const rows = data.map(row => headers.map(h => row[h] || 0).join(','));
                return [headers.join(','), ...rows].join('\n');
            }

            // ============================================================================
            // UTILITIES
            // ============================================================================

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logElement = document.getElementById('activity-log');
                if (logElement) {
                    const entry = document.createElement('div');
                    entry.textContent = `[${timestamp}] ${message}`;
                    logElement.appendChild(entry);
                    logElement.scrollTop = logElement.scrollHeight;
                    
                    // Keep only last 50 entries
                    while (logElement.children.length > 50) {
                        logElement.removeChild(logElement.firstChild);
                    }
                }
                console.log(`[${timestamp}] ${message}`);
            }

            showNotification(type, message, duration = 5000) {
                const notification = document.getElementById('app-notification');
                if (notification) {
                    notification.className = `notification ${type} show`;
                    notification.textContent = message;
                    
                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, duration);
                }
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.trainerApp = new SmartTrainerPlatform();
            console.log('🚴 Smart Trainer Platform initialized - Complete Fixed Version');
        });
    </script>
</body>
</html>