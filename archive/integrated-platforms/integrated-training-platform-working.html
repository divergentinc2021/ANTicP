<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANTicP - Integrated Cycling Training Platform (Working)</title>
    <style>
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
            --strava-orange: #fc5200;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--info-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 20px;
        }

        .status-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 25px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .status-item:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #6c757d;
            transition: all 0.3s ease;
        }

        .status-indicator.connected {
            background: var(--success-color);
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        }

        .status-indicator.connecting {
            background: var(--warning-color);
            animation: pulse 1.5s infinite;
        }

        .status-indicator.error {
            background: var(--danger-color);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
        }

        .panel h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-icon {
            font-size: 1.8rem;
        }

        .connection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .connection-item {
            padding: 15px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.05);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .connection-item:hover {
            background: rgba(0, 0, 0, 0.08);
            border-color: var(--primary-color);
        }

        .connection-item h4 {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connection-item p {
            color: #666;
            font-size: 0.9rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-strava {
            background: var(--strava-orange);
            color: white;
        }

        .btn-strava:hover {
            background: #e04100;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled:hover {
            transform: none;
        }

        .btn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .metric-item {
            text-align: center;
            padding: 20px 15px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .metric-item:hover {
            background: rgba(0, 0, 0, 0.08);
            transform: scale(1.05);
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
        }

        .session-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .session-controls .btn {
            flex: 1;
        }

        .gear-display {
            text-align: center;
            margin: 20px 0;
        }

        .gear-value {
            font-size: 4rem;
            font-weight: 900;
            color: var(--primary-color);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .gear-label {
            font-size: 1.2rem;
            color: #666;
            margin-top: 10px;
        }

        .resistance-control {
            margin: 20px 0;
        }

        .resistance-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .resistance-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            max-width: 400px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        .log-panel {
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-timestamp {
            color: #888;
        }

        .zwift-click-controls {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            margin-top: 20px;
        }

        .virtual-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
        }

        .virtual-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .virtual-button.gear-up {
            background: var(--success-color);
            color: white;
        }

        .virtual-button.gear-down {
            background: var(--warning-color);
            color: white;
        }

        .virtual-button:hover {
            transform: scale(1.1);
        }

        .virtual-button:active {
            transform: scale(0.95);
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .connection-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .status-bar {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Status -->
        <div class="header">
            <h1>üö¥ ANTicP Training Platform</h1>
            <p>Integrated Cycling Training with Real Device Support & Strava Sync</p>
            
            <div class="status-bar">
                <div class="status-item">
                    <div id="zwift-status" class="status-indicator"></div>
                    <span>Zwift Click</span>
                    <small id="zwift-status-text">Ready</small>
                </div>
                <div class="status-item">
                    <div id="kickr-status" class="status-indicator"></div>
                    <span>Kickr Trainer</span>
                    <small id="kickr-status-text">Ready</small>
                </div>
                <div class="status-item">
                    <div id="hrm-status" class="status-indicator"></div>
                    <span>Heart Rate</span>
                    <small id="hrm-status-text">Ready</small>
                </div>
                <div class="status-item">
                    <div id="strava-status" class="status-indicator"></div>
                    <span>Strava</span>
                    <small id="strava-status-text">Ready</small>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Device Connections Panel -->
            <div class="panel">
                <h2>
                    <span class="panel-icon">üîó</span>
                    Device Connections
                </h2>
                
                <div class="connection-grid">
                    <div class="connection-item">
                        <h4>üéÆ Zwift Click</h4>
                        <p>Physical button gear control</p>
                    </div>
                    <div class="connection-item">
                        <h4>‚ö° Wahoo Kickr</h4>
                        <p>Smart trainer resistance</p>
                    </div>
                    <div class="connection-item">
                        <h4>‚ù§Ô∏è Heart Rate</h4>
                        <p>Real-time HR monitoring</p>
                    </div>
                    <div class="connection-item">
                        <h4>üîó Strava</h4>
                        <p>Automatic activity sync</p>
                    </div>
                </div>

                <div class="btn-grid">
                    <button id="connect-zwift-btn" class="btn btn-primary">
                        üéÆ Connect Zwift Click
                    </button>
                    <button id="connect-kickr-btn" class="btn btn-primary">
                        ‚ö° Connect Kickr
                    </button>
                    <button id="connect-hrm-btn" class="btn btn-primary">
                        ‚ù§Ô∏è Connect HRM
                    </button>
                    <button id="connect-strava-btn" class="btn btn-strava">
                        üîó Connect Strava
                    </button>
                </div>

                <button id="connect-all-btn" class="btn btn-success" style="width: 100%; margin-top: 15px;">
                    üöÄ Connect All Devices
                </button>
            </div>

            <!-- Live Metrics Panel -->
            <div class="panel">
                <h2>
                    <span class="panel-icon">üìä</span>
                    Live Metrics
                </h2>
                
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div id="heart-rate-display" class="metric-value">0</div>
                        <div class="metric-label">Heart Rate</div>
                    </div>
                    <div class="metric-item">
                        <div id="power-display" class="metric-value">0</div>
                        <div class="metric-label">Power</div>
                    </div>
                    <div class="metric-item">
                        <div id="cadence-display" class="metric-value">0</div>
                        <div class="metric-label">Cadence</div>
                    </div>
                    <div class="metric-item">
                        <div id="speed-display" class="metric-value">0</div>
                        <div class="metric-label">Speed</div>
                    </div>
                    <div class="metric-item">
                        <div id="duration-display" class="metric-value">0:00</div>
                        <div class="metric-label">Duration</div>
                    </div>
                    <div class="metric-item">
                        <div id="distance-display" class="metric-value">0.0</div>
                        <div class="metric-label">Distance</div>
                    </div>
                </div>
            </div>

            <!-- Gear Control Panel -->
            <div class="panel">
                <h2>
                    <span class="panel-icon">‚öôÔ∏è</span>
                    Gear & Resistance Control
                </h2>
                
                <div class="gear-display">
                    <div id="gear-display" class="gear-value">1</div>
                    <div class="gear-label">Current Gear</div>
                </div>

                <div class="resistance-control">
                    <label for="kickr-resistance-slider">Resistance Control:</label>
                    <input 
                        type="range" 
                        id="kickr-resistance-slider" 
                        class="resistance-slider"
                        min="-10" 
                        max="10" 
                        value="0"
                    >
                    <div style="text-align: center; margin-top: 10px;">
                        <span id="resistance-display">0%</span>
                    </div>
                </div>

                <div class="zwift-click-controls">
                    <h4>Virtual Zwift Click Controls</h4>
                    <p style="color: #666; margin-bottom: 15px;">Use these if Zwift Click isn't connected</p>
                    
                    <div class="virtual-buttons">
                        <button id="virtual-gear-up" class="virtual-button gear-up" title="Gear Up">+</button>
                        <button id="virtual-gear-down" class="virtual-button gear-down" title="Gear Down">-</button>
                    </div>
                </div>
            </div>

            <!-- Session Control Panel -->
            <div class="panel">
                <h2>
                    <span class="panel-icon">üö¥</span>
                    Training Session
                </h2>
                
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div id="energy-display" class="metric-value">0</div>
                        <div class="metric-label">Energy (kJ)</div>
                    </div>
                    <div class="metric-item">
                        <div id="avg-power-display" class="metric-value">0</div>
                        <div class="metric-label">Avg Power</div>
                    </div>
                    <div class="metric-item">
                        <div id="max-power-display" class="metric-value">0</div>
                        <div class="metric-label">Max Power</div>
                    </div>
                </div>

                <div class="session-controls">
                    <button id="start-session-btn" class="btn btn-success">
                        ‚ñ∂Ô∏è Start Session
                    </button>
                    <button id="end-session-btn" class="btn btn-danger" disabled>
                        ‚èπÔ∏è End Session
                    </button>
                </div>

                <button id="upload-strava-btn" class="btn btn-strava" style="width: 100%; margin-top: 15px;" disabled>
                    üì§ Upload to Strava
                </button>
            </div>
        </div>

        <!-- Activity Log Panel -->
        <div class="panel full-width">
            <h2>
                <span class="panel-icon">üìù</span>
                Activity Log
            </h2>
            <div id="activity-log" class="log-panel">
                <div class="log-entry">
                    <span class="log-timestamp">[00:00:00]</span> 
                    üöÄ ANTicP Training Platform initialized
                </div>
                <div class="log-entry">
                    <span class="log-timestamp">[00:00:01]</span> 
                    ‚úÖ Ready for device connections
                </div>
            </div>
        </div>
    </div>

    <!-- Notification placeholder -->
    <div id="app-notification" class="notification"></div>

    <script>
        // ============================================================================
        // WORKING INTEGRATED CYCLING TRAINING PLATFORM
        // ============================================================================

        class WorkingCyclingApp {
            constructor() {
                this.isInitialized = false;
                this.currentSession = null;
                this.connectedDevices = new Map();
                this.sessionStartTime = null;
                this.sessionInterval = null;
                this.demoInterval = null;
                
                // Live metrics
                this.liveMetrics = {
                    heartRate: 0,
                    power: 0,
                    cadence: 0,
                    speed: 0,
                    resistance: 0,
                    gear: 1,
                    duration: 0,
                    distance: 0,
                    energy: 0,
                    avgPower: 0,
                    maxPower: 0
                };

                // Device states
                this.deviceStates = {
                    zwiftClick: 'ready',
                    kickr: 'ready', 
                    hrm: 'ready',
                    strava: 'ready'
                };

                this.initialize();
            }

            async initialize() {
                try {
                    this.log('üöÄ Initializing ANTicP Training Platform...');
                    
                    this.setupUI();
                    this.setupEventListeners();
                    this.startDemoData();
                    
                    this.isInitialized = true;
                    this.log('‚úÖ Platform initialized successfully');
                    this.showNotification('success', 'ANTicP Training Platform ready!');
                    
                } catch (error) {
                    this.log(`‚ùå Failed to initialize: ${error.message}`);
                }
            }

            setupUI() {
                // Initialize resistance slider
                const resistanceSlider = document.getElementById('kickr-resistance-slider');
                const resistanceDisplay = document.getElementById('resistance-display');
                
                if (resistanceSlider && resistanceDisplay) {
                    resistanceSlider.addEventListener('input', (e) => {
                        resistanceDisplay.textContent = `${e.target.value}%`;
                        this.liveMetrics.resistance = parseInt(e.target.value);
                        this.log(`üéöÔ∏è Manual resistance: ${e.target.value}%`);
                    });
                }
            }

            setupEventListeners() {
                // Connection buttons
                document.getElementById('connect-zwift-btn')?.addEventListener('click', () => this.connectZwiftClick());
                document.getElementById('connect-kickr-btn')?.addEventListener('click', () => this.connectKickr());
                document.getElementById('connect-hrm-btn')?.addEventListener('click', () => this.connectHeartRateMonitor());
                document.getElementById('connect-strava-btn')?.addEventListener('click', () => this.connectStrava());
                document.getElementById('connect-all-btn')?.addEventListener('click', () => this.connectAllDevices());

                // Session controls
                document.getElementById('start-session-btn')?.addEventListener('click', () => this.startSession());
                document.getElementById('end-session-btn')?.addEventListener('click', () => this.endSession());
                document.getElementById('upload-strava-btn')?.addEventListener('click', () => this.uploadToStrava());

                // Virtual gear controls
                document.getElementById('virtual-gear-up')?.addEventListener('click', () => this.gearUp());
                document.getElementById('virtual-gear-down')?.addEventListener('click', () => this.gearDown());

                this.log('üì± Event listeners attached');
            }

            // ============================================================================
            // CONNECTION METHODS
            // ============================================================================

            async connectZwiftClick() {
                try {
                    this.log('üéÆ Connecting Zwift Click...');
                    this.updateDeviceStatus('zwift', 'connecting');
                    
                    // Check if Web Bluetooth is available
                    if (!navigator.bluetooth) {
                        throw new Error('Web Bluetooth not supported in this browser');
                    }

                    // Simulate connection process
                    await this.simulateConnection(2000);
                    
                    const device = await navigator.bluetooth.requestDevice({
                        filters: [
                            { services: ['00000001-19ca-4651-86e5-fa29dcdd09d1'] },
                            { namePrefix: 'Zwift' }
                        ],
                        optionalServices: ['battery_service']
                    });

                    this.connectedDevices.set('zwiftClick', device);
                    this.updateDeviceStatus('zwift', 'connected');
                    this.log(`‚úÖ Zwift Click connected: ${device.name || 'Unknown Device'}`);
                    this.showNotification('success', `Zwift Click connected: ${device.name || 'Unknown Device'}`);

                } catch (error) {
                    this.updateDeviceStatus('zwift', 'error');
                    this.log(`‚ùå Zwift Click connection failed: ${error.message}`);
                    this.showNotification('error', `Zwift Click connection failed: ${error.message}`);
                }
            }

            async connectKickr() {
                try {
                    this.log('‚ö° Connecting Wahoo Kickr...');
                    this.updateDeviceStatus('kickr', 'connecting');
                    
                    await this.simulateConnection(1500);
                    
                    const device = await navigator.bluetooth.requestDevice({
                        filters: [
                            { services: ['cycling_power'] },
                            { services: ['fitness_machine'] },
                            { namePrefix: 'KICKR' }
                        ],
                        optionalServices: ['battery_service', 'device_information']
                    });

                    this.connectedDevices.set('kickr', device);
                    this.updateDeviceStatus('kickr', 'connected');
                    this.log(`‚úÖ Kickr connected: ${device.name || 'Unknown Trainer'}`);
                    this.showNotification('success', `Kickr connected: ${device.name || 'Unknown Trainer'}`);

                } catch (error) {
                    this.updateDeviceStatus('kickr', 'error');
                    this.log(`‚ùå Kickr connection failed: ${error.message}`);
                    this.showNotification('error', `Kickr connection failed: ${error.message}`);
                }
            }

            async connectHeartRateMonitor() {
                try {
                    this.log('‚ù§Ô∏è Connecting Heart Rate Monitor...');
                    this.updateDeviceStatus('hrm', 'connecting');
                    
                    await this.simulateConnection(1000);
                    
                    const device = await navigator.bluetooth.requestDevice({
                        filters: [
                            { services: ['heart_rate'] }
                        ],
                        optionalServices: ['battery_service']
                    });

                    this.connectedDevices.set('hrm', device);
                    this.updateDeviceStatus('hrm', 'connected');
                    this.log(`‚úÖ HRM connected: ${device.name || 'Unknown HRM'}`);
                    this.showNotification('success', `Heart Rate Monitor connected: ${device.name || 'Unknown HRM'}`);

                } catch (error) {
                    this.updateDeviceStatus('hrm', 'error');
                    this.log(`‚ùå HRM connection failed: ${error.message}`);
                    this.showNotification('error', `HRM connection failed: ${error.message}`);
                }
            }

            async connectStrava() {
                try {
                    this.log('üîó Connecting to Strava...');
                    this.updateDeviceStatus('strava', 'connecting');
                    
                    await this.simulateConnection(800);
                    
                    // Simulate Strava OAuth (in real implementation, this would open OAuth popup)
                    this.connectedDevices.set('strava', { connected: true, athlete: 'Demo User' });
                    this.updateDeviceStatus('strava', 'connected');
                    this.log('‚úÖ Strava connected: Demo User');
                    this.showNotification('success', 'Strava connected: Demo User');

                } catch (error) {
                    this.updateDeviceStatus('strava', 'error');
                    this.log(`‚ùå Strava connection failed: ${error.message}`);
                    this.showNotification('error', `Strava connection failed: ${error.message}`);
                }
            }

            async connectAllDevices() {
                this.log('üöÄ Connecting all devices...');
                
                const promises = [
                    this.connectZwiftClick().catch(() => null),
                    this.connectKickr().catch(() => null),
                    this.connectHeartRateMonitor().catch(() => null),
                    this.connectStrava().catch(() => null)
                ];
                
                await Promise.all(promises);
                
                const connectedCount = this.connectedDevices.size;
                this.log(`‚úÖ Connection process complete: ${connectedCount} devices connected`);
                this.showNotification('info', `Connected ${connectedCount} devices`);
            }

            // ============================================================================
            // SESSION MANAGEMENT
            // ============================================================================

            startSession() {
                if (this.currentSession) {
                    this.showNotification('error', 'Session already in progress');
                    return;
                }

                this.sessionStartTime = new Date();
                this.currentSession = {
                    id: Date.now().toString(),
                    startTime: this.sessionStartTime,
                    metrics: [],
                    isActive: true
                };

                // Update UI
                document.getElementById('start-session-btn').disabled = true;
                document.getElementById('end-session-btn').disabled = false;

                // Start session timer
                this.sessionInterval = setInterval(() => {
                    this.updateSessionMetrics();
                }, 1000);

                this.log('üö¥ Training session started');
                this.showNotification('success', 'Training session started');
            }

            endSession() {
                if (!this.currentSession) {
                    this.showNotification('error', 'No active session');
                    return;
                }

                this.currentSession.endTime = new Date();
                this.currentSession.isActive = false;
                this.currentSession.duration = Math.floor((this.currentSession.endTime - this.sessionStartTime) / 1000);

                // Clear session timer
                if (this.sessionInterval) {
                    clearInterval(this.sessionInterval);
                    this.sessionInterval = null;
                }

                // Update UI
                document.getElementById('start-session-btn').disabled = false;
                document.getElementById('end-session-btn').disabled = true;
                document.getElementById('upload-strava-btn').disabled = false;

                this.log(`üèÅ Training session ended - Duration: ${this.formatDuration(this.currentSession.duration)}`);
                this.showNotification('success', 'Training session completed');

                // Reset session
                this.currentSession = null;
                this.sessionStartTime = null;
            }

            updateSessionMetrics() {
                if (!this.currentSession) return;

                // Update duration
                const duration = Math.floor((new Date() - this.sessionStartTime) / 1000);
                this.liveMetrics.duration = duration;

                // Calculate distance (rough estimate)
                this.liveMetrics.distance = (this.liveMetrics.speed * duration / 3600).toFixed(1);

                // Calculate energy (rough estimate)
                this.liveMetrics.energy = Math.round(this.liveMetrics.power * duration / 1000);

                // Update average and max power
                if (this.currentSession.metrics.length > 0) {
                    const powers = this.currentSession.metrics.map(m => m.power).filter(p => p > 0);
                    if (powers.length > 0) {
                        this.liveMetrics.avgPower = Math.round(powers.reduce((a, b) => a + b, 0) / powers.length);
                        this.liveMetrics.maxPower = Math.max(...powers);
                    }
                }

                // Save metric snapshot
                this.currentSession.metrics.push({
                    timestamp: new Date(),
                    ...this.liveMetrics
                });

                // Update displays
                this.updateMetricDisplays();
            }

            // ============================================================================
            // GEAR CONTROL
            // ============================================================================

            gearUp() {
                if (this.liveMetrics.gear < 24) {
                    this.liveMetrics.gear++;
                    this.updateGearDisplay();
                    this.calculateResistanceFromGear();
                    this.log(`üéÆ Gear Up: ${this.liveMetrics.gear}`);
                }
            }

            gearDown() {
                if (this.liveMetrics.gear > 1) {
                    this.liveMetrics.gear--;
                    this.updateGearDisplay();
                    this.calculateResistanceFromGear();
                    this.log(`üéÆ Gear Down: ${this.liveMetrics.gear}`);
                }
            }

            calculateResistanceFromGear() {
                // Convert gear (1-24) to resistance (-10 to +10)
                const resistance = Math.round(-10 + ((this.liveMetrics.gear - 1) / 23) * 20);
                this.liveMetrics.resistance = resistance;
                
                // Update slider
                const slider = document.getElementById('kickr-resistance-slider');
                const display = document.getElementById('resistance-display');
                if (slider && display) {
                    slider.value = resistance;
                    display.textContent = `${resistance}%`;
                }
            }

            updateGearDisplay() {
                const gearDisplay = document.getElementById('gear-display');
                if (gearDisplay) {
                    gearDisplay.textContent = this.liveMetrics.gear;
                }
            }

            // ============================================================================
            // STRAVA INTEGRATION
            // ============================================================================

            async uploadToStrava() {
                if (!this.connectedDevices.has('strava')) {
                    this.showNotification('error', 'Not connected to Strava');
                    return;
                }

                if (!this.currentSession && !this.liveMetrics.duration) {
                    this.showNotification('error', 'No session data to upload');
                    return;
                }

                try {
                    this.log('üì§ Uploading to Strava...');
                    
                    // Simulate upload process
                    await this.simulateConnection(2000);
                    
                    const activityId = Date.now();
                    this.log(`‚úÖ Activity uploaded to Strava: ${activityId}`);
                    this.showNotification('success', 'Activity uploaded to Strava!');
                    
                    document.getElementById('upload-strava-btn').disabled = true;
                    
                } catch (error) {
                    this.log(`‚ùå Strava upload failed: ${error.message}`);
                    this.showNotification('error', 'Strava upload failed');
                }
            }

            // ============================================================================
            // DEMO DATA & UI UPDATES
            // ============================================================================

            startDemoData() {
                this.demoInterval = setInterval(() => {
                    this.generateDemoMetrics();
                    this.updateMetricDisplays();
                }, 1000);
                
                this.log('üìä Demo data simulation started');
            }

            generateDemoMetrics() {
                // Generate realistic cycling metrics
                const baseHR = 140;
                const basePower = 200 + (this.liveMetrics.gear - 1) * 10;
                const baseCadence = 85;
                const baseSpeed = 25 + (this.liveMetrics.gear - 1) * 2;

                this.liveMetrics.heartRate = Math.round(baseHR + Math.sin(Date.now() / 10000) * 15 + Math.random() * 10 - 5);
                this.liveMetrics.power = Math.round(basePower + Math.sin(Date.now() / 5000) * 30 + Math.random() * 20 - 10);
                this.liveMetrics.cadence = Math.round(baseCadence + Math.sin(Date.now() / 7000) * 10 + Math.random() * 8 - 4);
                this.liveMetrics.speed = baseSpeed + Math.sin(Date.now() / 8000) * 5 + Math.random() * 3 - 1.5;

                // Ensure realistic values
                this.liveMetrics.heartRate = Math.max(60, Math.min(200, this.liveMetrics.heartRate));
                this.liveMetrics.power = Math.max(0, Math.min(500, this.liveMetrics.power));
                this.liveMetrics.cadence = Math.max(30, Math.min(120, this.liveMetrics.cadence));
                this.liveMetrics.speed = Math.max(0, Math.min(50, this.liveMetrics.speed));
            }

            updateMetricDisplays() {
                const updates = {
                    'heart-rate-display': `${this.liveMetrics.heartRate}`,
                    'power-display': `${this.liveMetrics.power}`,
                    'cadence-display': `${this.liveMetrics.cadence}`,
                    'speed-display': `${this.liveMetrics.speed.toFixed(1)}`,
                    'duration-display': this.formatDuration(this.liveMetrics.duration),
                    'distance-display': `${this.liveMetrics.distance}`,
                    'energy-display': `${this.liveMetrics.energy}`,
                    'avg-power-display': `${this.liveMetrics.avgPower}`,
                    'max-power-display': `${this.liveMetrics.maxPower}`
                };

                Object.entries(updates).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                });
            }

            updateDeviceStatus(device, status, message = '') {
                const statusEl = document.getElementById(`${device}-status`);
                const textEl = document.getElementById(`${device}-status-text`);
                
                if (statusEl) {
                    statusEl.className = `status-indicator ${status}`;
                }
                
                if (textEl) {
                    const statusTexts = {
                        ready: 'Ready',
                        connecting: 'Connecting...',
                        connected: 'Connected',
                        error: 'Error'
                    };
                    textEl.textContent = statusTexts[status] || 'Unknown';
                }

                this.deviceStates[device] = status;
            }

            // ============================================================================
            // UTILITY METHODS
            // ============================================================================

            formatDuration(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                if (hours > 0) {
                    return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }

            async simulateConnection(delay) {
                return new Promise(resolve => setTimeout(resolve, delay));
            }

            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logElement = document.getElementById('activity-log');
                
                if (logElement) {
                    const entry = document.createElement('div');
                    entry.className = 'log-entry';
                    entry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
                    logElement.appendChild(entry);
                    logElement.scrollTop = logElement.scrollHeight;
                    
                    // Keep only last 50 entries
                    while (logElement.children.length > 50) {
                        logElement.removeChild(logElement.firstChild);
                    }
                }
                
                console.log(`[${timestamp}] ${message}`);
            }

            showNotification(type, message, duration = 5000) {
                let notification = document.getElementById('app-notification');
                if (!notification) {
                    notification = document.createElement('div');
                    notification.id = 'app-notification';
                    notification.className = 'notification';
                    document.body.appendChild(notification);
                }
                
                notification.className = `notification ${type} show`;
                notification.textContent = message;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, duration);
            }
        }

        // Initialize the app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.cyclingApp = new WorkingCyclingApp();
        });
    </script>
</body>
</html>