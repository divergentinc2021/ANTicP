<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIT File Converter Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .section h2 {
            color: #495057;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .upload-area.drag-over {
            border-color: #667eea;
            background: #e8eaff;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 5px;
            display: inline-block;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .button.secondary {
            background: #6c757d;
        }
        
        .button.success {
            background: #28a745;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            display: none;
        }
        
        .status.show {
            display: block;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .comparison-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        .comparison-table tr:hover {
            background: #f8f9fa;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .metric-card .label {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .metric-card .value {
            color: #333;
            font-size: 1.4em;
            font-weight: 600;
        }
        
        .file-info {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border: 1px solid #dee2e6;
        }
        
        .file-info p {
            margin: 5px 0;
            color: #495057;
        }
        
        .file-info strong {
            color: #333;
        }
        
        #logOutput {
            background: #2d3436;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .log-entry {
            margin: 2px 0;
        }
        
        .log-entry.error {
            color: #ff6b6b;
        }
        
        .log-entry.success {
            color: #51cf66;
        }
        
        .log-entry.info {
            color: #339af0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö¥ FIT File Converter Test</h1>
        <p class="subtitle">Test CSV to FIT conversion and compare with working examples</p>
        
        <!-- CSV Upload Section -->
        <div class="section">
            <h2>üìÅ Upload CSV Files</h2>
            <div class="upload-area" id="uploadArea">
                <p>üì§ Drag and drop CSV files here or click to browse</p>
                <p style="color: #6c757d; font-size: 0.9em;">Supports GOTOES_CSV format</p>
                <input type="file" id="fileInput" accept=".csv" multiple>
            </div>
            <div id="fileList" class="file-info" style="display: none;"></div>
        </div>
        
        <!-- Control Buttons -->
        <div class="section">
            <h2>üéÆ Controls</h2>
            <button class="button" id="analyzeBtn" disabled>üîç Analyze CSV</button>
            <button class="button" id="convertBtn" disabled>üîÑ Convert to FIT</button>
            <button class="button" id="compareBtn" disabled>üìä Compare Files</button>
            <button class="button success" id="downloadBtn" disabled>üíæ Download FIT</button>
            <button class="button secondary" id="clearBtn">üóëÔ∏è Clear All</button>
        </div>
        
        <!-- Status Messages -->
        <div id="statusMessage" class="status"></div>
        
        <!-- Analysis Results -->
        <div class="section" id="analysisSection" style="display: none;">
            <h2>üìä CSV Analysis</h2>
            <div id="analysisResults"></div>
        </div>
        
        <!-- Comparison Results -->
        <div class="section" id="comparisonSection" style="display: none;">
            <h2>üî¨ File Comparison</h2>
            <table class="comparison-table" id="comparisonTable">
                <thead>
                    <tr>
                        <th>Property</th>
                        <th>Working File 1</th>
                        <th>Working File 2</th>
                        <th>Generated FIT</th>
                        <th>Match</th>
                    </tr>
                </thead>
                <tbody id="comparisonBody"></tbody>
            </table>
        </div>
        
        <!-- Metrics Display -->
        <div class="section" id="metricsSection" style="display: none;">
            <h2>üìà Session Metrics</h2>
            <div class="metrics-grid" id="metricsGrid"></div>
        </div>
        
        <!-- Debug Log -->
        <div class="section" id="logSection">
            <h2>üñ•Ô∏è Debug Log</h2>
            <div id="logOutput"></div>
        </div>
    </div>
    
    <script type="module">
        import { FitFileConverter } from './js/utils/fit-file-converter.js';
        
        class FITConverterTest {
            constructor() {
                this.converter = new FitFileConverter();
                this.csvFiles = [];
                this.fitBuffer = null;
                this.sessionData = null;
                
                this.initializeUI();
                this.setupEventListeners();
                this.log('FIT Converter Test initialized', 'success');
            }
            
            initializeUI() {
                this.elements = {
                    uploadArea: document.getElementById('uploadArea'),
                    fileInput: document.getElementById('fileInput'),
                    fileList: document.getElementById('fileList'),
                    analyzeBtn: document.getElementById('analyzeBtn'),
                    convertBtn: document.getElementById('convertBtn'),
                    compareBtn: document.getElementById('compareBtn'),
                    downloadBtn: document.getElementById('downloadBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                    statusMessage: document.getElementById('statusMessage'),
                    analysisSection: document.getElementById('analysisSection'),
                    analysisResults: document.getElementById('analysisResults'),
                    comparisonSection: document.getElementById('comparisonSection'),
                    comparisonBody: document.getElementById('comparisonBody'),
                    metricsSection: document.getElementById('metricsSection'),
                    metricsGrid: document.getElementById('metricsGrid'),
                    logOutput: document.getElementById('logOutput')
                };
            }
            
            setupEventListeners() {
                // File upload
                this.elements.uploadArea.addEventListener('click', () => {
                    this.elements.fileInput.click();
                });
                
                this.elements.fileInput.addEventListener('change', (e) => {
                    this.handleFileSelection(e.target.files);
                });
                
                // Drag and drop
                this.elements.uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.elements.uploadArea.classList.add('drag-over');
                });
                
                this.elements.uploadArea.addEventListener('dragleave', () => {
                    this.elements.uploadArea.classList.remove('drag-over');
                });
                
                this.elements.uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.elements.uploadArea.classList.remove('drag-over');
                    this.handleFileSelection(e.dataTransfer.files);
                });
                
                // Buttons
                this.elements.analyzeBtn.addEventListener('click', () => this.analyzeCSV());
                this.elements.convertBtn.addEventListener('click', () => this.convertToFIT());
                this.elements.compareBtn.addEventListener('click', () => this.compareFiles());
                this.elements.downloadBtn.addEventListener('click', () => this.downloadFIT());
                this.elements.clearBtn.addEventListener('click', () => this.clearAll());
            }
            
            async handleFileSelection(files) {
                this.csvFiles = Array.from(files).filter(f => f.name.endsWith('.csv'));
                
                if (this.csvFiles.length === 0) {
                    this.showStatus('Please select CSV files', 'error');
                    return;
                }
                
                this.showStatus(`Loaded ${this.csvFiles.length} CSV file(s)`, 'success');
                this.displayFileList();
                
                // Enable buttons
                this.elements.analyzeBtn.disabled = false;
                this.elements.convertBtn.disabled = false;
                if (this.csvFiles.length >= 2) {
                    this.elements.compareBtn.disabled = false;
                }
                
                this.log(`Files loaded: ${this.csvFiles.map(f => f.name).join(', ')}`, 'info');
            }
            
            displayFileList() {
                const fileInfo = this.csvFiles.map(f => `
                    <p><strong>${f.name}</strong> - ${(f.size / 1024).toFixed(2)} KB</p>
                `).join('');
                
                this.elements.fileList.innerHTML = fileInfo;
                this.elements.fileList.style.display = 'block';
            }
            
            async analyzeCSV() {
                try {
                    this.log('Starting CSV analysis...', 'info');
                    const results = [];
                    
                    for (const file of this.csvFiles) {
                        const content = await this.readFile(file);
                        const analysis = this.analyzeCSVContent(content, file.name);
                        results.push(analysis);
                    }
                    
                    this.displayAnalysis(results);
                    this.showStatus('CSV analysis complete', 'success');
                    
                } catch (error) {
                    this.log(`Analysis error: ${error.message}`, 'error');
                    this.showStatus(`Analysis failed: ${error.message}`, 'error');
                }
            }
            
            analyzeCSVContent(content, filename) {
                const lines = content.trim().split('\n');
                const headers = lines[0].split(',');
                
                // Parse data rows
                const dataRows = [];
                let validRows = 0;
                let invalidRows = 0;
                
                for (let i = 1; i < Math.min(lines.length, 100); i++) {
                    const values = lines[i].split(',');
                    if (values.length === headers.length) {
                        dataRows.push(values);
                        validRows++;
                    } else {
                        invalidRows++;
                    }
                }
                
                // Find columns with data
                const columnsWithData = {};
                headers.forEach((header, index) => {
                    let hasData = false;
                    for (const row of dataRows) {
                        if (row[index] && row[index].trim() !== '') {
                            hasData = true;
                            break;
                        }
                    }
                    if (hasData) {
                        columnsWithData[header] = true;
                    }
                });
                
                // Extract key metrics
                const timestampIndex = headers.indexOf('timestamp');
                const powerIndex = headers.indexOf('power');
                const hrIndex = headers.indexOf('heart_rate');
                const cadenceIndex = headers.indexOf('cadence');
                const distanceIndex = headers.indexOf('distance');
                const speedIndex = headers.indexOf('speed');
                
                let metrics = {
                    avgPower: 0,
                    maxPower: 0,
                    avgHR: 0,
                    maxHR: 0,
                    avgCadence: 0,
                    maxCadence: 0,
                    totalDistance: 0,
                    avgSpeed: 0,
                    maxSpeed: 0
                };
                
                if (dataRows.length > 0) {
                    let powerSum = 0, hrSum = 0, cadenceSum = 0, speedSum = 0;
                    let powerCount = 0, hrCount = 0, cadenceCount = 0, speedCount = 0;
                    
                    dataRows.forEach(row => {
                        const power = parseFloat(row[powerIndex]);
                        const hr = parseFloat(row[hrIndex]);
                        const cadence = parseFloat(row[cadenceIndex]);
                        const speed = parseFloat(row[speedIndex]);
                        const distance = parseFloat(row[distanceIndex]);
                        
                        if (!isNaN(power) && power > 0) {
                            powerSum += power;
                            powerCount++;
                            metrics.maxPower = Math.max(metrics.maxPower, power);
                        }
                        
                        if (!isNaN(hr) && hr > 0) {
                            hrSum += hr;
                            hrCount++;
                            metrics.maxHR = Math.max(metrics.maxHR, hr);
                        }
                        
                        if (!isNaN(cadence) && cadence > 0) {
                            cadenceSum += cadence;
                            cadenceCount++;
                            metrics.maxCadence = Math.max(metrics.maxCadence, cadence);
                        }
                        
                        if (!isNaN(speed) && speed > 0) {
                            speedSum += speed;
                            speedCount++;
                            metrics.maxSpeed = Math.max(metrics.maxSpeed, speed);
                        }
                        
                        if (!isNaN(distance)) {
                            metrics.totalDistance = Math.max(metrics.totalDistance, distance);
                        }
                    });
                    
                    metrics.avgPower = powerCount > 0 ? Math.round(powerSum / powerCount) : 0;
                    metrics.avgHR = hrCount > 0 ? Math.round(hrSum / hrCount) : 0;
                    metrics.avgCadence = cadenceCount > 0 ? Math.round(cadenceSum / cadenceCount) : 0;
                    metrics.avgSpeed = speedCount > 0 ? (speedSum / speedCount).toFixed(2) : 0;
                }
                
                return {
                    filename,
                    totalRows: lines.length - 1,
                    validRows,
                    invalidRows,
                    headers: headers.length,
                    columnsWithData: Object.keys(columnsWithData).length,
                    metrics,
                    startTime: dataRows[0] ? dataRows[0][timestampIndex] : null,
                    endTime: dataRows[dataRows.length - 1] ? dataRows[dataRows.length - 1][timestampIndex] : null
                };
            }
            
            displayAnalysis(results) {
                let html = '';
                
                results.forEach(result => {
                    html += `
                        <div class="file-info">
                            <h3>${result.filename}</h3>
                            <p><strong>Total Rows:</strong> ${result.totalRows}</p>
                            <p><strong>Valid Rows:</strong> ${result.validRows}</p>
                            <p><strong>Headers:</strong> ${result.headers}</p>
                            <p><strong>Columns with Data:</strong> ${result.columnsWithData}</p>
                            <p><strong>Time Range:</strong> ${result.startTime} to ${result.endTime}</p>
                            
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="label">Avg Power</div>
                                    <div class="value">${result.metrics.avgPower}W</div>
                                </div>
                                <div class="metric-card">
                                    <div class="label">Max Power</div>
                                    <div class="value">${result.metrics.maxPower}W</div>
                                </div>
                                <div class="metric-card">
                                    <div class="label">Avg HR</div>
                                    <div class="value">${result.metrics.avgHR} bpm</div>
                                </div>
                                <div class="metric-card">
                                    <div class="label">Max HR</div>
                                    <div class="value">${result.metrics.maxHR} bpm</div>
                                </div>
                                <div class="metric-card">
                                    <div class="label">Avg Cadence</div>
                                    <div class="value">${result.metrics.avgCadence} rpm</div>
                                </div>
                                <div class="metric-card">
                                    <div class="label">Distance</div>
                                    <div class="value">${(result.metrics.totalDistance / 1000).toFixed(2)} km</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                this.elements.analysisResults.innerHTML = html;
                this.elements.analysisSection.style.display = 'block';
            }
            
            async convertToFIT() {
                try {
                    this.log('Starting FIT conversion...', 'info');
                    
                    // Use first CSV file for conversion
                    const csvFile = this.csvFiles[0];
                    const csvContent = await this.readFile(csvFile);
                    
                    // Convert CSV to FIT
                    this.fitBuffer = await this.converter.convertCSVToFIT(csvContent);
                    
                    this.log(`FIT file created: ${this.fitBuffer.length} bytes`, 'success');
                    this.showStatus('FIT file created successfully', 'success');
                    
                    // Enable download button
                    this.elements.downloadBtn.disabled = false;
                    
                    // Display FIT file info
                    this.displayFITInfo();
                    
                } catch (error) {
                    this.log(`Conversion error: ${error.message}`, 'error');
                    this.showStatus(`Conversion failed: ${error.message}`, 'error');
                }
            }
            
            displayFITInfo() {
                const info = this.analyzeFITBuffer(this.fitBuffer);
                
                let html = `
                    <h3>Generated FIT File</h3>
                    <p><strong>File Size:</strong> ${(this.fitBuffer.length / 1024).toFixed(2)} KB</p>
                    <p><strong>Header:</strong> ${info.header}</p>
                    <p><strong>Protocol Version:</strong> ${info.protocolVersion}</p>
                    <p><strong>Profile Version:</strong> ${info.profileVersion}</p>
                    <p><strong>Messages:</strong> ${info.messageCount} (estimated)</p>
                `;
                
                const metricsDiv = document.createElement('div');
                metricsDiv.innerHTML = html;
                this.elements.metricsGrid.innerHTML = '';
                this.elements.metricsGrid.appendChild(metricsDiv);
                this.elements.metricsSection.style.display = 'block';
            }
            
            analyzeFITBuffer(buffer) {
                // Basic FIT file analysis
                const header = String.fromCharCode(...buffer.slice(8, 12));
                const protocolVersion = buffer[1];
                const profileVersion = (buffer[3] << 8) | buffer[2];
                const dataSize = (buffer[7] << 24) | (buffer[6] << 16) | (buffer[5] << 8) | buffer[4];
                
                return {
                    header,
                    protocolVersion,
                    profileVersion,
                    dataSize,
                    messageCount: Math.floor(dataSize / 20) // Rough estimate
                };
            }
            
            async compareFiles() {
                try {
                    this.log('Comparing files...', 'info');
                    
                    // Analyze all CSV files
                    const analyses = [];
                    for (const file of this.csvFiles) {
                        const content = await this.readFile(file);
                        const analysis = this.analyzeCSVContent(content, file.name);
                        analyses.push(analysis);
                    }
                    
                    // Compare key metrics
                    const comparison = this.compareMetrics(analyses);
                    this.displayComparison(comparison);
                    
                    this.showStatus('Comparison complete', 'success');
                    
                } catch (error) {
                    this.log(`Comparison error: ${error.message}`, 'error');
                    this.showStatus(`Comparison failed: ${error.message}`, 'error');
                }
            }
            
            compareMetrics(analyses) {
                const metricKeys = ['avgPower', 'maxPower', 'avgHR', 'maxHR', 'avgCadence', 'maxCadence', 'totalDistance'];
                const comparison = [];
                
                metricKeys.forEach(key => {
                    const row = {
                        metric: this.formatMetricName(key),
                        values: analyses.map(a => a.metrics[key]),
                        match: false
                    };
                    
                    // Check if values are similar (within 5% tolerance)
                    if (row.values.length >= 2) {
                        const diff = Math.abs(row.values[0] - row.values[1]);
                        const avg = (row.values[0] + row.values[1]) / 2;
                        row.match = avg === 0 || (diff / avg) < 0.05;
                    }
                    
                    comparison.push(row);
                });
                
                return comparison;
            }
            
            formatMetricName(key) {
                const names = {
                    avgPower: 'Average Power (W)',
                    maxPower: 'Max Power (W)',
                    avgHR: 'Average Heart Rate (bpm)',
                    maxHR: 'Max Heart Rate (bpm)',
                    avgCadence: 'Average Cadence (rpm)',
                    maxCadence: 'Max Cadence (rpm)',
                    totalDistance: 'Total Distance (m)'
                };
                return names[key] || key;
            }
            
            displayComparison(comparison) {
                let html = '';
                
                comparison.forEach(row => {
                    const matchIcon = row.match ? '‚úÖ' : '‚ùå';
                    html += `
                        <tr>
                            <td>${row.metric}</td>
                            <td>${row.values[0] || '-'}</td>
                            <td>${row.values[1] || '-'}</td>
                            <td>${row.values[2] || '-'}</td>
                            <td>${matchIcon}</td>
                        </tr>
                    `;
                });
                
                this.elements.comparisonBody.innerHTML = html;
                this.elements.comparisonSection.style.display = 'block';
            }
            
            downloadFIT() {
                if (!this.fitBuffer) {
                    this.showStatus('No FIT file to download', 'error');
                    return;
                }
                
                const filename = `workout_${Date.now()}.fit`;
                this.converter.downloadFIT(this.fitBuffer, filename);
                this.log(`Downloaded FIT file: ${filename}`, 'success');
                this.showStatus(`Downloaded: ${filename}`, 'success');
            }
            
            clearAll() {
                this.csvFiles = [];
                this.fitBuffer = null;
                this.sessionData = null;
                
                // Reset UI
                this.elements.fileInput.value = '';
                this.elements.fileList.style.display = 'none';
                this.elements.analysisSection.style.display = 'none';
                this.elements.comparisonSection.style.display = 'none';
                this.elements.metricsSection.style.display = 'none';
                
                // Disable buttons
                this.elements.analyzeBtn.disabled = true;
                this.elements.convertBtn.disabled = true;
                this.elements.compareBtn.disabled = true;
                this.elements.downloadBtn.disabled = true;
                
                this.showStatus('Cleared all data', 'info');
                this.log('All data cleared', 'info');
            }
            
            async readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }
            
            showStatus(message, type) {
                this.elements.statusMessage.textContent = message;
                this.elements.statusMessage.className = `status show ${type}`;
                
                setTimeout(() => {
                    this.elements.statusMessage.classList.remove('show');
                }, 5000);
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.textContent = `[${timestamp}] ${message}`;
                this.elements.logOutput.appendChild(entry);
                this.elements.logOutput.scrollTop = this.elements.logOutput.scrollHeight;
            }
        }
        
        // Initialize the test app
        window.addEventListener('DOMContentLoaded', () => {
            window.fitTest = new FITConverterTest();
        });
    </script>
</body>
</html>
