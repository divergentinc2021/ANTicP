<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Debug - Test User Creation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover { background: #0056b3; }
        .console {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Admin Debug - User Creation Test</h1>
    
    <div id="authStatus" class="status info">Checking authentication...</div>
    
    <div style="margin: 20px 0;">
        <button onclick="checkAuth()">Check Auth Status</button>
        <button onclick="createTestMember()">Create Test Member</button>
        <button onclick="listAllUsers()">List All Users</button>
        <button onclick="checkIndexes()">Check Firestore Indexes</button>
        <button onclick="testQuery()">Test Query</button>
    </div>
    
    <div id="results"></div>
    
    <div class="console" id="console">
        <strong>Console Output:</strong><br>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script src="js/firebase-config.js"></script>
    
    <script>
        const { auth, db } = window.firebaseServices;
        
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            console.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }
        
        // Check authentication
        auth.onAuthStateChanged(async (user) => {
            const status = document.getElementById('authStatus');
            if (user) {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    const userData = userDoc.data();
                    status.className = 'status success';
                    status.innerHTML = `Logged in as: ${user.email}<br>Role: ${userData?.role || 'No role set'}`;
                    log(`Authenticated: ${user.email} (${userData?.role})`, 'success');
                } catch (error) {
                    status.className = 'status error';
                    status.innerHTML = `Auth error: ${error.message}`;
                    log(`Auth error: ${error.message}`, 'error');
                }
            } else {
                status.className = 'status info';
                status.innerHTML = 'Not logged in';
                log('Not authenticated', 'info');
            }
        });
        
        async function checkAuth() {
            log('Checking authentication...', 'info');
            const user = auth.currentUser;
            if (user) {
                log(`Current user: ${user.email} (UID: ${user.uid})`, 'success');
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    log(`User data: ${JSON.stringify(userDoc.data(), null, 2)}`, 'info');
                }
            } else {
                log('No user logged in', 'error');
            }
        }
        
        async function createTestMember() {
            log('Creating test member...', 'info');
            try {
                const testEmail = `testmember${Date.now()}@test.com`;
                const testData = {
                    firstName: 'Test',
                    lastName: 'Member',
                    username: `testmember${Date.now()}`,
                    email: testEmail,
                    ftp: 200,
                    maxHeartRate: 170,
                    role: 'member',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Create auth user
                log(`Creating auth user: ${testEmail}`, 'info');
                const userCredential = await auth.createUserWithEmailAndPassword(testEmail, 'TestPassword123!');
                log(`Auth user created: ${userCredential.user.uid}`, 'success');
                
                // Save to Firestore
                log('Saving to Firestore...', 'info');
                await db.collection('users').doc(userCredential.user.uid).set(testData);
                log('User saved to Firestore', 'success');
                
                // Create username mapping
                log('Creating username mapping...', 'info');
                await db.collection('usernames').doc(testData.username).set({
                    uid: userCredential.user.uid,
                    email: testEmail
                });
                log('Username mapping created', 'success');
                
                document.getElementById('results').innerHTML = 
                    `<div class="status success">Test member created successfully!<br>
                    Email: ${testEmail}<br>
                    UID: ${userCredential.user.uid}</div>`;
                    
            } catch (error) {
                log(`Error creating test member: ${error.message}`, 'error');
                document.getElementById('results').innerHTML = 
                    `<div class="status error">Error: ${error.message}</div>`;
            }
        }
        
        async function listAllUsers() {
            log('Fetching all users...', 'info');
            try {
                // Try without ordering first
                log('Attempting simple query without ordering...', 'info');
                const snapshot1 = await db.collection('users').get();
                log(`Found ${snapshot1.size} total users`, 'success');
                
                // Try with role filter
                log('Attempting query with role=member filter...', 'info');
                const snapshot2 = await db.collection('users').where('role', '==', 'member').get();
                log(`Found ${snapshot2.size} members`, 'success');
                
                // Try with ordering
                log('Attempting query with ordering by createdAt...', 'info');
                try {
                    const snapshot3 = await db.collection('users')
                        .where('role', '==', 'member')
                        .orderBy('createdAt', 'desc')
                        .get();
                    log(`Successfully queried with ordering: ${snapshot3.size} results`, 'success');
                } catch (orderError) {
                    log(`Ordering error: ${orderError.message}`, 'error');
                    if (orderError.message.includes('index')) {
                        log('Composite index required! Click the link in the console to create it.', 'error');
                    }
                }
                
                // Display all users
                let html = '<h3>All Users:</h3><ul>';
                snapshot1.forEach(doc => {
                    const data = doc.data();
                    html += `<li>${data.email} - Role: ${data.role} - Created: ${data.createdAt ? 'Yes' : 'No'}</li>`;
                });
                html += '</ul>';
                document.getElementById('results').innerHTML = html;
                
            } catch (error) {
                log(`Error fetching users: ${error.message}`, 'error');
                document.getElementById('results').innerHTML = 
                    `<div class="status error">Error: ${error.message}</div>`;
            }
        }
        
        async function checkIndexes() {
            log('Checking Firestore indexes...', 'info');
            
            const queries = [
                {
                    name: 'Simple users query',
                    query: () => db.collection('users').get()
                },
                {
                    name: 'Users with role filter',
                    query: () => db.collection('users').where('role', '==', 'member').get()
                },
                {
                    name: 'Users ordered by createdAt',
                    query: () => db.collection('users').orderBy('createdAt', 'desc').get()
                },
                {
                    name: 'Users with role + order (composite)',
                    query: () => db.collection('users').where('role', '==', 'member').orderBy('createdAt', 'desc').get()
                }
            ];
            
            for (const test of queries) {
                try {
                    log(`Testing: ${test.name}`, 'info');
                    const snapshot = await test.query();
                    log(`✓ ${test.name}: Success (${snapshot.size} results)`, 'success');
                } catch (error) {
                    log(`✗ ${test.name}: ${error.message}`, 'error');
                    if (error.message.includes('index')) {
                        log('→ Index required. Check browser console for link.', 'error');
                        console.error('Index creation link:', error);
                    }
                }
            }
        }
        
        async function testQuery() {
            log('Testing problematic query...', 'info');
            try {
                // This is the exact query from admin.js
                const snapshot = await db.collection('users')
                    .where('role', '==', 'member')
                    .orderBy('createdAt', 'desc')
                    .get();
                    
                log(`Query successful! Found ${snapshot.size} users`, 'success');
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    log(`- ${data.email}: ${data.firstName} ${data.lastName}`, 'info');
                });
                
            } catch (error) {
                log(`Query failed: ${error.message}`, 'error');
                
                if (error.code === 'failed-precondition') {
                    log('SOLUTION: You need to create a composite index in Firestore', 'error');
                    log('1. Check the browser console for a direct link to create the index', 'error');
                    log('2. Or go to Firebase Console > Firestore > Indexes', 'error');
                    log('3. Create index: Collection=users, Fields: role(Ascending), createdAt(Descending)', 'error');
                    console.error('Firestore Index Error - Click this link to create the index:', error);
                }
            }
        }
    </script>
</body>
</html>