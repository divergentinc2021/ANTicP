<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Config-as-Code Setup</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        .btn:hover { background: #0056b3; transform: translateY(-2px); }
        .btn-railway { background: #6366f1; }
        .btn-railway:hover { background: #4f46e5; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        
        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #6366f1;
        }
        
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            overflow-x: auto;
        }
        
        .success-box {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            margin: 15px 0;
        }
        
        .warning-box {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ffeaa7;
            margin: 15px 0;
        }
        
        .step {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .step h3 {
            color: #2c3e50;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÇ Railway Config-as-Code Setup</h1>
        <p>Automate your Railway configuration using config files instead of manual clicking!</p>

        <div class="success-box">
            <h3>‚úÖ Config Files Created!</h3>
            <p>I've generated Railway configuration files that will automatically set up your deployment with the correct settings.</p>
        </div>

        <div class="config-section">
            <h2>üìÅ Configuration Files</h2>
            <p>These files will configure Railway automatically:</p>
            
            <h3>1. railway.json (Recommended)</h3>
            <div class="code-block">
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "nixpacks",
    "buildCommand": "npm install",
    "watchPatterns": ["**/*.js", "package.json", "Procfile"]
  },
  "deploy": {
    "startCommand": "node ant-bridge-server.js",
    "restartPolicyType": "on_failure",
    "restartPolicyMaxRetries": 10,
    "healthcheckTimeout": 300
  },
  "networking": {
    "publicPort": true
  },
  "environments": {
    "production": {
      "variables": {
        "NODE_ENV": "production",
        "PLATFORM": "railway"
      }
    }
  }
}
            </div>

            <h3>2. railway.toml (Alternative)</h3>
            <div class="code-block">
[build]
builder = "nixpacks"
buildCommand = "npm install"

[deploy]
startCommand = "node ant-bridge-server.js"
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 10

[networking]
publicPort = true

[variables]
NODE_ENV = "production"
PLATFORM = "railway"
            </div>
        </div>

        <div class="step">
            <h3>üöÄ Step 1: Download Config Files</h3>
            <p>Download the Railway configuration files:</p>
            <button class="btn btn-railway" onclick="downloadRailwayJson()">üì• Download railway.json</button>
            <button class="btn btn-railway" onclick="downloadRailwayToml()">üì• Download railway.toml</button>
            <button class="btn btn-success" onclick="downloadAllFiles()">üì¶ Download All Files</button>
        </div>

        <div class="step">
            <h3>üìÇ Step 2: Add Files to Your Repository</h3>
            <p>Add the configuration files to your GitHub repository:</p>
            <ol>
                <li>Place <code>railway.json</code> in your repository root</li>
                <li>Place the updated <code>ant-bridge-server.js</code> (Railway-compatible)</li>
                <li>Update your <code>package.json</code> with correct start script</li>
                <li>Add <code>Procfile</code> for Railway start command</li>
            </ol>
            
            <div class="warning-box">
                <strong>Important:</strong> Only use <strong>either</strong> railway.json <strong>or</strong> railway.toml, not both. railway.json is recommended.
            </div>
        </div>

        <div class="step">
            <h3>‚öôÔ∏è Step 3: Enable Config-as-Code in Railway</h3>
            <p>In your Railway dashboard:</p>
            <ol>
                <li>Go to your service settings</li>
                <li>Scroll down to "Config-as-code" section</li>
                <li>Click "Add File Path"</li>
                <li>Enter: <code>railway.json</code></li>
                <li>Click "Save"</li>
            </ol>
            
            <div class="success-box">
                <strong>‚úÖ After enabling:</strong> Railway will automatically use your config file settings instead of manual configuration.
            </div>
        </div>

        <div class="step">
            <h3>üîÑ Step 4: Push and Deploy</h3>
            <div class="code-block">
# Add all files to your repository
git add railway.json
git add ant-bridge-server.js
git add package.json
git add Procfile

# Commit changes
git commit -m "Add Railway config-as-code setup"

# Push to GitHub (Railway auto-deploys)
git push origin main
            </div>
        </div>

        <div class="config-section">
            <h2>üéØ What the Config Files Do</h2>
            <ul>
                <li><strong>‚úÖ Automatic port binding:</strong> Uses Railway's assigned port</li>
                <li><strong>‚úÖ Correct start command:</strong> <code>node ant-bridge-server.js</code></li>
                <li><strong>‚úÖ Health checks:</strong> Monitors deployment health</li>
                <li><strong>‚úÖ Restart policy:</strong> Auto-restart on failures</li>
                <li><strong>‚úÖ Environment variables:</strong> Production settings</li>
                <li><strong>‚úÖ Build configuration:</strong> NPM install and watch patterns</li>
                <li><strong>‚úÖ Public networking:</strong> Enable WebSocket access</li>
            </ul>
        </div>

        <div class="success-box">
            <h3>üéâ Benefits of Config-as-Code</h3>
            <ul>
                <li><strong>No manual clicking:</strong> Everything configured automatically</li>
                <li><strong>Version controlled:</strong> Configuration in Git</li>
                <li><strong>Reproducible:</strong> Same setup every time</li>
                <li><strong>Team friendly:</strong> Everyone uses same configuration</li>
                <li><strong>Easy updates:</strong> Change config file, push to deploy</li>
            </ul>
        </div>

        <div class="step">
            <h3>üß™ Step 5: Test Your Deployment</h3>
            <p>After Railway redeploys with your config:</p>
            <button class="btn btn-railway" onclick="testRailwayConnection()">üîå Test WebSocket Connection</button>
            <button class="btn" onclick="window.open('your-railway-bridge.html', '_blank')">üöÇ Open Bridge Test Page</button>
            
            <div id="test-results" style="margin: 20px 0;"></div>
        </div>

        <div class="warning-box">
            <h3>üîß Troubleshooting</h3>
            <p><strong>If deployment still fails:</strong></p>
            <ul>
                <li>Check Railway deployment logs for errors</li>
                <li>Verify <code>railway.json</code> is in repository root</li>
                <li>Ensure config-as-code is enabled in Railway settings</li>
                <li>Make sure start command matches your file name</li>
            </ul>
        </div>
    </div>

    <script>
        function downloadRailwayJson() {
            const railwayJson = {
                "$schema": "https://railway.app/railway.schema.json",
                "build": {
                    "builder": "nixpacks",
                    "buildCommand": "npm install",
                    "watchPatterns": [
                        "**/*.js",
                        "package.json",
                        "Procfile",
                        "railway.json"
                    ]
                },
                "deploy": {
                    "startCommand": "node ant-bridge-server.js",
                    "restartPolicyType": "on_failure",
                    "restartPolicyMaxRetries": 10,
                    "healthcheckTimeout": 300
                },
                "networking": {
                    "publicPort": true
                },
                "scaling": {
                    "minReplicas": 1,
                    "maxReplicas": 1
                },
                "environments": {
                    "production": {
                        "variables": {
                            "NODE_ENV": "production",
                            "RAILWAY_STATIC_URL": "web-production-f8ebc.up.railway.app",
                            "PLATFORM": "railway"
                        }
                    }
                }
            };

            downloadFile('railway.json', JSON.stringify(railwayJson, null, 2));
        }

        function downloadRailwayToml() {
            const railwayToml = `# Railway Configuration File
# This file configures your ANT+ Bridge deployment automatically

[build]
# Use Nixpacks builder (Railway's default)
builder = "nixpacks"

# Watch for changes in these file patterns
watchPatterns = [
  "**/*.js",
  "package.json",
  "Procfile",
  "railway.toml"
]

# Build command (usually auto-detected)
buildCommand = "npm install"

[deploy]
# Start command for your ANT+ bridge server
startCommand = "node ant-bridge-server.js"

# Restart policy - restart on failure
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 10

# Health check configuration
healthcheckTimeout = 300

[networking]
# Enable public networking
publicPort = true

[scaling]
# Resource limits for free tier
minReplicas = 1
maxReplicas = 1

[variables]
# Environment variables for Railway deployment
NODE_ENV = "production"
RAILWAY_STATIC_URL = "web-production-f8ebc.up.railway.app"
PLATFORM = "railway"`;

            downloadFile('railway.toml', railwayToml);
        }

        function downloadAllFiles() {
            // Download railway.json
            downloadRailwayJson();
            
            setTimeout(() => {
                // Download fixed server code
                const serverCode = `// ANT+ Bridge Server - Railway Compatible
const WebSocket = require('ws');

class ANTBridgeServer {
    constructor() {
        this.port = process.env.PORT || 8888;
        this.wss = null;
        this.clients = new Set();
        this.demoInterval = null;
        
        console.log(\`üöÇ Railway Mode: Starting on port \${this.port}\`);
    }

    start() {
        console.log('üåâ Starting ANT+ Bridge for Railway...');
        
        this.wss = new WebSocket.Server({ 
            port: this.port,
            host: '0.0.0.0',
            cors: true,
            clientTracking: true
        });
        
        console.log(\`‚úÖ Railway WebSocket server running on port \${this.port}\`);
        console.log(\`üåê Public URL: https://web-production-f8ebc.up.railway.app\`);
        
        this.setupWebSocketHandling();
        this.setupHealthCheck();
    }

    setupWebSocketHandling() {
        this.wss.on('connection', (ws, req) => {
            const clientIP = req.headers['x-forwarded-for'] || req.connection.remoteAddress;
            console.log(\`üîå Client connected from \${clientIP}\`);
            this.clients.add(ws);
            
            this.sendToClient(ws, {
                type: 'status',
                message: 'Connected to Railway ANT+ Bridge',
                platform: 'railway',
                server_info: {
                    port: this.port,
                    environment: process.env.RAILWAY_ENVIRONMENT || 'production'
                }
            });
            
            ws.on('message', (data) => {
                try {
                    const message = JSON.parse(data);
                    this.handleBrowserMessage(ws, message);
                } catch (error) {
                    console.error('‚ùå Invalid message:', error);
                }
            });
            
            ws.on('close', () => {
                console.log('üîå Client disconnected');
                this.clients.delete(ws);
            });
            
            ws.on('error', (error) => {
                console.error('‚ùå WebSocket error:', error);
                this.clients.delete(ws);
            });
        });
    }

    setupHealthCheck() {
        setInterval(() => {
            if (this.clients.size > 0) {
                console.log(\`üíì Railway health: \${this.clients.size} clients connected\`);
            }
        }, 30000);
    }

    handleBrowserMessage(ws, message) {
        console.log('üì® Message:', message.type);
        
        switch (message.type) {
            case 'connect':
                this.connectANT(ws, message.rate || 57600);
                break;
            case 'disconnect':
                this.disconnectANT(ws);
                break;
            case 'ping':
                this.sendToClient(ws, { 
                    type: 'pong', 
                    timestamp: Date.now(),
                    platform: 'railway'
                });
                break;
            default:
                this.sendToClient(ws, { 
                    type: 'error', 
                    message: \`Unknown message type: \${message.type}\` 
                });
        }
    }

    sendToClient(ws, message) {
        if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(message));
        }
    }

    connectANT(ws, rate) {
        console.log(\`üé≠ Railway Demo Mode: Simulating ANT+ at \${rate} Hz\`);
        
        this.sendToClient(ws, {
            type: 'connecting',
            message: \`Railway Demo: Connecting at \${rate} Hz...\`,
            platform: 'railway'
        });
        
        setTimeout(() => {
            this.sendToClient(ws, {
                type: 'connected',
                message: 'Railway Demo: ANT+ simulation active',
                rate: rate,
                platform: 'railway',
                demo: true
            });
            
            this.demoInterval = setInterval(() => {
                this.sendToClient(ws, {
                    type: 'data',
                    device_type: '0x11',
                    device_id: 12345,
                    channel: 0,
                    payload: ['0x00', '0x01', '0x02', '0x03', '0x04', '0x05', '0x06', '0x07'],
                    rate: rate,
                    trainer: {
                        power: 200 + Math.floor(Math.random() * 100),
                        speed_kmh: 30 + Math.floor(Math.random() * 20)
                    },
                    platform: 'railway',
                    demo: true
                });
            }, 2000);
            
        }, 1000);
    }

    disconnectANT(ws) {
        if (this.demoInterval) {
            clearInterval(this.demoInterval);
            this.demoInterval = null;
        }
        
        this.sendToClient(ws, {
            type: 'disconnected',
            message: 'Railway Demo: ANT+ simulation stopped',
            platform: 'railway'
        });
    }
}

if (require.main === module) {
    const server = new ANTBridgeServer();
    server.start();
    
    process.on('SIGINT', () => {
        console.log('üõë Railway SIGINT received');
        process.exit(0);
    });

    process.on('SIGTERM', () => {
        console.log('üöÇ Railway SIGTERM received');
        process.exit(0);
    });
}

module.exports = ANTBridgeServer;`;

                downloadFile('ant-bridge-server.js', serverCode);
            }, 500);

            setTimeout(() => {
                // Download package.json
                const packageJson = `{
  "name": "ant-bridge-railway",
  "version": "1.0.0",
  "description": "ANT+ Bridge Server for Railway",
  "main": "ant-bridge-server.js",
  "scripts": {
    "start": "node ant-bridge-server.js",
    "dev": "node ant-bridge-server.js"
  },
  "dependencies": {
    "ws": "^8.14.0"
  },
  "engines": {
    "node": ">=16.0.0"
  },
  "keywords": ["ant+", "bridge", "websocket", "railway"],
  "author": "",
  "license": "MIT"
}`;

                downloadFile('package.json', packageJson);
            }, 1000);

            setTimeout(() => {
                // Download Procfile
                downloadFile('Procfile', 'web: node ant-bridge-server.js');
            }, 1500);

            alert('‚úÖ Downloaded all Railway configuration files!');
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        async function testRailwayConnection() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p>üîç Testing Railway WebSocket connection...</p>';

            try {
                const ws = new WebSocket('wss://web-production-f8ebc.up.railway.app');
                
                const timeout = setTimeout(() => {
                    ws.close();
                    resultsDiv.innerHTML = '<div class="warning-box">‚ùå Connection timeout - Check if Railway has redeployed with new config</div>';
                }, 15000);

                ws.onopen = () => {
                    clearTimeout(timeout);
                    resultsDiv.innerHTML = '<div class="success-box">‚úÖ Railway WebSocket connection successful! Config-as-code is working!</div>';
                    ws.close();
                };

                ws.onerror = () => {
                    clearTimeout(timeout);
                    resultsDiv.innerHTML = '<div class="warning-box">‚ùå Connection failed - Railway may still be deploying with new configuration</div>';
                };

            } catch (error) {
                resultsDiv.innerHTML = \`<div class="warning-box">‚ùå Test failed: \${error.message}</div>\`;
            }
        }
    </script>
</body>
</html>
