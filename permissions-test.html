<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANT+ Permissions Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .permission-item { 
            margin: 10px 0; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .granted { background: #d4edda; }
        .denied { background: #f8d7da; }
        .unknown { background: #fff3cd; }
        button { 
            padding: 10px 15px; 
            margin: 5px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            background: #007bff; 
            color: white; 
        }
        button:hover { background: #0056b3; }
        #log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 15px; 
            margin-top: 20px; 
            height: 300px; 
            overflow-y: auto; 
            font-family: monospace; 
            white-space: pre-wrap; 
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ANT+ Bluetooth Permissions Test</h1>
    
    <div class="permission-item" id="https-status">
        <strong>ğŸ”’ HTTPS Connection:</strong> <span id="https-result">Checking...</span>
    </div>
    
    <div class="permission-item" id="bluetooth-status">
        <strong>ğŸ“¶ Web Bluetooth API:</strong> <span id="bluetooth-result">Checking...</span>
    </div>
    
    <div class="permission-item" id="serial-status">
        <strong>ğŸ”Œ Web Serial API:</strong> <span id="serial-result">Checking...</span>
        <button id="request-serial">Request Serial Access</button>
    </div>
    
    <div class="permission-item" id="location-status">
        <strong>ğŸ“ Location Permission:</strong> <span id="location-result">Checking...</span>
        <button id="request-location">Request Location</button>
    </div>
    
    <h3>ğŸš´ Device Connection Tests</h3>
    <button id="scan-bluetooth">Scan Bluetooth Devices</button>
    <button id="scan-serial">Scan Serial Ports</button>
    <button id="check-ports">Check Existing Ports</button>
    
    <div id="log"></div>

    <script>
        const log = document.getElementById('log');
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.textContent += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }
        
        async function checkPermissions() {
            addLog('ğŸ” Checking all permissions...');
            
            // HTTPS Check
            const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';
            document.getElementById('https-result').textContent = isHTTPS ? 'âœ… Secure' : 'âŒ Not HTTPS';
            document.getElementById('https-status').className = 'permission-item ' + (isHTTPS ? 'granted' : 'denied');
            
            // Bluetooth Check
            const hasBluetoothAPI = 'bluetooth' in navigator;
            document.getElementById('bluetooth-result').textContent = hasBluetoothAPI ? 'âœ… Available' : 'âŒ Not supported';
            document.getElementById('bluetooth-status').className = 'permission-item ' + (hasBluetoothAPI ? 'granted' : 'denied');
            
            // Serial Check
            const hasSerialAPI = 'serial' in navigator;
            document.getElementById('serial-result').textContent = hasSerialAPI ? 'âœ… Available' : 'âŒ Not supported';
            document.getElementById('serial-status').className = 'permission-item ' + (hasSerialAPI ? 'granted' : 'denied');
            
            if (hasSerialAPI) {
                try {
                    const ports = await navigator.serial.getPorts();
                    addLog(`ğŸ“¶ Found ${ports.length} existing serial port permissions`);
                    ports.forEach((port, index) => {
                        addLog(`  Port ${index + 1}: ${port.getInfo ? JSON.stringify(port.getInfo()) : 'Unknown device'}`);
                    });
                } catch (error) {
                    addLog(`âŒ Error checking serial ports: ${error.message}`);
                }
            }
            
            // Location Check (Android)
            const isAndroid = /android/i.test(navigator.userAgent);
            if (isAndroid && 'permissions' in navigator) {
                try {
                    const result = await navigator.permissions.query({name: 'geolocation'});
                    document.getElementById('location-result').textContent = `${result.state === 'granted' ? 'âœ…' : 'âš ï¸'} ${result.state}`;
                    document.getElementById('location-status').className = 'permission-item ' + 
                        (result.state === 'granted' ? 'granted' : result.state === 'denied' ? 'denied' : 'unknown');
                } catch (error) {
                    document.getElementById('location-result').textContent = 'â“ Unknown';
                    document.getElementById('location-status').className = 'permission-item unknown';
                }
            } else {
                document.getElementById('location-result').textContent = isAndroid ? 'â“ Cannot check' : 'â„¹ï¸ Not needed';
                document.getElementById('location-status').className = 'permission-item unknown';
            }
            
            addLog('âœ… Permission check complete');
        }
        
        document.getElementById('request-serial').addEventListener('click', async () => {
            addLog('ğŸ” Requesting serial port access...');
            try {
                const port = await navigator.serial.requestPort();
                addLog(`âœ… Serial port granted: ${JSON.stringify(port.getInfo())}`);
                await checkPermissions(); // Refresh
            } catch (error) {
                if (error.name === 'NotFoundError') {
                    addLog('âš ï¸ No serial device selected');
                } else {
                    addLog(`âŒ Serial request failed: ${error.message}`);
                }
            }
        });
        
        document.getElementById('request-location').addEventListener('click', async () => {
            addLog('ğŸ” Requesting location permission...');
            try {
                await navigator.geolocation.getCurrentPosition(
                    (position) => addLog('âœ… Location permission granted'),
                    (error) => addLog(`âŒ Location denied: ${error.message}`)
                );
                await checkPermissions(); // Refresh
            } catch (error) {
                addLog(`âŒ Location request failed: ${error.message}`);
            }
        });
        
        document.getElementById('scan-bluetooth').addEventListener('click', async () => {
            addLog('ğŸ” Scanning for Bluetooth devices...');
            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [0x180D, 0x1818, 0x1816, 0x1826]
                });
                addLog(`âœ… Bluetooth device selected: ${device.name || 'Unknown'} (${device.id})`);
                
                // Try to connect
                const server = await device.gatt.connect();
                addLog(`âœ… Connected to GATT server`);
                
                const services = await server.getPrimaryServices();
                addLog(`ğŸ“‹ Found ${services.length} services:`);
                services.forEach(service => {
                    addLog(`  Service: ${service.uuid}`);
                });
                
            } catch (error) {
                if (error.name === 'NotFoundError') {
                    addLog('âš ï¸ No Bluetooth device selected');
                } else {
                    addLog(`âŒ Bluetooth scan failed: ${error.message}`);
                }
            }
        });
        
        document.getElementById('scan-serial').addEventListener('click', async () => {
            addLog('ğŸ” Requesting new serial port...');
            try {
                const port = await navigator.serial.requestPort();
                addLog(`âœ… Serial port selected: ${JSON.stringify(port.getInfo())}`);
                
                // Try to open the port
                await port.open({ baudRate: 9600 });
                addLog(`âœ… Serial port opened successfully`);
                
                // Close it
                await port.close();
                addLog(`ğŸ“Œ Serial port closed`);
                
            } catch (error) {
                addLog(`âŒ Serial port operation failed: ${error.message}`);
            }
        });
        
        document.getElementById('check-ports').addEventListener('click', async () => {
            addLog('ğŸ” Checking all granted serial ports...');
            try {
                const ports = await navigator.serial.getPorts();
                addLog(`ğŸ“¶ Found ${ports.length} granted serial ports:`);
                
                for (let i = 0; i < ports.length; i++) {
                    const port = ports[i];
                    const info = port.getInfo();
                    addLog(`  Port ${i + 1}:`);
                    addLog(`    Vendor ID: ${info.usbVendorId || 'Unknown'}`);
                    addLog(`    Product ID: ${info.usbProductId || 'Unknown'}`);
                    addLog(`    Serial Number: ${info.serialNumber || 'Unknown'}`);
                }
            } catch (error) {
                addLog(`âŒ Error checking ports: ${error.message}`);
            }
        });
        
        // Auto-check permissions on load
        document.addEventListener('DOMContentLoaded', checkPermissions);
        
        addLog('ğŸš€ ANT+ Permissions Test Tool loaded');
        addLog('ğŸ’¡ This tool helps diagnose Bluetooth and Serial port permissions');
        addLog('ğŸ“± For ANT+ devices, you typically need both Bluetooth AND Serial port access');
    </script>
</body>
</html>
