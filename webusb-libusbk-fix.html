<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebUSB libusbK Driver Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .log {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 5px;
            font-family: monospace;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 20px 0;
        }
        .problem-box {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .solution-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .info-box {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß WebUSB libusbK Driver Issue Fix</h1>
        <p>Solving "Access denied" with libusbK driver on Windows</p>
        
        <div class="problem-box">
            <h3>‚ùå Problem Identified</h3>
            <p><strong>Root Cause Found:</strong> Your ANT+ device uses <strong>libusbK driver</strong>, which has limited WebUSB support on Windows.</p>
            <ul>
                <li><strong>Device:</strong> ANT USBStick2</li>
                <li><strong>Driver:</strong> libusbK (not libusb-win32)</li>
                <li><strong>Issue:</strong> WebUSB has restricted access to libusbK devices</li>
                <li><strong>Status:</strong> Device detected but "Access denied" when opening</li>
            </ul>
        </div>

        <div class="solution-box">
            <h3>‚úÖ Solutions (Try in Order)</h3>
            <p><strong>We have several approaches to solve this:</strong></p>
        </div>

        <div class="controls">
            <button class="btn btn-warning" onclick="tryWinUSBDriver()">üîß Method 1: Try WinUSB Driver</button>
            <button class="btn btn-success" onclick="tryZadigReplacement()">üõ†Ô∏è Method 2: Zadig Driver Tool</button>
            <button class="btn" onclick="tryAdvancedWebUSB()">‚ö° Method 3: Advanced WebUSB</button>
            <button class="btn btn-danger" onclick="checkChromeFlags()">üè¥ Method 4: Chrome Flags</button>
            <button class="btn" onclick="testCurrentState()">üß™ Test Current State</button>
            <button class="btn" onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div class="info-box">
            <h3>üìã Why libusbK Causes "Access Denied"</h3>
            <p><strong>Technical Details:</strong></p>
            <ul>
                <li><strong>libusbK</strong> is a newer version of libusb for Windows</li>
                <li><strong>WebUSB</strong> was designed primarily for WinUSB driver</li>
                <li><strong>Chrome</strong> has restricted access to some libusbK devices</li>
                <li><strong>Security Model:</strong> Windows blocks direct access for "protection"</li>
            </ul>
        </div>

        <div class="log" id="log">
WebUSB libusbK Driver Fix
=========================
Problem: ANT+ device uses libusbK driver which limits WebUSB access
Status: Device detected but "Access denied" when opening

Available Solutions:
1. Switch to WinUSB driver (recommended)
2. Use Zadig to replace driver
3. Try advanced WebUSB techniques
4. Enable additional Chrome flags

Click a method above to try it...
        </div>
    </div>

    <script>
        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logEl.textContent += logMessage + '\n';
            logEl.scrollTop = logEl.scrollHeight;
            console.log(logMessage);
        }

        async function tryWinUSBDriver() {
            log('üîß Method 1: WinUSB Driver Approach');
            log('======================================');
            log('');
            log('üí° libusbK ‚Üí WinUSB driver replacement');
            log('This is the most compatible approach for WebUSB');
            log('');
            log('üìã Steps to replace driver:');
            log('');
            log('1. Open Device Manager (Win+X ‚Üí Device Manager)');
            log('2. Find: "libusb-win32 devices" ‚Üí "ANT USBStick2"');
            log('3. Right-click ‚Üí "Update driver"');
            log('4. Choose: "Browse my computer for drivers"');
            log('5. Choose: "Let me pick from a list..."');
            log('6. Look for: "Universal Serial Bus devices"');
            log('7. Select: "WinUsb Device" by Microsoft');
            log('8. Click Next and install');
            log('');
            log('‚ö†Ô∏è If "WinUsb Device" not available:');
            log('   ‚Ä¢ Try "USB Composite Device"');
            log('   ‚Ä¢ Or download WinUSB driver from Microsoft');
            log('');
            log('‚úÖ After driver change:');
            log('   ‚Ä¢ Device should appear under "Universal Serial Bus controllers"');
            log('   ‚Ä¢ WebUSB should work without "Access denied"');
            log('   ‚Ä¢ Test with the WebUSB connection button below');
        }

        async function tryZadigReplacement() {
            log('üõ†Ô∏è Method 2: Zadig Driver Replacement Tool');
            log('==========================================');
            log('');
            log('üí° Use Zadig to force WinUSB driver installation');
            log('Zadig is the gold standard for USB driver replacement');
            log('');
            log('üìã Steps with Zadig:');
            log('');
            log('1. Download Zadig from: https://zadig.akeo.ie/');
            log('2. Run as Administrator');
            log('3. Options ‚Üí List All Devices (check this)');
            log('4. Find your "ANT USBStick2" in the dropdown');
            log('5. Current driver should show "libusbK"');
            log('6. Target driver: Select "WinUSB" from right dropdown');
            log('7. Click "Replace Driver" or "Install Driver"');
            log('8. Wait for installation to complete');
            log('9. Restart your computer');
            log('');
            log('üéØ Expected result:');
            log('   ‚Ä¢ Device Manager shows ANT device under USB controllers');
            log('   ‚Ä¢ Driver shows as "WinUSB" instead of "libusbK"');
            log('   ‚Ä¢ WebUSB gains full access without restrictions');
            log('');
            log('üí° Zadig Download: https://zadig.akeo.ie/');
        }

        async function tryAdvancedWebUSB() {
            log('‚ö° Method 3: Advanced WebUSB Techniques');
            log('======================================');
            log('');
            log('üí° Attempting advanced WebUSB access methods...');
            
            try {
                // Check current WebUSB configuration
                if (!navigator.usb) {
                    log('‚ùå WebUSB API not available');
                    return;
                }
                
                log('üîç Checking WebUSB device filters...');
                
                // Try getting devices with advanced filters
                const devices = await navigator.usb.getDevices();
                log(`üì± Found ${devices.length} authorized device(s)`);
                
                if (devices.length === 0) {
                    log('‚ö†Ô∏è No authorized devices - requesting permission...');
                    
                    try {
                        const device = await navigator.usb.requestDevice({
                            filters: [
                                { vendorId: 0x0FCF, productId: 0x1008 },
                                { vendorId: 0x0FCF }
                            ]
                        });
                        log(`‚úÖ Device authorized: ${device.productName}`);
                        devices.push(device);
                    } catch (e) {
                        log(`‚ùå Authorization failed: ${e.message}`);
                        return;
                    }
                }
                
                for (const device of devices) {
                    if (device.vendorId === 0x0FCF) {
                        log(`üéØ Testing ANT+ device: ${device.productName}`);
                        log(`   VID: 0x${device.vendorId.toString(16)}`);
                        log(`   PID: 0x${device.productId.toString(16)}`);
                        
                        try {
                            log('üîì Attempting advanced open...');
                            
                            // Try opening with different configurations
                            await device.open();
                            log('‚úÖ SUCCESS! Device opened with advanced method');
                            
                            // Check configuration
                            if (device.configuration === null) {
                                log('‚öôÔ∏è Selecting configuration...');
                                await device.selectConfiguration(1);
                            }
                            
                            log(`üìä Configuration: ${device.configuration.configurationValue}`);
                            log(`üîå Interfaces: ${device.configuration.interfaces.length}`);
                            
                            // Close cleanly
                            await device.close();
                            log('üéâ Advanced WebUSB method SUCCESSFUL!');
                            log('üí° Your device should now work with WebUSB');
                            
                        } catch (error) {
                            log(`‚ùå Advanced method failed: ${error.message}`);
                            
                            if (error.message.includes('Access denied')) {
                                log('üí° Still getting access denied - driver issue confirmed');
                                log('üîß Try Method 1 (WinUSB) or Method 2 (Zadig)');
                            }
                        }
                    }
                }
                
            } catch (error) {
                log(`‚ùå Advanced WebUSB test failed: ${error.message}`);
            }
        }

        async function checkChromeFlags() {
            log('üè¥ Method 4: Advanced Chrome Flags');
            log('===================================');
            log('');
            log('üí° Additional Chrome flags that might help with libusbK');
            log('');
            log('üîß Chrome Flags to Enable:');
            log('');
            log('1. chrome://flags/#enable-experimental-web-platform-features');
            log('   Status: Should already be enabled');
            log('');
            log('2. chrome://flags/#enable-web-usb-on-extension-service-worker');
            log('   Description: Enable WebUSB in service workers');
            log('   Set to: Enabled');
            log('');
            log('3. chrome://flags/#enable-generic-sensor-extra-classes');
            log('   Description: Enable additional sensor access');
            log('   Set to: Enabled');
            log('');
            log('4. chrome://flags/#enable-unsafe-webgpu');
            log('   Description: Enable unsafe WebGPU (sometimes helps with USB)');
            log('   Set to: Enabled');
            log('');
            log('5. Start Chrome with additional flags:');
            log('   Close Chrome completely, then run:');
            log('   chrome.exe --enable-experimental-web-platform-features --disable-web-security --user-data-dir="c:/temp/chrome"');
            log('');
            log('‚ö†Ô∏è Security Note: These flags reduce security');
            log('üí° Use only for testing, reset flags after success');
            log('');
            log('üîÑ After enabling flags: Restart Chrome and test again');
        }

        async function testCurrentState() {
            log('üß™ Testing Current WebUSB State');
            log('==============================');
            log('');
            
            try {
                if (!navigator.usb) {
                    log('‚ùå WebUSB API not supported');
                    return;
                }
                
                log('‚úÖ WebUSB API available');
                
                // Check for devices
                const devices = await navigator.usb.getDevices();
                log(`üì± Authorized devices: ${devices.length}`);
                
                if (devices.length === 0) {
                    log('‚ö†Ô∏è No authorized devices');
                    log('üí° Request device authorization first');
                    return;
                }
                
                // Find ANT+ device
                const antDevice = devices.find(d => d.vendorId === 0x0FCF);
                if (!antDevice) {
                    log('‚ùå No ANT+ device in authorized list');
                    return;
                }
                
                log(`üéØ ANT+ Device: ${antDevice.productName}`);
                log(`üìä VID: 0x${antDevice.vendorId.toString(16)} PID: 0x${antDevice.productId.toString(16)}`);
                log(`üîì Opened: ${antDevice.opened}`);
                
                // Test opening
                log('üß™ Testing device open...');
                try {
                    await antDevice.open();
                    log('‚úÖ SUCCESS! Device opens without "Access denied"');
                    log('üéâ WebUSB is working properly now!');
                    
                    await antDevice.close();
                    log('üîå Device closed cleanly');
                    
                } catch (openError) {
                    log(`‚ùå Still getting error: ${openError.message}`);
                    
                    if (openError.message.includes('Access denied')) {
                        log('üí° Driver issue persists - try driver replacement methods');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`);
            }
        }

        function clearLog() {
            document.getElementById('log').textContent = 'Log cleared.\nWebUSB libusbK Driver Fix ready...\n';
        }

        // Initial diagnostic
        log('üîß WebUSB libusbK Driver Fix Ready');
        log('üìä Problem: ANT+ device uses libusbK driver');
        log('‚ö†Ô∏è WebUSB has limited libusbK support on Windows');
        log('üí° Solutions available - try Method 1 (WinUSB) first');
    </script>
</body>
</html>
