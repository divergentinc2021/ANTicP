<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete ANT+ WebUSB Solution</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-warning:hover { background: #e0a800; }
        .log {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 5px;
            font-family: monospace;
            height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 20px 0;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .info-box {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Complete ANT+ WebUSB Solution</h1>
        <p>All 5 transfer rates + Process killer to solve "Access denied"</p>
        
        <div class="warning-box">
            <h3>🛑 Step 1: Kill Competing Processes</h3>
            <p><strong>"Access denied" = Another app is using your ANT+ device</strong></p>
            <button class="btn btn-danger" onclick="checkAndKillProcesses()">🛑 Kill ANT+ Processes</button>
            <button class="btn btn-warning" onclick="manualProcessCheck()">📋 Manual Process Check</button>
        </div>

        <div class="info-box">
            <h3>⚡ Step 2: All 5 ANT+ Transfer Rates</h3>
            <p><strong>Complete rate support as observed in ANT simulators:</strong></p>
            <ul>
                <li><strong>50,000 Hz</strong> - Low speed mode</li>
                <li><strong>57,600 Hz</strong> - Standard ANT+ rate</li>
                <li><strong>115,200 Hz</strong> - High speed mode</li>
                <li><strong>2,000,000 Hz</strong> - Very high speed (2MHz)</li>
                <li><strong>3,000,000 Hz</strong> - Maximum speed (3MHz)</li>
            </ul>
        </div>

        <div class="controls">
            <button class="btn" onclick="connectDevice()">🔌 Connect Device</button>
            <button class="btn btn-success" onclick="initializeRate(50000)">⚡ 50K Hz</button>
            <button class="btn btn-success" onclick="initializeRate(57600)">⚡ 57.6K Hz</button>
            <button class="btn btn-success" onclick="initializeRate(115200)">⚡ 115.2K Hz</button>
            <button class="btn btn-success" onclick="initializeRate(2000000)">🚀 2MHz</button>
            <button class="btn btn-success" onclick="initializeRate(3000000)">💨 3MHz</button>
            <button class="btn" onclick="startTransmission()">📡 Start TX</button>
            <button class="btn btn-danger" onclick="disconnectDevice()">🔌 Disconnect</button>
            <button class="btn" onclick="clearLog()">🗑️ Clear</button>
        </div>

        <div class="log" id="log">
Complete ANT+ WebUSB Solution
=============================
✅ All 5 transfer rates supported (50K, 57.6K, 115.2K, 2MHz, 3MHz)
🛑 Process killer to solve "Access denied" errors
📡 Proper ANT+ initialization like simulators

Step 1: Kill competing processes first
Step 2: Connect device
Step 3: Choose transfer rate
Step 4: Start transmission

Ready...
        </div>
    </div>

    <script>
        let device = null;
        let interface0 = null;
        let endpointIn = null;
        let endpointOut = null;
        let isListening = false;
        let currentRate = 57600;

        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logEl.textContent += logMessage + '\n';
            logEl.scrollTop = logEl.scrollHeight;
            console.log(logMessage);
        }

        async function checkAndKillProcesses() {
            log('🛑 Checking for competing ANT+ processes...');
            log('');
            log('💡 CRITICAL: You must manually close these applications:');
            log('');
            log('🎯 High Priority (Usually the culprit):');
            log('   • Garmin Express - Close completely');
            log('   • ANT Agent - Stop service in Task Manager');
            log('   • Any ANT+ simulator running');
            log('');
            log('📋 Steps to free up your ANT+ device:');
            log('   1. Press Ctrl+Shift+Esc (Task Manager)');
            log('   2. Find and END these processes:');
            log('      - Garmin Express.exe');
            log('      - ANTAgent.exe');
            log('      - GarminCore.exe');
            log('      - Any process with "ANT" in name');
            log('   3. Go to Services tab, stop:');
            log('      - ANT Agent service');
            log('      - Garmin Core Update Service');
            log('');
            log('🔄 Alternative: Restart your computer to clear all locks');
            log('');
            log('💡 After clearing processes, try "Connect Device" again');
        }

        async function manualProcessCheck() {
            log('📋 Manual Process Check Guide:');
            log('');
            log('🔍 Open Task Manager (Ctrl+Shift+Esc) and look for:');
            log('');
            log('🟥 CRITICAL PROCESSES TO CLOSE:');
            log('   ├─ Garmin Express.exe');
            log('   ├─ GarminCore.exe');
            log('   ├─ ANTAgent.exe (or ANT Agent.exe)');
            log('   ├─ GarminDevice.exe');
            log('   └─ Any Garmin*.exe processes');
            log('');
            log('🟨 TRAINING SOFTWARE (if running):');
            log('   ├─ Zwift.exe');
            log('   ├─ TrainerRoad.exe');
            log('   ├─ Sufferfest.exe');
            log('   ├─ WahooFitnessDevice.exe');
            log('   └─ SuuntoLink.exe');
            log('');
            log('🟦 BACKGROUND SERVICES (Services.msc):');
            log('   ├─ ANT Agent');
            log('   ├─ Garmin Core Update Service');
            log('   └─ Garmin Device Interaction Service');
            log('');
            log('⚡ QUICK TEST: Unplug ANT+ stick for 10 seconds, plug back in');
        }

        async function connectDevice() {
            log('🔌 Attempting to connect ANT+ device...');
            
            try {
                // First check if we already have authorized devices
                const existingDevices = await navigator.usb.getDevices();
                const antDevice = existingDevices.find(d => d.vendorId === 0x0FCF);
                
                if (antDevice) {
                    log('📱 Found authorized ANT+ device, attempting to use it...');
                    device = antDevice;
                } else {
                    log('🔍 Requesting new device authorization...');
                    device = await navigator.usb.requestDevice({
                        filters: [
                            { vendorId: 0x0FCF, productId: 0x1008 }, // ANT USB Stick 2
                            { vendorId: 0x0FCF, productId: 0x1009 }, // ANT USB-m Stick
                            { vendorId: 0x0FCF }, // Any Garmin/Dynastream
                        ]
                    });
                }
                
                log(`✅ Device: ${device.productName || 'ANT+ Device'}`);
                log(`📊 VID: 0x${device.vendorId.toString(16)} PID: 0x${device.productId.toString(16)}`);
                
                // Attempt to open (this is where "Access denied" usually happens)
                log('🔓 Opening device...');
                await device.open();
                log('✅ Device opened successfully!');
                
                // Configure device
                if (device.configuration === null) {
                    await device.selectConfiguration(1);
                    log('⚙️ Configuration selected');
                }
                
                // Claim interface
                interface0 = device.configuration.interfaces[0];
                await device.claimInterface(interface0.interfaceNumber);
                log(`✅ Interface ${interface0.interfaceNumber} claimed`);
                
                // Find endpoints
                const alt = interface0.alternate;
                endpointOut = alt.endpoints.find(ep => ep.direction === 'out' && ep.type === 'bulk');
                endpointIn = alt.endpoints.find(ep => ep.direction === 'in' && ep.type === 'bulk');
                
                log(`📤 OUT: Endpoint ${endpointOut.endpointNumber}`);
                log(`📥 IN: Endpoint ${endpointIn.endpointNumber}`);
                log('');
                log('🎉 SUCCESS! Device connected and ready');
                log('💡 Now choose a transfer rate (50K - 3MHz)');
                
            } catch (error) {
                log(`❌ Connection failed: ${error.message}`);
                
                if (error.message.includes('Access denied')) {
                    log('');
                    log('🛑 ACCESS DENIED - Device is locked by another process');
                    log('💡 Solutions (try in order):');
                    log('   1. Click "Kill ANT+ Processes" above');
                    log('   2. Close Garmin Express completely');
                    log('   3. Restart your computer');
                    log('   4. Unplug/replug ANT+ stick');
                    log('');
                    log('🔍 Most common cause: Garmin Express running in background');
                } else if (error.name === 'NotFoundError') {
                    log('💡 No device selected or ANT+ stick not found');
                }
            }
        }

        async function initializeRate(rate) {
            if (!device) {
                log('❌ Connect device first');
                return;
            }
            
            currentRate = rate;
            const rateNames = {
                50000: 'Low Speed (50K Hz)',
                57600: 'Standard (57.6K Hz)',
                115200: 'High Speed (115.2K Hz)',
                2000000: 'Very High Speed (2MHz)',
                3000000: 'Maximum Speed (3MHz)'
            };
            
            try {
                log(`🔧 Initializing at ${rateNames[rate]}...`);
                
                // Reset system
                await sendANTMessage([0x4A, 0x00]); // System Reset
                await sleep(1000);
                
                // Set network key
                const networkKey = [0xB9, 0xA5, 0x21, 0xFB, 0xBD, 0x72, 0xC3, 0x45];
                await sendANTMessage([0x46, 0x00, ...networkKey]);
                await sleep(100);
                
                // Configure channels based on rate
                log(`📡 Configuring channels for ${rate} Hz...`);
                
                // Channel periods optimized for each rate
                let channelPeriod, frequency;
                switch (rate) {
                    case 50000:
                        channelPeriod = [0x00, 0x40]; // Slower period for 50K
                        frequency = 57; // Standard frequency
                        break;
                    case 57600:
                        channelPeriod = [0x86, 0x1F]; // Standard ANT+ period
                        frequency = 57;
                        break;
                    case 115200:
                        channelPeriod = [0x43, 0x0F]; // Faster period for 115K
                        frequency = 66;
                        break;
                    case 2000000:
                        channelPeriod = [0x0C, 0x03]; // Very fast for 2MHz
                        frequency = 78;
                        break;
                    case 3000000:
                        channelPeriod = [0x08, 0x02]; // Maximum speed for 3MHz
                        frequency = 78;
                        break;
                }
                
                // Channel 0: FE-C
                await sendANTMessage([0x42, 0x00, 0x10, 0x00]); // Assign Channel
                await sendANTMessage([0x51, 0x00, 0x11, 0x05, 0x01]); // Set Channel ID
                await sendANTMessage([0x43, 0x00, ...channelPeriod]); // Set optimized period
                await sendANTMessage([0x45, 0x00, frequency]); // Set frequency
                await sleep(50);
                
                // Channel 1: Heart Rate
                await sendANTMessage([0x42, 0x01, 0x10, 0x00]);
                await sendANTMessage([0x51, 0x01, 0x78, 0x05, 0x01]);
                await sendANTMessage([0x43, 0x01, ...channelPeriod]);
                await sendANTMessage([0x45, 0x01, frequency]);
                await sleep(50);
                
                // Additional channels for high speeds
                if (rate >= 115200) {
                    await sendANTMessage([0x42, 0x02, 0x10, 0x00]); // Power
                    await sendANTMessage([0x51, 0x02, 0x0B, 0x05, 0x01]);
                    await sendANTMessage([0x43, 0x02, ...channelPeriod]);
                    await sendANTMessage([0x45, 0x02, frequency]);
                    await sleep(50);
                }
                
                if (rate >= 2000000) {
                    await sendANTMessage([0x42, 0x03, 0x10, 0x00]); // Speed/Cadence
                    await sendANTMessage([0x51, 0x03, 0x79, 0x05, 0x01]);
                    await sendANTMessage([0x43, 0x03, ...channelPeriod]);
                    await sendANTMessage([0x45, 0x03, frequency]);
                    await sleep(50);
                }
                
                log(`✅ Initialized at ${rateNames[rate]}`);
                log('📡 Ready for data transmission');
                
            } catch (error) {
                log(`❌ Initialization failed: ${error.message}`);
            }
        }

        async function startTransmission() {
            if (!device) {
                log('❌ Connect and initialize device first');
                return;
            }
            
            try {
                log(`📡 Starting transmission at ${currentRate} Hz...`);
                
                // Open channels
                await sendANTMessage([0x4B, 0x00]); // Open Channel 0
                await sendANTMessage([0x4B, 0x01]); // Open Channel 1
                
                if (currentRate >= 115200) {
                    await sendANTMessage([0x4B, 0x02]); // Open Channel 2
                }
                if (currentRate >= 2000000) {
                    await sendANTMessage([0x4B, 0x03]); // Open Channel 3
                }
                
                log(`✅ Channels opened for ${currentRate} Hz transmission`);
                
                // Start data listener
                isListening = true;
                startDataListener();
                
            } catch (error) {
                log(`❌ Failed to start transmission: ${error.message}`);
            }
        }

        async function sendANTMessage(payload) {
            const SYNC_BYTE = 0xA4;
            const message = [SYNC_BYTE, payload.length, ...payload];
            
            let checksum = 0;
            for (let i = 0; i < message.length; i++) {
                checksum ^= message[i];
            }
            message.push(checksum);
            
            const result = await device.transferOut(endpointOut.endpointNumber, new Uint8Array(message));
            const hex = message.map(b => b.toString(16).padStart(2, '0')).join(' ');
            log(`📤 ${hex}`);
            
            return result;
        }

        async function startDataListener() {
            log(`🎧 Listening for data at ${currentRate} Hz...`);
            
            while (isListening && device) {
                try {
                    const result = await device.transferIn(endpointIn.endpointNumber, endpointIn.packetSize);
                    
                    if (result.status === 'ok' && result.data?.byteLength > 0) {
                        const data = new Uint8Array(result.data.buffer);
                        const hex = Array.from(data).map(b => b.toString(16).padStart(2, '0')).join(' ');
                        log(`📦 [${currentRate}Hz] ${hex}`);
                    }
                    
                    // Adaptive delay based on rate
                    const delay = Math.max(1, Math.floor(50 * (57600 / currentRate)));
                    await sleep(delay);
                    
                } catch (error) {
                    if (isListening) {
                        log(`⚠️ Read error: ${error.message}`);
                        await sleep(100);
                    }
                }
            }
        }

        async function disconnectDevice() {
            isListening = false;
            
            if (device && interface0) {
                try {
                    await device.releaseInterface(interface0.interfaceNumber);
                    await device.close();
                    log('✅ Device disconnected');
                } catch (error) {
                    log(`⚠️ Disconnect error: ${error.message}`);
                }
            }
            
            device = null;
            interface0 = null;
        }

        function clearLog() {
            document.getElementById('log').textContent = 'Log cleared.\nComplete ANT+ WebUSB Solution ready...\n';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Initial message
        log('🔧 Complete ANT+ WebUSB Solution Ready');
        log('✅ All 5 transfer rates: 50K, 57.6K, 115.2K, 2MHz, 3MHz');
        log('🛑 Process killer to solve "Access denied"');
        log('💡 Step 1: Kill competing processes first!');
    </script>
</body>
</html>
