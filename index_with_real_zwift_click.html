<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Platform Bluetooth ANT+ Receiver</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì° Cross-Platform Bluetooth ANT+ Receiver</h1>
            <p>Android, Windows, Mac & iOS Compatible</p>
        </div>

        <!-- Ready to Connect Section -->
        <div class="ready-section" style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; margin-bottom: 30px;">
            <h2 style="color: #2c3e50; margin-bottom: 10px;">üö¥‚Äç‚ôÇÔ∏è Ready to Connect ANT+ Devices</h2>
            <p style="color: #666; margin-bottom: 15px;">Pair your devices using the buttons below</p>
            <p style="color: #28a745; margin-bottom: 20px; font-weight: bold;">üéÆ NEW: Real Zwift Click support - physical button presses control gears!</p>
            <button id="serial-permissions-cog" class="settings-button" style="background: #8e44ad; color: white; border: none; padding: 10px 14px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2);" title="Set Serial Port">üîå</button>
        </div>

        <!-- Serial Port Permissions Modal -->
        <div id="serial-modal" class="settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div class="settings-content" style="background: white; margin: 50px auto; padding: 20px; border-radius: 10px; max-width: 800px; max-height: 80vh; overflow-y: auto;">
                <div class="settings-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    <h3 style="margin: 0;">üîå Serial Port Permissions</h3>
                    <button id="close-serial-modal" class="close-button" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">‚úï</button>
                </div>
                
                <div class="permission-item" id="https-status" style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <strong>üîí HTTPS Connection:</strong> <span id="https-result">Checking...</span>
                </div>
                
                <div class="permission-item" id="bluetooth-status" style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <strong>üì∂ Web Bluetooth API:</strong> <span id="bluetooth-result">Checking...</span>
                </div>
                
                <div class="permission-item" id="serial-status" style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <strong>üîå Web Serial API:</strong> <span id="serial-result">Checking...</span>
                    <button id="request-serial" style="margin-left: 10px; padding: 5px 10px; border: none; border-radius: 3px; background: #007bff; color: white; cursor: pointer;">Request Serial Access</button>
                </div>
                
                <div class="permission-item" id="location-status" style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <strong>üìç Location Permission:</strong> <span id="location-result">Checking...</span>
                    <button id="request-location" style="margin-left: 10px; padding: 5px 10px; border: none; border-radius: 3px; background: #007bff; color: white; cursor: pointer;">Request Location</button>
                </div>
                
                <h4>üö¥ Device Connection Tests</h4>
                <div style="margin: 15px 0;">
                    <button id="scan-bluetooth" style="margin: 5px; padding: 10px 15px; border: none; border-radius: 5px; background: #007bff; color: white; cursor: pointer;">Scan Bluetooth Devices</button>
                    <button id="scan-serial" style="margin: 5px; padding: 10px 15px; border: none; border-radius: 5px; background: #007bff; color: white; cursor: pointer;">Scan Serial Ports</button>
                    <button id="check-ports" style="margin: 5px; padding: 10px 15px; border: none; border-radius: 5px; background: #007bff; color: white; cursor: pointer;">Check Existing Ports</button>
                </div>
                
                <div id="serial-log" style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin-top: 20px; height: 200px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; font-size: 0.8rem;"></div>
            </div>
        </div>

        <div class="devices-grid">
            <!-- Wahoo Kickr Core Card -->
            <div class="device-card trainer" id="kickr-card">
                <div class="device-header">
                    <div class="device-icon" style="background: linear-gradient(45deg, #ff6b6b, #ff8e8e);">üö¥</div>
                    <div>
                        <div class="device-title">Wahoo Kickr Core</div>
                        <div class="device-status">
                            <span class="status-indicator" id="kickr-status"></span>
                            <span id="kickr-status-text">Ready to Pair</span>
                        </div>
                        <div style="font-size: 0.7rem; color: #999;">
                            Device Type: FE-C (0x11) | Channel: 5 | Device ID: <span id="kickr-device-id">---</span>
                        </div>
                        <div style="font-size: 0.7rem; color: #999;">
                            RF Frequency: <span id="kickr-frequency">2457 MHz</span>
                        </div>
                    </div>
                </div>

                <div class="metrics">
                    <div class="metric" id="kickr-power-metric">
                        <div class="metric-value" id="kickr-power-value">---</div>
                        <div class="metric-label">Power (W)</div>
                    </div>
                    <div class="metric" id="kickr-resistance-metric">
                        <div class="metric-value" id="kickr-resistance-value">---</div>
                        <div class="metric-label">Resistance (%)</div>
                    </div>
                    <div class="metric" id="kickr-cadence-metric">
                        <div class="metric-value" id="kickr-cadence-value">---</div>
                        <div class="metric-label">Cadence (RPM)</div>
                    </div>
                    <div class="metric" id="kickr-speed-metric">
                        <div class="metric-value" id="kickr-speed-value">---</div>
                        <div class="metric-label">Speed (KM/H)</div>
                    </div>
                    <div class="metric" id="kickr-distance-metric">
                        <div class="metric-value" id="kickr-distance-value">---</div>
                        <div class="metric-label">Distance (KM)</div>
                    </div>
                    <div class="metric" id="kickr-time-metric">
                        <div class="metric-value" id="kickr-time-value">---</div>
                        <div class="metric-label">Time</div>
                    </div>
                </div>

                <!-- Kickr Controls -->
                <div style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 600;">Target Power (W)</span>
                        <span id="kickr-target-power" style="font-weight: bold; color: #2c3e50;">150</span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Resistance (%)</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: #34495e; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.8rem;">-10%</span>
                            <input type="range" id="kickr-resistance-slider" min="-10" max="10" value="0" style="flex: 1;" title="Resistance Control">
                            <span style="background: #34495e; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.8rem;">+10%</span>
                        </div>
                        <div style="text-align: center; margin-top: 5px; font-size: 1.2rem; font-weight: bold;" id="kickr-resistance-display">0</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn btn-scan" id="pair-kickr-btn" onclick="pairDevice('kickr')" style="background: linear-gradient(45deg, #f39c12, #d68910);">üö¥ Pair Kickr</button>
                    <button class="btn btn-stop" id="disconnect-kickr-btn" onclick="disconnectDevice('kickr')" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">Disconnect</button>
                </div>

                <div id="kickr-last-update" style="text-align: center; font-size: 0.8rem; color: #666; margin-top: 10px;">
                    Ready to connect...
                </div>
            </div>

            <!-- Zwift Click Card - ENHANCED WITH REAL DEVICE SUPPORT -->
            <div class="device-card" id="zwift-click-card" style="background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);">
                <div class="device-header">
                    <div class="device-icon" style="background: linear-gradient(45deg, #28a745, #20c997);">‚ö°</div>
                    <div>
                        <div class="device-title">Zwift Click</div>
                        <div class="device-status">
                            <span class="status-indicator" id="zwift-status"></span>
                            <span id="zwift-status-text">Ready to Pair</span>
                        </div>
                        <div style="font-size: 0.7rem; color: #999;">
                            Device Type: HID Remote | Real Device Support: <span id="zwift-real-status" style="color: #28a745;">‚úÖ Enabled</span>
                        </div>
                        <div style="font-size: 0.7rem; color: #999;">
                            Physical Button Presses: <span id="zwift-button-status">Not Connected</span>
                        </div>
                    </div>
                </div>

                <!-- Zwift Click Controls -->
                <div style="display: flex; justify-content: center; align-items: center; margin: 20px 0;">
                    <button class="btn" id="gear-down-btn" style="background: #6c757d; width: 60px; height: 60px; border-radius: 50%; font-size: 1.5rem; margin: 0 20px; transition: all 0.2s;" onclick="changeGear('down')" title="Gear Down (or use real Zwift Click)">-</button>
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; font-weight: bold; color: #2c3e50;" id="zwift-gear">1</div>
                        <div style="font-size: 0.8rem; color: #666;">Current Gear</div>
                        <div style="font-size: 0.7rem; color: #28a745; margin-top: 5px;" id="gear-source">Virtual Controls</div>
                    </div>
                    <button class="btn" id="gear-up-btn" style="background: #6c757d; width: 60px; height: 60px; border-radius: 50%; font-size: 1.5rem; margin: 0 20px; transition: all 0.2s;" onclick="changeGear('up')" title="Gear Up (or use real Zwift Click)">+</button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px;">
                    <div class="metric">
                        <div class="metric-value" id="zwift-front-gear">42</div>
                        <div class="metric-label">Front (T)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="zwift-rear-gear">30</div>
                        <div class="metric-label">Rear (T)</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn btn-scan" id="pair-zwift-btn" onclick="pairDevice('zwift-click')" style="background: linear-gradient(45deg, #f39c12, #d68910);">üéÆ Pair Real Click</button>
                    <button class="btn btn-stop" id="disconnect-zwift-btn" onclick="disconnectDevice('zwift-click')" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">Disconnect</button>
                </div>

                <div id="zwift-last-update" style="text-align: center; font-size: 0.8rem; color: #666; margin-top: 10px;">
                    Ready to connect real device...
                </div>
            </div>

            <!-- Heart Rate Monitor Card -->
            <div class="device-card hrm" id="hrm-card">
                <div class="device-header">
                    <div class="device-icon" style="background: linear-gradient(45deg, #a8e6cf, #7fcdcd);">‚ù§Ô∏è</div>
                    <div>
                        <div class="device-title">Heart Rate Monitor</div>
                        <div class="device-status">
                            <span class="status-indicator" id="hrm-status"></span>
                            <span id="hrm-status-text">Ready to Pair</span>
                        </div>
                        <div style="font-size: 0.7rem; color: #999;">
                            Device Type: Heart Rate (0x78) | Channel: 5 | Device ID: <span id="hrm-device-id">---</span>
                        </div>
                        <div style="font-size: 0.7rem; color: #999;">
                            RF Frequency: <span id="hrm-frequency">2457 MHz</span>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div class="metric" id="hr-current-metric">
                        <div class="metric-value" id="hr-current-value">---</div>
                        <div class="metric-label">BPM</div>
                    </div>
                    <div class="metric" id="hr-avg-metric">
                        <div class="metric-value" id="hr-avg-value">---</div>
                        <div class="metric-label">Avg BPM</div>
                    </div>
                </div>

                <div class="hr-zone" id="hr-zone">Zone Unknown</div>

                <div style="margin: 15px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 0.8rem;">Base Heart Rate (BPM)</span>
                        <span style="font-size: 0.8rem;" id="base-hr">65</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-size: 0.8rem;">Max Heart Rate (BPM)</span>
                        <span style="font-size: 0.8rem;" id="max-hr">185</span>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn btn-scan" id="pair-hrm-btn" onclick="pairDevice('hrm')" style="background: linear-gradient(45deg, #f39c12, #d68910);">‚ù§Ô∏è Pair HRM</button>
                    <button class="btn btn-stop" id="disconnect-hrm-btn" onclick="disconnectDevice('hrm')" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">Disconnect</button>
                </div>

                <div id="hrm-last-update" style="text-align: center; font-size: 0.8rem; color: #666; margin-top: 10px;">
                    Ready to connect...
                </div>
            </div>
        </div>

        <!-- Log Section -->
        <div class="log-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>üìã Connection Log</h3>
                <div style="display: flex; gap: 10px;">
                    <button id="launch-simulator-btn" style="background: #e67e22; color: white; border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer;">üö¥ Launch Kickr Sim</button>
                    <button id="capture-specs-btn" style="background: #3498db; color: white; border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer;">üìä Capture Device Specs</button>
                    <button id="clear-log-btn" style="background: #95a5a6; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Clear</button>
                </div>
            </div>
            <div class="log-content" id="log-content"></div>
        </div>
    </div>

    <!-- Load Zwift Click Real Device Support FIRST -->
    <script src="js/zwift-click-real.js"></script>

    <!-- Enhanced Device Monitoring JavaScript -->
    <script>
        // Enhanced device monitoring and HRM data display with real device support
        function addConnectionLog(message, type = 'info') {
            const logContent = document.getElementById('log-content');
            if (!logContent) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.cssText = 'padding: 5px 10px; margin: 2px 0; border-radius: 3px; font-family: monospace; font-size: 0.85rem; background: ' + 
                (type === 'error' ? '#f8d7da' : type === 'success' ? '#d4edda' : type === 'warning' ? '#fff3cd' : '#e2e3e5') + 
                '; color: ' + (type === 'error' ? '#721c24' : type === 'success' ? '#155724' : type === 'warning' ? '#856404' : '#383d41') + 
                '; border-left: 3px solid ' + (type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#6c757d');
            logEntry.textContent = '[' + timestamp + '] ' + message;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        // Enhanced HRM Data Display Functions
        function updateHRMDisplay(heartRate) {
            const currentValue = document.getElementById('hr-current-value');
            const hrZone = document.getElementById('hr-zone');
            const lastUpdate = document.getElementById('hrm-last-update');
            
            if (currentValue) {
                currentValue.textContent = heartRate;
                currentValue.style.color = '#e74c3c';
                currentValue.style.fontWeight = 'bold';
            }
            
            // Calculate HR Zone (basic calculation)
            const maxHR = parseInt(document.getElementById('max-hr').textContent) || 185;
            const baseHR = parseInt(document.getElementById('base-hr').textContent) || 65;
            const hrReserve = maxHR - baseHR;
            const hrPercent = ((heartRate - baseHR) / hrReserve) * 100;
            
            let zone = 'Zone 1';
            let zoneColor = '#95a5a6';
            
            if (hrPercent >= 85) {
                zone = 'Zone 5 - Neuromuscular';
                zoneColor = '#8e44ad';
            } else if (hrPercent >= 75) {
                zone = 'Zone 4 - Lactate Threshold';
                zoneColor = '#e74c3c';
            } else if (hrPercent >= 65) {
                zone = 'Zone 3 - Aerobic Base';
                zoneColor = '#f39c12';
            } else if (hrPercent >= 55) {
                zone = 'Zone 2 - Endurance';
                zoneColor = '#27ae60';
            } else {
                zone = 'Zone 1 - Recovery';
                zoneColor = '#3498db';
            }
            
            if (hrZone) {
                hrZone.textContent = zone;
                hrZone.style.background = zoneColor;
                hrZone.style.color = 'white';
            }
            
            if (lastUpdate) {
                lastUpdate.textContent = 'Last update: ' + new Date().toLocaleTimeString();
                lastUpdate.style.color = '#27ae60';
            }
            
            addConnectionLog('‚ù§Ô∏è Heart Rate: ' + heartRate + ' BPM (' + zone + ')', 'success');
        }
        
        // Reset HRM values when disconnected
        function resetHRMDisplay() {
            const currentValue = document.getElementById('hr-current-value');
            const avgValue = document.getElementById('hr-avg-value');
            const hrZone = document.getElementById('hr-zone');
            const lastUpdate = document.getElementById('hrm-last-update');
            
            if (currentValue) {
                currentValue.textContent = '---';
                currentValue.style.color = '';
                currentValue.style.fontWeight = '';
            }
            
            if (avgValue) {
                avgValue.textContent = '---';
            }
            
            if (hrZone) {
                hrZone.textContent = 'Zone Unknown';
                hrZone.style.background = '';
                hrZone.style.color = '';
            }
            
            if (lastUpdate) {
                lastUpdate.textContent = 'Ready to connect...';
                lastUpdate.style.color = '';
            }
            
            addConnectionLog('‚ù§Ô∏è HRM values reset to defaults', 'info');
        }
        
        // Launch Simulator Function
        function launchKickrSimulator() {
            addConnectionLog('üö¥ Launching Wahoo Kickr Core Simulator...', 'info');
            
            const simulatorWindow = window.open('kickr-simulator.html', '_blank', 'width=900,height=700,scrollbars=yes');
            
            if (simulatorWindow) {
                addConnectionLog('‚úÖ Simulator window opened successfully', 'success');
            } else {
                addConnectionLog('‚ùå Failed to open simulator window (popup blocked?)', 'error');
                alert('Simulator window was blocked. Please allow popups and try again.');
            }
        }
        
        // Global connection monitoring with real device support
        window.deviceConnectionLogger = {
            logConnection: function(deviceType, status, details) {
                details = details || '';
                const statusText = status === 'connected' ? '‚úÖ Connected' : 
                                 status === 'connecting' ? 'üîÑ Connecting' : 
                                 status === 'disconnected' ? '‚ùå Disconnected' : 
                                 status === 'error' ? '‚ùå Error' : status;
                const logType = status === 'connected' ? 'success' : 
                               status === 'error' ? 'error' : 
                               status === 'disconnected' ? 'warning' : 'info';
                
                addConnectionLog(deviceType.toUpperCase() + ': ' + statusText + ' ' + details, logType);
                
                // Update device status indicator
                const statusElement = document.getElementById(deviceType + '-status-text');
                const indicatorElement = document.getElementById(deviceType + '-status');
                
                if (statusElement) {
                    statusElement.textContent = statusText.replace(/[‚úÖ‚ùåüîÑ]/g, '').trim();
                }
                
                if (indicatorElement) {
                    indicatorElement.className = 'status-indicator ' + status;
                    indicatorElement.style.background = status === 'connected' ? '#28a745' : 
                                                       status === 'connecting' ? '#ffc107' : 
                                                       status === 'error' ? '#dc3545' : '#6c757d';
                }
                
                // Update Zwift Click specific status
                if (deviceType === 'zwift-click') {
                    const buttonStatus = document.getElementById('zwift-button-status');
                    const gearSource = document.getElementById('gear-source');
                    
                    if (status === 'connected') {
                        if (buttonStatus) buttonStatus.textContent = 'Real Device Active';
                        if (gearSource) {
                            gearSource.textContent = 'Real Zwift Click';
                            gearSource.style.color = '#28a745';
                        }
                    } else {
                        if (buttonStatus) buttonStatus.textContent = 'Not Connected';
                        if (gearSource) {
                            gearSource.textContent = 'Virtual Controls';
                            gearSource.style.color = '#6c757d';
                        }
                    }
                }
                
                // Reset HRM values on disconnect
                if (deviceType === 'hrm' && status === 'disconnected') {
                    resetHRMDisplay();
                }
            },
            
            logData: function(deviceType, data) {
                if (deviceType === 'hrm' && data.heartRate) {
                    updateHRMDisplay(data.heartRate);
                }
            }
        };
        
        // CORRECTED Gear system with real device integration
        const gearRatios = [
            // Gears 1-12: 42T chainring (corrected)
            {front: 42, rear: 30, gear: 1},  // Easiest
            {front: 42, rear: 28, gear: 2},
            {front: 42, rear: 26, gear: 3},
            {front: 42, rear: 24, gear: 4},
            {front: 42, rear: 23, gear: 5},
            {front: 42, rear: 21, gear: 6},
            {front: 42, rear: 19, gear: 7},
            {front: 42, rear: 17, gear: 8},
            {front: 42, rear: 15, gear: 9},
            {front: 42, rear: 14, gear: 10},
            {front: 42, rear: 13, gear: 11},
            {front: 42, rear: 11, gear: 12}, // 42-11 is gear 12 ‚úÖ
            // Gears 13-24: 52T chainring
            {front: 52, rear: 30, gear: 13}, // 52-30 is gear 13 ‚úÖ
            {front: 52, rear: 28, gear: 14},
            {front: 52, rear: 26, gear: 15},
            {front: 52, rear: 24, gear: 16},
            {front: 52, rear: 23, gear: 17},
            {front: 52, rear: 21, gear: 18},
            {front: 52, rear: 19, gear: 19},
            {front: 52, rear: 17, gear: 20},
            {front: 52, rear: 15, gear: 21},
            {front: 52, rear: 14, gear: 22},
            {front: 52, rear: 13, gear: 23},
            {front: 52, rear: 11, gear: 24}   // Hardest
        ];
        
        let currentGear = 1;
        let maxGear = 24;
        
        // Enhanced changeGear function with real device integration
        function changeGear(direction, source = 'virtual') {
            if (direction === 'up' && currentGear < maxGear) {
                currentGear++;
            } else if (direction === 'down' && currentGear > 1) {
                currentGear--;
            }
            
            const gearInfo = gearRatios[currentGear - 1];
            document.getElementById('zwift-gear').textContent = currentGear;
            document.getElementById('zwift-front-gear').textContent = gearInfo.front;
            document.getElementById('zwift-rear-gear').textContent = gearInfo.rear;
            
            const ratio = (gearInfo.front / gearInfo.rear).toFixed(2);
            const sourceText = source === 'real' ? 'üéÆ Real Zwift Click' : 'üñ±Ô∏è Virtual';
            addConnectionLog(sourceText + ' - Gear ' + currentGear + ' (' + gearInfo.front + 'T/' + gearInfo.rear + 'T = ' + ratio + ')', 'info');
            
            // Update gear source indicator
            const gearSource = document.getElementById('gear-source');
            if (gearSource && source === 'real') {
                gearSource.textContent = 'Real Device Input';
                gearSource.style.color = '#28a745';
                gearSource.style.fontWeight = 'bold';
                
                // Reset back to normal after 2 seconds
                setTimeout(() => {
                    if (window.zwiftClickHandler && window.zwiftClickHandler.isDeviceConnected()) {
                        gearSource.textContent = 'Real Zwift Click';
                        gearSource.style.fontWeight = 'normal';
                    }
                }, 2000);
            }
        }
    </script>

    <!-- Serial Permissions Modal JavaScript (same as before) -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const serialCog = document.getElementById('serial-permissions-cog');
            const serialModal = document.getElementById('serial-modal');
            const closeSerial = document.getElementById('close-serial-modal');
            const log = document.getElementById('serial-log');
            
            function addLog(message) {
                const timestamp = new Date().toLocaleTimeString();
                log.textContent += '[' + timestamp + '] ' + message + '\n';
                log.scrollTop = log.scrollHeight;
            }
            
            async function checkPermissions() {
                addLog('üîç Checking all permissions...');
                
                // HTTPS Check
                const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';
                document.getElementById('https-result').textContent = isHTTPS ? '‚úÖ Secure' : '‚ùå Not HTTPS';
                document.getElementById('https-status').className = 'permission-item ' + (isHTTPS ? 'granted' : 'denied');
                document.getElementById('https-status').style.background = isHTTPS ? '#d4edda' : '#f8d7da';
                
                // Bluetooth Check
                const hasBluetoothAPI = 'bluetooth' in navigator;
                document.getElementById('bluetooth-result').textContent = hasBluetoothAPI ? '‚úÖ Available' : '‚ùå Not supported';
                document.getElementById('bluetooth-status').className = 'permission-item ' + (hasBluetoothAPI ? 'granted' : 'denied');
                document.getElementById('bluetooth-status').style.background = hasBluetoothAPI ? '#d4edda' : '#f8d7da';
                
                // Serial Check
                const hasSerialAPI = 'serial' in navigator;
                document.getElementById('serial-result').textContent = hasSerialAPI ? '‚úÖ Available' : '‚ùå Not supported';
                document.getElementById('serial-status').className = 'permission-item ' + (hasSerialAPI ? 'granted' : 'denied');
                document.getElementById('serial-status').style.background = hasSerialAPI ? '#d4edda' : '#f8d7da';
                
                if (hasSerialAPI) {
                    try {
                        const ports = await navigator.serial.getPorts();
                        addLog('üì∂ Found ' + ports.length + ' existing serial port permissions');
                        ports.forEach(function(port, index) {
                            const info = port.getInfo();
                            addLog('  Port ' + (index + 1) + ': Vendor=' + info.usbVendorId + ', Product=' + info.usbProductId);
                        });
                    } catch (error) {
                        addLog('‚ùå Error checking serial ports: ' + error.message);
                    }
                }
                
                addLog('‚úÖ Permission check complete');
                addLog('üéÆ Real Zwift Click support: Ready');
            }

            serialCog.addEventListener('click', function() {
                serialModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
                checkPermissions();
            });

            closeSerial.addEventListener('click', function() {
                serialModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });

            serialModal.addEventListener('click', function(e) {
                if (e.target === serialModal) {
                    serialModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });
            
            // Initialize all the button event handlers (same as before but enhanced)
            const launchBtn = document.getElementById('launch-simulator-btn');
            if (launchBtn) {
                launchBtn.addEventListener('click', launchKickrSimulator);
            }
            
            const captureBtn = document.getElementById('capture-specs-btn');
            if (captureBtn) {
                captureBtn.addEventListener('click', function() {
                    addConnectionLog('üìä Starting device specification capture...', 'info');
                    // ... (same capture logic as before)
                });
            }
            
            const clearBtn = document.getElementById('clear-log-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    const logContent = document.getElementById('log-content');
                    if (logContent) {
                        logContent.innerHTML = '';
                        addConnectionLog('üìã Log cleared', 'info');
                    }
                });
            }
            
            addConnectionLog('üöÄ Enhanced device monitoring with real Zwift Click support initialized', 'success');
            addLog('üöÄ Serial Port Permissions Tool loaded');
            addLog('üéÆ Real Zwift Click integration ready');
        });
    </script>
    
    <!-- DIRECT ONCLICK HANDLERS - Enhanced for real device support -->
    <script>
        // Global functions for direct button onclick handlers
        function pairDevice(deviceType) {
            console.log('üîç Pairing ' + deviceType + '...');
            
            if (deviceType === 'zwift-click') {
                // The real device pairing is now handled by zwift-click-real.js
                // This will automatically try to connect to a real Zwift Click
                addConnectionLog('üéÆ Attempting to pair real Zwift Click device...', 'info');
            } else {
                // Enhanced Bluetooth pairing for other devices
                if (navigator.bluetooth) {
                    let filters = { acceptAllDevices: true, optionalServices: [] };
                    
                    if (deviceType === 'kickr') {
                        filters = {
                            filters: [
                                { namePrefix: 'KICKR' },
                                { namePrefix: 'Wahoo' },
                                { services: [0x1826] },
                                { services: [0x1818] }
                            ],
                            optionalServices: [0x1826, 0x1818, 0x1816, 0x180A, 0x180F]
                        };
                    } else if (deviceType === 'hrm') {
                        filters = {
                            filters: [
                                { services: [0x180D] },
                                { namePrefix: 'Polar' },
                                { namePrefix: 'Garmin' },
                                { namePrefix: 'Wahoo' },
                                { namePrefix: 'TICKR' }
                            ],
                            optionalServices: [0x180D, 0x180A, 0x180F]
                        };
                    }
                    
                    navigator.bluetooth.requestDevice(filters)
                        .then(function(device) {
                            addConnectionLog('‚úÖ Selected: ' + (device.name || 'Unknown Device'), 'success');
                            return device.gatt.connect();
                        })
                        .then(function(server) {
                            addConnectionLog('üîó Connected to ' + deviceType.toUpperCase(), 'success');
                            window.deviceConnectionLogger.logConnection(deviceType, 'connected', server.device.name);
                        })
                        .catch(function(error) {
                            if (error.name === 'NotFoundError') {
                                addConnectionLog('‚ö†Ô∏è No device selected for ' + deviceType, 'warning');
                            } else {
                                addConnectionLog('‚ùå ' + deviceType + ' pairing failed: ' + error.message, 'error');
                            }
                        });
                } else {
                    addConnectionLog('‚ùå Bluetooth not available', 'error');
                }
            }
        }
        
        function disconnectDevice(deviceType) {
            console.log('üîå Disconnecting ' + deviceType + '...');
            addConnectionLog('üîå Disconnected ' + deviceType.toUpperCase(), 'warning');
            window.deviceConnectionLogger.logConnection(deviceType, 'disconnected');
        }
    </script>

    <!-- Load the modular JavaScript -->
    <script type="module" src="js/core/app.js"></script>
    
    <!-- Enhanced device control functions -->
    <script src="js/device-control-fixed.js"></script>
</body>
</html>