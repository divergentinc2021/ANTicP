<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANT+ Device Usage Checker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .log {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 5px;
            font-family: monospace;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 20px 0;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .info-box {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç ANT+ Device Usage Checker</h1>
        <p>Diagnose why WebUSB shows "Access denied" despite having permissions</p>
        
        <div class="warning-box">
            <h3>‚ö†Ô∏è Common Cause: Device In Use</h3>
            <p>The most common reason for "Access denied" with granted permissions is that another application is using the ANT+ device exclusively.</p>
        </div>

        <button class="btn" onclick="checkAuthorizedDevices()">üìã Check Authorized Devices</button>
        <button class="btn btn-danger" onclick="killANTProcesses()">üõë Kill ANT+ Processes</button>
        <button class="btn btn-success" onclick="testExclusiveAccess()">üîß Test Exclusive Access</button>
        <button class="btn" onclick="clearLog()">üóëÔ∏è Clear Log</button>
        
        <div class="info-box">
            <h3>üìã Troubleshooting Steps</h3>
            <ol>
                <li><strong>Check Authorized Devices</strong> - Verify your ANT+ stick is authorized</li>
                <li><strong>Kill ANT+ Processes</strong> - Close software that might be using the device</li>
                <li><strong>Test Exclusive Access</strong> - Attempt WebUSB connection</li>
                <li><strong>Manual Check</strong> - Close applications manually if needed</li>
            </ol>
            
            <h4>üîç Software to Close:</h4>
            <ul>
                <li><strong>Garmin Express</strong> - Often holds ANT+ device open</li>
                <li><strong>ANT+ Simulators</strong> - May have exclusive locks</li>
                <li><strong>Zwift/TrainerRoad</strong> - Training apps with ANT+ access</li>
                <li><strong>ANT Agent</strong> - Background ANT+ service</li>
                <li><strong>Suunto/Wahoo Software</strong> - Device-specific apps</li>
            </ul>
        </div>

        <div class="log" id="log">
ANT+ Device Usage Checker
=========================
This tool helps diagnose "Access denied" issues when WebUSB permissions are granted.

Click "Check Authorized Devices" to start diagnosis...
        </div>
    </div>

    <script>
        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logEl.textContent += logMessage + '\n';
            logEl.scrollTop = logEl.scrollHeight;
            console.log(logMessage);
        }

        async function checkAuthorizedDevices() {
            log('üîç Checking authorized USB devices...');
            
            try {
                const devices = await navigator.usb.getDevices();
                log(`üìä Found ${devices.length} authorized USB device(s)`);
                
                if (devices.length === 0) {
                    log('‚ùå No authorized devices found');
                    log('üí° You need to grant permissions first');
                    return;
                }
                
                const antDevices = devices.filter(device => 
                    device.vendorId === 0x0FCF || 
                    (device.productName && device.productName.toLowerCase().includes('ant'))
                );
                
                if (antDevices.length === 0) {
                    log('‚ùå No ANT+ devices in authorized list');
                    log('üí° Grant permissions to your ANT+ device first');
                    return;
                }
                
                log(`‚úÖ Found ${antDevices.length} authorized ANT+ device(s):`);
                antDevices.forEach((device, index) => {
                    log(`üì± Device ${index + 1}:`);
                    log(`   Name: ${device.productName || 'Unknown'}`);
                    log(`   Vendor: 0x${device.vendorId.toString(16).padStart(4, '0')}`);
                    log(`   Product: 0x${device.productId.toString(16).padStart(4, '0')}`);
                    log(`   Opened: ${device.opened ? 'Yes' : 'No'}`);
                    
                    if (device.opened) {
                        log(`   ‚ö†Ô∏è Device is currently OPENED by browser`);
                    }
                });
                
                log('');
                log('üí° Next: Click "Test Exclusive Access" to check if device can be opened');
                
            } catch (error) {
                log(`‚ùå Error checking devices: ${error.message}`);
            }
        }

        async function testExclusiveAccess() {
            log('üîß Testing exclusive access to ANT+ device...');
            
            try {
                const devices = await navigator.usb.getDevices();
                const antDevice = devices.find(device => device.vendorId === 0x0FCF);
                
                if (!antDevice) {
                    log('‚ùå No authorized ANT+ device found');
                    log('üí° Grant permissions first');
                    return;
                }
                
                log(`üéØ Testing device: ${antDevice.productName || 'ANT+ Device'}`);
                log('üîç Attempting to open device...');
                
                try {
                    await antDevice.open();
                    log('‚úÖ SUCCESS! Device opened successfully');
                    log('üìä Device is not in use by other software');
                    
                    // Try to claim interface
                    try {
                        if (antDevice.configuration === null) {
                            await antDevice.selectConfiguration(1);
                            log('‚öôÔ∏è Configuration selected');
                        }
                        
                        const interface0 = antDevice.configuration.interfaces[0];
                        await antDevice.claimInterface(interface0.interfaceNumber);
                        log('‚úÖ Interface claimed successfully');
                        log('üéâ WebUSB access is working properly!');
                        
                        // Clean up
                        await antDevice.releaseInterface(interface0.interfaceNumber);
                        log('üîß Interface released');
                        
                    } catch (interfaceError) {
                        log(`‚ö†Ô∏è Interface error: ${interfaceError.message}`);
                    }
                    
                    await antDevice.close();
                    log('üîå Device closed');
                    log('');
                    log('üéØ RESULT: WebUSB should work in your main application!');
                    
                } catch (openError) {
                    log(`‚ùå Failed to open device: ${openError.message}`);
                    
                    if (openError.message.includes('Access denied')) {
                        log('');
                        log('üí° Device is likely in use by another application:');
                        log('   ‚Ä¢ Check Windows Task Manager for:');
                        log('     - Garmin Express processes');
                        log('     - ANT Agent / ANT+ services');
                        log('     - Training software (Zwift, TrainerRoad)');
                        log('     - Device manufacturer software');
                        log('');
                        log('üõë Try clicking "Kill ANT+ Processes" to close common software');
                    } else if (openError.message.includes('busy')) {
                        log('');
                        log('üí° Device is busy - another application has exclusive access');
                        log('üîÑ Try unplugging and replugging the ANT+ USB stick');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`);
            }
        }

        function killANTProcesses() {
            log('üõë Attempting to identify ANT+ related processes...');
            log('');
            log('üí° MANUAL ACTION REQUIRED:');
            log('   Open Windows Task Manager (Ctrl+Shift+Esc)');
            log('   Look for and end these processes:');
            log('');
            log('üéØ Common ANT+ Processes to Close:');
            log('   ‚Ä¢ Garmin Express.exe');
            log('   ‚Ä¢ ANTAgent.exe');
            log('   ‚Ä¢ ANT Agent.exe');
            log('   ‚Ä¢ GarminCore.exe');
            log('   ‚Ä¢ Zwift.exe');
            log('   ‚Ä¢ TrainerRoad.exe');
            log('   ‚Ä¢ WahooFitnessDevice.exe');
            log('   ‚Ä¢ SuuntoLink.exe');
            log('   ‚Ä¢ Any process with "ANT" in the name');
            log('');
            log('üìã Steps:');
            log('   1. Open Task Manager');
            log('   2. Click "More details" if needed');
            log('   3. Find processes listed above');
            log('   4. Right-click ‚Üí "End task"');
            log('   5. Come back and click "Test Exclusive Access"');
            log('');
            log('‚ö†Ô∏è Note: You may need to restart these applications later');
        }

        function clearLog() {
            document.getElementById('log').textContent = 'Log cleared.\nANT+ Device Usage Checker ready...\n';
        }

        // Initial message
        log('üîç ANT+ Device Usage Checker Ready');
        log('üí° This will help diagnose "Access denied" issues');
        log('üìã Start with "Check Authorized Devices"');
    </script>
</body>
</html>
