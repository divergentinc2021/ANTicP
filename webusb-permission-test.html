<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebUSB Permission Request Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-permission {
            background: #28a745;
        }
        .btn-permission:hover {
            background: #1e7e34;
        }
        .log {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 5px;
            font-family: monospace;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 20px 0;
        }
        .permission-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê WebUSB Permission Request Test</h1>
        <p>Step-by-step WebUSB permission handling</p>
        
        <div class="permission-box">
            <h3>üîê Permission Flow</h3>
            <p><strong>Step 1:</strong> Request USB device permissions explicitly</p>
            <p><strong>Step 2:</strong> Chrome will show permission dialog</p>
            <p><strong>Step 3:</strong> Grant permissions for future use</p>
            <p><strong>Step 4:</strong> Test WebUSB connection</p>
        </div>
        
        <button class="btn btn-permission" onclick="requestUSBPermissions()">üîê Request USB Permissions</button>
        <button class="btn" onclick="testWebUSBWithPermissions()">üîå Test WebUSB Connection</button>
        <button class="btn" onclick="checkAuthorizedDevices()">üì± Check Authorized Devices</button>
        <button class="btn" onclick="clearLog()">üóëÔ∏è Clear Log</button>
        
        <div class="log" id="log">
WebUSB Permission Request Tester
================================
Step 1: Click "Request USB Permissions" to trigger permission dialog
Step 2: Grant access to your ANT+ device when prompted
Step 3: Test WebUSB connection with granted permissions

Your Chrome flags are properly enabled!
        </div>
    </div>

    <script type="module">
        let authorizedDevice = null;

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logEl.textContent += logMessage + '\n';
            logEl.scrollTop = logEl.scrollHeight;
            console.log(logMessage);
        }

        async function requestUSBPermissions() {
            log('üîê Step 1: Requesting USB device permissions...');
            
            // Check WebUSB API availability
            if (!navigator.usb) {
                log('‚ùå WebUSB API not supported', 'error');
                return;
            }
            
            try {
                log('üîç Opening device selector for permission grant...');
                log('üí° Look for "ANT USBStick2" and click "Connect"');
                
                // Request device selection - this triggers the permission dialog
                const device = await navigator.usb.requestDevice({
                    filters: [
                        { vendorId: 0x0FCF, productId: 0x1008 }, // Your ANT USB Stick 2
                        { vendorId: 0x0FCF }, // Any Garmin/Dynastream device
                    ]
                });
                
                authorizedDevice = device;
                log(`‚úÖ Permission granted for: ${device.productName || 'ANT+ Device'}`);
                log(`üìä Vendor ID: 0x${device.vendorId.toString(16).padStart(4, '0')}`);
                log(`üìä Product ID: 0x${device.productId.toString(16).padStart(4, '0')}`);
                log('');
                log('üéâ SUCCESS! USB device permissions granted');
                log('üí° Now click "Test WebUSB Connection" to verify communication');
                
            } catch (error) {
                log(`‚ùå Permission request failed: ${error.message}`, 'error');
                
                if (error.name === 'NotFoundError') {
                    log('üí° No device selected - permission not granted');
                    log('  ‚Ä¢ Make sure to select your ANT+ device');
                    log('  ‚Ä¢ Click "Connect" in the device selector');
                } else if (error.name === 'SecurityError') {
                    log('üí° Security error - check Chrome flags');
                    log('  ‚Ä¢ Ensure Experimental Web Platform features is Enabled');
                    log('  ‚Ä¢ Restart Chrome after enabling flags');
                } else if (error.name === 'NotSupportedError') {
                    log('üí° WebUSB not supported');
                    log('  ‚Ä¢ Use Chrome 61+ or Edge 79+');
                    log('  ‚Ä¢ Enable required Chrome flags');
                }
            }
        }

        async function testWebUSBWithPermissions() {
            log('üîå Step 2: Testing WebUSB connection with granted permissions...');
            
            if (!authorizedDevice) {
                log('‚ö†Ô∏è No authorized device found');
                log('üí° Please run "Request USB Permissions" first');
                return;
            }
            
            try {
                log(`üîå Opening authorized device: ${authorizedDevice.productName}`);
                
                // Try to open the already-authorized device
                await authorizedDevice.open();
                log('‚úÖ Device opened successfully - permissions working!');
                
                // Select configuration
                if (authorizedDevice.configuration === null) {
                    await authorizedDevice.selectConfiguration(1);
                    log('‚öôÔ∏è Configuration selected');
                }
                
                // Claim interface
                const interface0 = authorizedDevice.configuration.interfaces[0];
                await authorizedDevice.claimInterface(interface0.interfaceNumber);
                log(`‚úÖ Interface ${interface0.interfaceNumber} claimed`);
                
                // Find endpoints
                const alt = interface0.alternate;
                const outEndpoint = alt.endpoints.find(ep => ep.direction === 'out' && ep.type === 'bulk');
                const inEndpoint = alt.endpoints.find(ep => ep.direction === 'in' && ep.type === 'bulk');
                
                if (!outEndpoint || !inEndpoint) {
                    throw new Error('Required bulk endpoints not found');
                }
                
                log(`üì§ OUT Endpoint: ${outEndpoint.endpointNumber} (size: ${outEndpoint.packetSize})`);
                log(`üì• IN Endpoint: ${inEndpoint.endpointNumber} (size: ${inEndpoint.packetSize})`);
                
                // Send ANT+ reset command
                log('üîß Sending ANT+ reset command...');
                const resetMessage = [0xA4, 0x01, 0x4A, 0x00, 0xEF]; // ANT+ reset
                const result = await authorizedDevice.transferOut(outEndpoint.endpointNumber, new Uint8Array(resetMessage));
                
                if (result.status === 'ok') {
                    log('‚úÖ ANT+ reset command sent successfully');
                    log(`üì§ Sent: ${resetMessage.map(b => b.toString(16).padStart(2, '0')).join(' ')}`);
                } else {
                    log(`‚ö†Ô∏è Transfer status: ${result.status}`);
                }
                
                // Try to read response with timeout
                log('üëÇ Listening for ANT+ response...');
                try {
                    const readResult = await Promise.race([
                        authorizedDevice.transferIn(inEndpoint.endpointNumber, 64),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 2000))
                    ]);
                    
                    if (readResult.data && readResult.data.byteLength > 0) {
                        const data = new Uint8Array(readResult.data.buffer);
                        const hex = Array.from(data).map(b => b.toString(16).padStart(2, '0')).join(' ');
                        log(`üì¶ ANT+ Response: ${hex}`);
                    }
                } catch (readError) {
                    if (readError.message === 'Timeout') {
                        log('‚è±Ô∏è No immediate response (normal for reset command)');
                    } else {
                        log(`‚ö†Ô∏è Read error: ${readError.message}`);
                    }
                }
                
                // Clean up
                await authorizedDevice.releaseInterface(interface0.interfaceNumber);
                await authorizedDevice.close();
                log('üîå Device closed successfully');
                
                log('');
                log('üéâ COMPLETE SUCCESS!', 'success');
                log('‚úÖ WebUSB permissions working');
                log('‚úÖ USB device communication established');
                log('‚úÖ ANT+ protocol communication confirmed');
                log('‚úÖ Ready for full ANT+ implementation');
                
            } catch (error) {
                log(`‚ùå WebUSB test failed: ${error.message}`, 'error');
                
                if (error.message.includes('Access denied')) {
                    log('üí° Still getting access denied:');
                    log('  ‚Ä¢ Try requesting permissions again');
                    log('  ‚Ä¢ Check if device is in use by other software');
                    log('  ‚Ä¢ Restart Chrome completely');
                } else if (error.name === 'NetworkError') {
                    log('üí° Device communication error:');
                    log('  ‚Ä¢ Device may be disconnected');
                    log('  ‚Ä¢ Try unplugging and reconnecting USB stick');
                    log('  ‚Ä¢ Close other ANT+ software');
                }
            }
        }

        async function checkAuthorizedDevices() {
            log('üì± Checking previously authorized USB devices...');
            
            if (!navigator.usb) {
                log('‚ùå WebUSB API not available');
                return;
            }
            
            try {
                const devices = await navigator.usb.getDevices();
                log(`üìä Found ${devices.length} authorized USB device(s)`);
                
                if (devices.length === 0) {
                    log('‚ÑπÔ∏è No devices currently authorized');
                    log('üí° Use "Request USB Permissions" to authorize your ANT+ device');
                } else {
                    devices.forEach((device, index) => {
                        log(`üì± Device ${index + 1}:`);
                        log(`   Name: ${device.productName || 'Unknown'}`);
                        log(`   Vendor: 0x${device.vendorId.toString(16).padStart(4, '0')}`);
                        log(`   Product: 0x${device.productId.toString(16).padStart(4, '0')}`);
                        
                        // Check if this is our ANT+ device
                        if (device.vendorId === 0x0FCF && device.productId === 0x1008) {
                            log('   ‚úÖ This is your ANT USB Stick 2!');
                            authorizedDevice = device;
                        }
                    });
                }
                
            } catch (error) {
                log(`‚ùå Error checking devices: ${error.message}`);
            }
        }

        function clearLogContent() {
            document.getElementById('log').textContent = 'Log cleared.\nReady for WebUSB permission testing...\n';
            authorizedDevice = null;
        }

        // Make functions available globally
        window.requestUSBPermissions = requestUSBPermissions;
        window.testWebUSBWithPermissions = testWebUSBWithPermissions;
        window.checkAuthorizedDevices = checkAuthorizedDevices;
        window.clearLog = clearLogContent;

        // Initial setup
        log('üîê WebUSB Permission Tester Ready');
        log('üìã Your Chrome flags are properly configured!');
        log('');
        log('üí° Next steps:');
        log('1. Click "Request USB Permissions" to trigger permission dialog');
        log('2. Select your "ANT USBStick2" and click "Connect"');
        log('3. Click "Test WebUSB Connection" to verify communication');
        log('');
        log('üéØ This will establish permanent USB device permissions');

        // Auto-check for already authorized devices
        setTimeout(checkAuthorizedDevices, 1000);
    </script>
</body>
</html>
