<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANT+ Middleware Bridge Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #6c757d; cursor: not-allowed; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-warning:hover { background: #e0a800; }
        
        .status-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .status-connected { background: #28a745; }
        .status-disconnected { background: #dc3545; }
        .status-connecting { background: #ffc107; }
        
        .log {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 5px;
            font-family: monospace;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 20px 0;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .solution-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .info-box {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .data-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .device-card {
            background: #fff;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        
        .device-card.active {
            border-color: #28a745;
            background: #f8fff9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåâ ANT+ Middleware Bridge Solution</h1>
        <p>Bypasses WebUSB libusbK limitations using Node.js bridge server</p>
        
        <div class="solution-box">
            <h3>‚úÖ Middleware Bridge Approach</h3>
            <p><strong>How it works:</strong></p>
            <ul>
                <li><strong>Bridge Server:</strong> Node.js server handles ANT+ device directly</li>
                <li><strong>WebSocket:</strong> Browser connects to local server (ws://localhost:8888)</li>
                <li><strong>Python Handler:</strong> Uses PySerial to access ANT+ via COM ports</li>
                <li><strong>No WebUSB:</strong> Completely bypasses libusbK driver issues</li>
            </ul>
        </div>

        <div class="status-panel">
            <h3>üìä Connection Status</h3>
            <div id="bridge-status">
                <span class="status-indicator status-disconnected"></span>
                Bridge Server: <span id="bridge-text">Disconnected</span>
            </div>
            <div id="ant-status" style="margin-top: 10px;">
                <span class="status-indicator status-disconnected"></span>
                ANT+ Device: <span id="ant-text">Disconnected</span>
            </div>
        </div>

        <div class="info-box">
            <h3>üìã Setup Instructions</h3>
            <ol>
                <li><strong>Install Node.js:</strong> Download from nodejs.org (if not installed)</li>
                <li><strong>Install Python:</strong> Download from python.org (if not installed)</li>
                <li><strong>Install PySerial:</strong> Run <code>pip install pyserial</code></li>
                <li><strong>Start Bridge Server:</strong> Run <code>node ant-bridge-server.js</code></li>
                <li><strong>Connect Browser:</strong> Click "Connect to Bridge" below</li>
            </ol>
        </div>

        <div class="controls">
            <button class="btn" onclick="connectToBridge()" id="bridge-btn">üåâ Connect to Bridge</button>
            <button class="btn btn-success" onclick="connectANT(50000)" disabled id="ant-50k-btn">‚ö° 50K Hz</button>
            <button class="btn btn-success" onclick="connectANT(57600)" disabled id="ant-57k-btn">‚ö° 57.6K Hz</button>
            <button class="btn btn-success" onclick="connectANT(115200)" disabled id="ant-115k-btn">‚ö° 115.2K Hz</button>
            <button class="btn btn-success" onclick="connectANT(2000000)" disabled id="ant-2m-btn">üöÄ 2MHz</button>
            <button class="btn btn-success" onclick="connectANT(3000000)" disabled id="ant-3m-btn">üí® 3MHz</button>
            <button class="btn btn-danger" onclick="disconnectANT()" disabled id="disconnect-btn">üîå Disconnect ANT+</button>
            <button class="btn" onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div class="data-panel">
            <div class="device-card" id="trainer-card">
                <h4>üö¥ Trainer/FE-C</h4>
                <div id="trainer-data">No data</div>
            </div>
            <div class="device-card" id="hr-card">
                <h4>‚ù§Ô∏è Heart Rate</h4>
                <div id="hr-data">No data</div>
            </div>
            <div class="device-card" id="power-card">
                <h4>‚ö° Power Meter</h4>
                <div id="power-data">No data</div>
            </div>
        </div>

        <div class="log" id="log">
ANT+ Middleware Bridge Test
===========================
This solution completely bypasses WebUSB and libusbK driver issues.

Setup Steps:
1. Install Node.js and Python (if needed)
2. Run: pip install pyserial
3. Start bridge server: node ant-bridge-server.js
4. Click "Connect to Bridge" below

Waiting for bridge server connection...
        </div>
    </div>

    <script type="module">
        import { ANTBridgeClient } from './js/connections/ant-bridge-client.js';

        let bridge = null;
        let bridgeConnected = false;
        let antConnected = false;

        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logEl.textContent += logMessage + '\n';
            logEl.scrollTop = logEl.scrollHeight;
            console.log(logMessage);
        }

        function updateBridgeStatus(connected, text) {
            const indicator = document.querySelector('#bridge-status .status-indicator');
            const textEl = document.getElementById('bridge-text');
            
            indicator.className = `status-indicator status-${connected ? 'connected' : 'disconnected'}`;
            textEl.textContent = text;
            bridgeConnected = connected;
            updateButtons();
        }

        function updateANTStatus(connected, text) {
            const indicator = document.querySelector('#ant-status .status-indicator');
            const textEl = document.getElementById('ant-text');
            
            indicator.className = `status-indicator status-${connected ? 'connected' : 'disconnected'}`;
            textEl.textContent = text;
            antConnected = connected;
            updateButtons();
        }

        function updateButtons() {
            const bridgeBtn = document.getElementById('bridge-btn');
            const antButtons = ['ant-50k-btn', 'ant-57k-btn', 'ant-115k-btn', 'ant-2m-btn', 'ant-3m-btn'];
            const disconnectBtn = document.getElementById('disconnect-btn');

            // Bridge button
            bridgeBtn.disabled = bridgeConnected;
            bridgeBtn.textContent = bridgeConnected ? '‚úÖ Bridge Connected' : 'üåâ Connect to Bridge';

            // ANT+ buttons
            antButtons.forEach(id => {
                const btn = document.getElementById(id);
                btn.disabled = !bridgeConnected || antConnected;
            });

            // Disconnect button
            disconnectBtn.disabled = !antConnected;
        }

        function updateDeviceCard(cardId, data, active = true) {
            const card = document.getElementById(cardId);
            if (active) {
                card.classList.add('active');
            }
            
            const dataEl = card.querySelector('div');
            dataEl.innerHTML = data;
        }

        async function connectToBridge() {
            try {
                log('üåâ Connecting to ANT+ Bridge server...');
                updateBridgeStatus(false, 'Connecting...');

                // Check if bridge server is running
                const serverRunning = await ANTBridgeClient.checkBridgeServer();
                if (!serverRunning) {
                    log('‚ùå Bridge server not running');
                    log('üí° Start the bridge server first:');
                    log('   1. Open terminal/command prompt');
                    log('   2. Navigate to project directory');
                    log('   3. Run: node ant-bridge-server.js');
                    log('   4. Wait for "Bridge server running" message');
                    log('   5. Then click "Connect to Bridge" here');
                    updateBridgeStatus(false, 'Server not running');
                    return;
                }

                bridge = new ANTBridgeClient();

                // Set up event listeners
                bridge.on('bridge-connected', () => {
                    log('‚úÖ Connected to bridge server');
                    updateBridgeStatus(true, 'Connected');
                });

                bridge.on('bridge-disconnected', () => {
                    log('üîå Bridge server disconnected');
                    updateBridgeStatus(false, 'Disconnected');
                    updateANTStatus(false, 'Disconnected');
                });

                bridge.on('ant-connecting', (data) => {
                    log(`üîå ${data.message}`);
                    updateANTStatus(false, 'Connecting...');
                });

                bridge.on('ant-connected', (data) => {
                    log(`‚úÖ ANT+ connected: ${data.message}`);
                    updateANTStatus(true, `Connected @ ${data.rate} Hz`);
                });

                bridge.on('ant-disconnected', (data) => {
                    log(`üîå ANT+ disconnected: ${data.message}`);
                    updateANTStatus(false, 'Disconnected');
                    
                    // Clear device cards
                    updateDeviceCard('trainer-card', 'No data', false);
                    updateDeviceCard('hr-card', 'No data', false);
                    updateDeviceCard('power-card', 'No data', false);
                });

                bridge.on('trainer-data', (data) => {
                    log(`üö¥ Trainer: ${data.power}W, ${data.speed.toFixed(1)}km/h (Ch${data.channel}, Rate: ${data.rate}Hz)`);
                    updateDeviceCard('trainer-card', `
                        <strong>Power:</strong> ${data.power} watts<br>
                        <strong>Speed:</strong> ${data.speed.toFixed(1)} km/h<br>
                        <strong>Device ID:</strong> ${data.deviceId}<br>
                        <strong>Channel:</strong> ${data.channel}<br>
                        <strong>Rate:</strong> ${data.rate} Hz
                    `);
                });

                bridge.on('heart-rate-data', (data) => {
                    log(`‚ù§Ô∏è Heart Rate: ${data.heartRate} BPM (Ch${data.channel}, Rate: ${data.rate}Hz)`);
                    updateDeviceCard('hr-card', `
                        <strong>Heart Rate:</strong> ${data.heartRate} BPM<br>
                        <strong>Device ID:</strong> ${data.deviceId}<br>
                        <strong>Channel:</strong> ${data.channel}<br>
                        <strong>Rate:</strong> ${data.rate} Hz
                    `);
                });

                bridge.on('power-data', (data) => {
                    log(`‚ö° Power: ${data.power}W, Cadence: ${data.cadence} RPM (Ch${data.channel}, Rate: ${data.rate}Hz)`);
                    updateDeviceCard('power-card', `
                        <strong>Power:</strong> ${data.power} watts<br>
                        <strong>Cadence:</strong> ${data.cadence} RPM<br>
                        <strong>Device ID:</strong> ${data.deviceId}<br>
                        <strong>Channel:</strong> ${data.channel}<br>
                        <strong>Rate:</strong> ${data.rate} Hz
                    `);
                });

                bridge.on('device-data', (data) => {
                    if (!data.trainer && !data.heart_rate && !data.power) {
                        log(`üì° Device: Type ${data.deviceType}, ID ${data.deviceId} (Ch${data.channel}, Rate: ${data.rate}Hz)`);
                    }
                });

                bridge.on('ant-event', (data) => {
                    log(`üì° ANT+ Event: Ch${data.channel}, Code ${data.event_code} (Rate: ${data.rate}Hz)`);
                });

                bridge.on('error', (error) => {
                    log(`‚ùå Error: ${error.message || error.error}`);
                });

                // Connect to bridge server
                await bridge.connect();

            } catch (error) {
                log(`‚ùå Failed to connect to bridge: ${error.message}`);
                updateBridgeStatus(false, 'Connection failed');
            }
        }

        async function connectANT(rate) {
            if (!bridge || !bridgeConnected) {
                log('‚ùå Bridge server not connected');
                return;
            }

            try {
                log(`üîå Connecting to ANT+ device at ${rate} Hz...`);
                await bridge.connectANT(rate);
            } catch (error) {
                log(`‚ùå Failed to connect ANT+: ${error.message}`);
            }
        }

        async function disconnectANT() {
            if (!bridge || !antConnected) {
                log('‚ùå ANT+ device not connected');
                return;
            }

            try {
                log('üîå Disconnecting ANT+ device...');
                await bridge.disconnectANT();
            } catch (error) {
                log(`‚ùå Failed to disconnect ANT+: ${error.message}`);
            }
        }

        function clearLog() {
            document.getElementById('log').textContent = 'Log cleared.\nANT+ Middleware Bridge ready...\n';
        }

        // Make functions available globally
        window.connectToBridge = connectToBridge;
        window.connectANT = connectANT;
        window.disconnectANT = disconnectANT;
        window.clearLog = clearLog;

        // Initial setup
        updateButtons();
        log('üåâ ANT+ Middleware Bridge Test Ready');
        log('üí° This solution bypasses WebUSB completely');
        log('üîß Uses Node.js + Python to access ANT+ directly');
        log('üìã Start bridge server first, then click "Connect to Bridge"');
    </script>
</body>
</html>
