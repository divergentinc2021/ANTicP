<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Cross-Platform Bluetooth ANT+ Receiver</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .enhanced-card {
            border: 2px solid #28a745;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
        }
        .auto-connect-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📡 Enhanced Cross-Platform Bluetooth ANT+ Receiver</h1>
            <p>Auto-Connect + Real Device Support - Android, Windows, Mac & iOS Compatible</p>
        </div>

        <!-- Enhanced Ready to Connect Section -->
        <div class="ready-section auto-connect-pulse" style="text-align: center; padding: 25px; background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); border-radius: 15px; margin-bottom: 30px; border: 2px solid #28a745;">
            <h2 style="color: #155724; margin-bottom: 15px;">🚴‍♂️ Enhanced Auto-Connect System</h2>
            <p style="color: #155724; margin-bottom: 10px;">Automatic Bluetooth Serial Detection & Real Device Integration</p>
            <p style="color: #28a745; margin-bottom: 25px; font-weight: bold; font-size: 1.1rem;">🎮 Features: Real Zwift Click + Auto Serial Bridge + Device Simulator</p>
            <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                <button id="auto-connect-btn" class="settings-button" style="background: linear-gradient(45deg, #28a745, #20c997); color: white; border: none; padding: 15px 30px; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 1.2rem; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);" title="Auto Connect All Devices">🚀 Auto Connect All</button>
                <button id="serial-permissions-cog" class="settings-button" style="background: linear-gradient(45deg, #8e44ad, #9b59b6); color: white; border: none; padding: 15px 20px; border-radius: 50%; cursor: pointer; font-size: 1.3rem; box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3);" title="Enhanced Device Manager">⚙️</button>
            </div>
            <div style="font-size: 0.9rem; color: #666;">Click "Auto Connect All" to automatically discover and pair all your fitness devices</div>
        </div>

        <!-- Auto Connect Status Bar -->
        <div id="auto-connect-status" style="display: none; background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); border: 2px solid #28a745; padding: 20px; border-radius: 15px; margin-bottom: 25px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div id="auto-connect-spinner" style="width: 25px; height: 25px; border: 3px solid #28a745; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <div style="flex: 1;">
                    <div style="font-weight: bold; color: #155724; font-size: 1.1rem;">🤖 Auto-Connecting Devices...</div>
                    <div id="auto-connect-progress" style="font-size: 1rem; color: #28a745; margin-top: 5px;">Initializing enhanced connection system...</div>
                </div>
            </div>
        </div>

        <!-- Enhanced Device Manager Modal -->
        <div id="serial-modal" class="settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000;">
            <div class="settings-content" style="background: white; margin: 30px auto; padding: 25px; border-radius: 15px; max-width: 950px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <div class="settings-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #28a745; padding-bottom: 15px;">
                    <h3 style="margin: 0; color: #28a745; font-size: 1.5rem;">🚀 Enhanced Device Manager</h3>
                    <button id="close-serial-modal" class="close-button" style="background: #dc3545; color: white; border: none; font-size: 1.2rem; cursor: pointer; padding: 8px 12px; border-radius: 50%;">✕</button>
                </div>
                
                <!-- Enhanced System Status -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div class="permission-item" id="https-status" style="padding: 15px; border: 2px solid #ddd; border-radius: 10px; text-align: center; background: #f8f9fa;">
                        <div style="font-size: 1.5rem; margin-bottom: 5px;">🔒</div>
                        <strong>HTTPS Security</strong><br>
                        <span id="https-result" style="font-weight: bold;">Checking...</span>
                    </div>
                    <div class="permission-item" id="bluetooth-status" style="padding: 15px; border: 2px solid #ddd; border-radius: 10px; text-align: center; background: #f8f9fa;">
                        <div style="font-size: 1.5rem; margin-bottom: 5px;">📶</div>
                        <strong>Bluetooth API</strong><br>
                        <span id="bluetooth-result" style="font-weight: bold;">Checking...</span>
                    </div>
                    <div class="permission-item" id="serial-status" style="padding: 15px; border: 2px solid #ddd; border-radius: 10px; text-align: center; background: #f8f9fa;">
                        <div style="font-size: 1.5rem; margin-bottom: 5px;">🔌</div>
                        <strong>Serial Bridge</strong><br>
                        <span id="serial-result" style="font-weight: bold;">Checking...</span>
                    </div>
                    <div class="permission-item" id="location-status" style="padding: 15px; border: 2px solid #ddd; border-radius: 10px; text-align: center; background: #f8f9fa;">
                        <div style="font-size: 1.5rem; margin-bottom: 5px;">📍</div>
                        <strong>Location Access</strong><br>
                        <span id="location-result" style="font-weight: bold;">Checking...</span>
                    </div>
                </div>
                
                <!-- Enhanced Auto Connect Features -->
                <div style="background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid #28a745;">
                    <h4 style="margin-top: 0; color: #155724; font-size: 1.3rem;">🤖 Enhanced Auto-Connection System</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px;">
                        <button id="auto-pair-bluetooth-serial" style="padding: 12px 16px; border: none; border-radius: 8px; background: linear-gradient(45deg, #007bff, #0056b3); color: white; cursor: pointer; font-weight: bold;">🔗 Auto Pair Serial</button>
                        <button id="scan-available-devices" style="padding: 12px 16px; border: none; border-radius: 8px; background: linear-gradient(45deg, #28a745, #1e7e34); color: white; cursor: pointer; font-weight: bold;">📡 Scan All Devices</button>
                        <button id="test-kickr-simulator" style="padding: 12px 16px; border: none; border-radius: 8px; background: linear-gradient(45deg, #e67e22, #d35400); color: white; cursor: pointer; font-weight: bold;">🚴 Launch Simulator</button>
                        <button id="reset-connections" style="padding: 12px 16px; border: none; border-radius: 8px; background: linear-gradient(45deg, #dc3545, #c82333); color: white; cursor: pointer; font-weight: bold;">🔄 Reset All</button>
                    </div>
                    <div id="bluetooth-serial-status" style="font-size: 1rem; color: #155724; text-align: center; font-weight: bold;">Enhanced auto-pairing system ready - supports multiple device types</div>
                </div>
                
                <!-- Manual Testing Tools -->
                <h4 style="color: #495057;">🔧 Manual Testing & Diagnostics</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <button id="scan-bluetooth" style="padding: 10px 14px; border: none; border-radius: 6px; background: #007bff; color: white; cursor: pointer;">🔍 Scan BT</button>
                    <button id="scan-serial" style="padding: 10px 14px; border: none; border-radius: 6px; background: #007bff; color: white; cursor: pointer;">🔌 Get Serial</button>
                    <button id="check-ports" style="padding: 10px 14px; border: none; border-radius: 6px; background: #007bff; color: white; cursor: pointer;">📋 Check Ports</button>
                    <button id="test-permissions" style="padding: 10px 14px; border: none; border-radius: 6px; background: #6c757d; color: white; cursor: pointer;">🔐 Test Perms</button>
                    <button id="simulate-device" style="padding: 10px 14px; border: none; border-radius: 6px; background: #17a2b8; color: white; cursor: pointer;">🎭 Simulate</button>
                    <button id="export-logs" style="padding: 10px 14px; border: none; border-radius: 6px; background: #6f42c1; color: white; cursor: pointer;">📤 Export</button>
                </div>
                
                <div id="serial-log" style="background: #2d3748; color: #e2e8f0; border: 2px solid #4a5568; padding: 20px; margin-top: 20px; height: 280px; overflow-y: auto; font-family: 'Courier New', monospace; white-space: pre-wrap; font-size: 0.85rem; border-radius: 8px;"></div>
            </div>
        </div>

        <div class="devices-grid">
            <!-- Enhanced Wahoo Kickr Core Card -->
            <div class="device-card trainer enhanced-card" id="kickr-card">
                <div class="device-header">
                    <div class="device-icon" style="background: linear-gradient(45deg, #ff6b6b, #ff8e8e); font-size: 1.5rem;">🚴</div>
                    <div>
                        <div class="device-title" style="font-size: 1.2rem;">Enhanced Wahoo Kickr Core</div>
                        <div class="device-status">
                            <span class="status-indicator" id="kickr-status"></span>
                            <span id="kickr-status-text" style="font-weight: bold;">Auto-Connect Ready</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #28a745; font-weight: bold;">
                            🔧 Enhanced: Auto-Pairing + Serial Bridge + Simulator Support
                        </div>
                        <div style="font-size: 0.75rem; color: #666;">
                            Connection: <span id="kickr-connection-type" style="color: #28a745; font-weight: bold;">Auto-Serial Bridge</span> | Device: <span id="kickr-device-id">Scanning...</span>
                        </div>
                    </div>
                </div>

                <div class="metrics">
                    <div class="metric" id="kickr-power-metric">
                        <div class="metric-value" id="kickr-power-value" style="color: #e74c3c;">---</div>
                        <div class="metric-label">Power (W)</div>
                    </div>
                    <div class="metric" id="kickr-resistance-metric">
                        <div class="metric-value" id="kickr-resistance-value" style="color: #f39c12;">---</div>
                        <div class="metric-label">Resistance (%)</div>
                    </div>
                    <div class="metric" id="kickr-cadence-metric">
                        <div class="metric-value" id="kickr-cadence-value" style="color: #3498db;">---</div>
                        <div class="metric-label">Cadence (RPM)</div>
                    </div>
                    <div class="metric" id="kickr-speed-metric">
                        <div class="metric-value" id="kickr-speed-value" style="color: #9b59b6;">---</div>
                        <div class="metric-label">Speed (KM/H)</div>
                    </div>
                    <div class="metric" id="kickr-distance-metric">
                        <div class="metric-value" id="kickr-distance-value" style="color: #1abc9c;">0.0</div>
                        <div class="metric-label">Distance (KM)</div>
                    </div>
                    <div class="metric" id="kickr-time-metric">
                        <div class="metric-value" id="kickr-time-value" style="color: #34495e;">00:00</div>
                        <div class="metric-label">Time</div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-weight: 600; color: #2c3e50;">Target Power (W)</span>
                        <span id="kickr-target-power" style="font-weight: bold; color: #e74c3c; font-size: 1.1rem;">150</span>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block; color: #2c3e50;">Enhanced Resistance Control</label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="background: #34495e; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">-10%</span>
                            <input type="range" id="kickr-resistance-slider" min="-10" max="10" value="0" style="flex: 1; height: 8px; border-radius: 4px;" title="Enhanced Resistance Control">
                            <span style="background: #34495e; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">+10%</span>
                        </div>
                        <div style="text-align: center; margin-top: 8px; font-size: 1.4rem; font-weight: bold; color: #2c3e50;" id="kickr-resistance-display">0</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button class="btn btn-scan" id="pair-kickr-btn" onclick="pairDevice('kickr')" style="background: linear-gradient(45deg, #28a745, #20c997); font-weight: bold; font-size: 1rem;">🚴 Auto-Pair Kickr</button>
                    <button class="btn btn-stop" id="disconnect-kickr-btn" onclick="disconnectDevice('kickr')" style="background: linear-gradient(45deg, #dc3545, #c82333); font-weight: bold;">Disconnect</button>
                </div>

                <div id="kickr-last-update" style="text-align: center; font-size: 0.85rem; color: #28a745; margin-top: 12px; font-weight: bold;">
                    🚀 Enhanced auto-connect ready - supports real devices & simulators
                </div>
            </div>

            <!-- Enhanced Zwift Click Card -->
            <div class="device-card enhanced-card" id="zwift-click-card" style="background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); border: 2px solid #28a745;">
                <div class="device-header">
                    <div class="device-icon" style="background: linear-gradient(45deg, #28a745, #20c997); font-size: 1.5rem;">⚡</div>
                    <div>
                        <div class="device-title" style="font-size: 1.2rem;">Enhanced Zwift Click</div>
                        <div class="device-status">
                            <span class="status-indicator" id="zwift-status"></span>
                            <span id="zwift-status-text" style="font-weight: bold;">Auto-Connect Ready</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #155724; font-weight: bold;">
                            🎮 Real Device Support: <span id="zwift-real-status" style="color: #28a745;">✅ Physical Button Detection</span>
                        </div>
                        <div style="font-size: 0.75rem; color: #666;">
                            Button Status: <span id="zwift-button-status" style="color: #28a745; font-weight: bold;">Enhanced Auto-Connect Ready</span>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Zwift Click Controls -->
                <div style="display: flex; justify-content: center; align-items: center; margin: 25px 0;">
                    <button class="btn" id="gear-down-btn" style="background: linear-gradient(45deg, #6c757d, #5a6268); width: 70px; height: 70px; border-radius: 50%; font-size: 2rem; margin: 0 25px; transition: all 0.3s; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2);" onclick="changeGear('down')" title="Gear Down (Physical or Virtual)">-</button>
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; font-weight: bold; color: #2c3e50; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);" id="zwift-gear">1</div>
                        <div style="font-size: 0.9rem; color: #666; font-weight: bold;">Current Gear</div>
                        <div style="font-size: 0.8rem; color: #28a745; margin-top: 8px; font-weight: bold;" id="gear-source">🤖 Enhanced Auto-Connect</div>
                    </div>
                    <button class="btn" id="gear-up-btn" style="background: linear-gradient(45deg, #6c757d, #5a6268); width: 70px; height: 70px; border-radius: 50%; font-size: 2rem; margin: 0 25px; transition: all 0.3s; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2);" onclick="changeGear('up')" title="Gear Up (Physical or Virtual)">+</button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <div class="metric" style="background: rgba(255,255,255,0.7);">
                        <div class="metric-value" id="zwift-front-gear" style="color: #2c3e50; font-weight: bold;">42</div>
                        <div class="metric-label" style="color: #34495e;">Front (T)</div>
                    </div>
                    <div class="metric" style="background: rgba(255,255,255,0.7);">
                        <div class="metric-value" id="zwift-rear-gear" style="color: #2c3e50; font-weight: bold;">30</div>
                        <div class="metric-label" style="color: #34495e;">Rear (T)</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button class="btn btn-scan" id="pair-zwift-btn" onclick="pairDevice('zwift-click')" style="background: linear-gradient(45deg, #28a745, #20c997); font-weight: bold; font-size: 1rem;">🎮 Auto-Pair Click</button>
                    <button class="btn btn-stop" id="disconnect-zwift-btn" onclick="disconnectDevice('zwift-click')" style="background: linear-gradient(45deg, #dc3545, #c82333); font-weight: bold;">Disconnect</button>
                </div>

                <div id="zwift-last-update" style="text-align: center; font-size: 0.85rem; color: #155724; margin-top: 12px; font-weight: bold;">
                    ⚡ Enhanced real device integration ready
                </div>
            </div>

            <!-- Enhanced Heart Rate Monitor Card -->
            <div class="device-card hrm enhanced-card" id="hrm-card">
                <div class="device-header">
                    <div class="device-icon" style="background: linear-gradient(45deg, #e74c3c, #c0392b); font-size: 1.5rem;">❤️</div>
                    <div>
                        <div class="device-title" style="font-size: 1.2rem;">Enhanced Heart Rate Monitor</div>
                        <div class="device-status">
                            <span class="status-indicator" id="hrm-status"></span>
                            <span id="hrm-status-text" style="font-weight: bold;">Auto-Connect Ready</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #c0392b; font-weight: bold;">
                            💓 Enhanced: Multi-Brand Support + Zone Analysis
                        </div>
                        <div style="font-size: 0.75rem; color: #666;">
                            Connection: <span id="hrm-connection-type" style="color: #e74c3c; font-weight: bold;">Auto-Serial Bridge</span> | Device: <span id="hrm-device-id">Scanning...</span>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <div class="metric" id="hr-current-metric">
                        <div class="metric-value" id="hr-current-value" style="color: #e74c3c; font-size: 2.5rem;">---</div>
                        <div class="metric-label">Current BPM</div>
                    </div>
                    <div class="metric" id="hr-avg-metric">
                        <div class="metric-value" id="hr-avg-value" style="color: #f39c12;">---</div>
                        <div class="metric-label">Average BPM</div>
                    </div>
                </div>

                <div class="hr-zone" id="hr-zone" style="padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; font-size: 1.1rem; margin-bottom: 15px;">Enhanced Zone Analysis</div>

                <div style="margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-size: 0.9rem; color: #34495e; font-weight: bold;">Resting HR (BPM)</span>
                        <span style="font-size: 0.9rem; font-weight: bold; color: #3498db;" id="base-hr">65</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="font-size: 0.9rem; color: #34495e; font-weight: bold;">Max HR (BPM)</span>
                        <span style="font-size: 0.9rem; font-weight: bold; color: #e74c3c;" id="max-hr">185</span>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button class="btn btn-scan" id="pair-hrm-btn" onclick="pairDevice('hrm')" style="background: linear-gradient(45deg, #e74c3c, #c0392b); font-weight: bold; font-size: 1rem;">❤️ Auto-Pair HRM</button>
                    <button class="btn btn-stop" id="disconnect-hrm-btn" onclick="disconnectDevice('hrm')" style="background: linear-gradient(45deg, #dc3545, #c82333); font-weight: bold;">Disconnect</button>
                </div>

                <div id="hrm-last-update" style="text-align: center; font-size: 0.85rem; color: #c0392b; margin-top: 12px; font-weight: bold;">
                    💓 Enhanced multi-brand auto-connect ready
                </div>
            </div>
        </div>

        <!-- Enhanced Log Section -->
        <div class="log-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #dee2e6; border-radius: 15px; padding: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #2c3e50; font-size: 1.4rem;">📋 Enhanced Connection Log</h3>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button id="launch-simulator-btn" style="background: linear-gradient(45deg, #e67e22, #d35400); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">🚴 Enhanced Simulator</button>
                    <button id="capture-specs-btn" style="background: linear-gradient(45deg, #3498db, #2980b9); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">📊 Capture Specs</button>
                    <button id="export-session-btn" style="background: linear-gradient(45deg, #9b59b6, #8e44ad); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">📤 Export Session</button>
                    <button id="clear-log-btn" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">🗑️ Clear</button>
                </div>
            </div>
            <div class="log-content" id="log-content" style="background: #2d3748; color: #e2e8f0; padding: 20px; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 0.9rem; max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Load Enhanced Zwift Click Real Device Support -->
    <script src="js/zwift-click-real.js"></script>

    <!-- Enhanced Auto Connect Management System -->
    <script>
        class EnhancedAutoConnectManager {
            constructor() {
                this.deviceQueue = ['hrm', 'kickr', 'zwift-click'];
                this.connectedDevices = new Set();
                this.autoConnectInProgress = false;
                this.bluetoothSerialPorts = new Map();
                this.simulatedDevices = new Map();
                this.connectionRetries = new Map();
                this.maxRetries = 3;
            }

            async startEnhancedAutoConnect() {
                if (this.autoConnectInProgress) return;
                
                this.autoConnectInProgress = true;
                this.showAutoConnectStatus();
                
                addConnectionLog('🚀 Starting Enhanced Auto-Connect Sequence...', 'success');
                this.updateAutoConnectProgress('Initializing enhanced systems...');
                
                try {
                    // Step 1: Enhanced Permission Checking
                    await this.checkEnhancedPermissions();
                    
                    // Step 2: Enhanced Bluetooth Serial Auto-Pairing
                    await this.enhancedBluetoothSerialPairing();
                    
                    // Step 3: Sequential Device Connection with Retry Logic
                    for (const deviceType of this.deviceQueue) {
                        await this.enhancedAutoConnectDevice(deviceType);
                        await this.delay(2500); // Enhanced timing
                    }
                    
                    // Step 4: Launch Simulator if No Real Devices Found
                    await this.checkAndLaunchSimulator();
                    
                    addConnectionLog('✅ Enhanced Auto-Connect Sequence Completed Successfully!', 'success');
                    this.updateAutoConnectProgress('🎉 All systems connected and ready!');
                    
                } catch (error) {
                    addConnectionLog(`❌ Enhanced Auto-Connect Failed: ${error.message}`, 'error');
                    this.updateAutoConnectProgress('❌ Auto-connect encountered errors');
                } finally {
                    setTimeout(() => {
                        this.hideAutoConnectStatus();
                        this.autoConnectInProgress = false;
                    }, 4000);
                }
            }

            async checkEnhancedPermissions() {
                this.updateAutoConnectProgress('🔐 Checking enhanced permissions...');
                
                // Enhanced Bluetooth Check
                if ('bluetooth' in navigator) {
                    addConnectionLog('✅ Enhanced Bluetooth API: Available', 'success');
                } else {
                    throw new Error('Enhanced Bluetooth API not supported in this browser');
                }
                
                // Enhanced Serial Check
                if ('serial' in navigator) {
                    try {
                        const ports = await navigator.serial.getPorts();
                        addConnectionLog(`📶 Enhanced Serial Bridge: Found ${ports.length} existing permissions`, 'info');
                    } catch (error) {
                        addConnectionLog(`⚠️ Enhanced Serial Bridge Warning: ${error.message}`, 'warning');
                    }
                } else {
                    addConnectionLog('ℹ️ Enhanced Serial Bridge: Not available (will use Bluetooth only)', 'info');
                }
                
                // Enhanced Location Check (Android)
                if (/android/i.test(navigator.userAgent)) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {timeout: 3000});
                        });
                        addConnectionLog('✅ Enhanced Location Services: Granted', 'success');
                    } catch (error) {
                        addConnectionLog('⚠️ Enhanced Location Services: May be required on Android for Bluetooth', 'warning');
                    }
                }
            }

            async enhancedBluetoothSerialPairing() {
                this.updateAutoConnectProgress('🔗 Enhanced Bluetooth Serial Auto-Pairing...');
                
                try {
                    const enhancedFilters = [
                        // Enhanced Fitness Device Patterns
                        { namePrefix: 'KICKR' }, { namePrefix: 'Wahoo' }, { namePrefix: 'TICKR' },
                        { namePrefix: 'Polar' }, { namePrefix: 'Garmin' }, { namePrefix: 'Zwift' },
                        { namePrefix: 'Suunto' }, { namePrefix: 'Stages' }, { namePrefix: 'Elite' },
                        // Enhanced Service UUIDs
                        { services: [0x1818] }, // Cycling Power
                        { services: [0x1816] }, // Cycling Speed and Cadence
                        { services: [0x180D] }, // Heart Rate
                        { services: [0x1826] }, // Fitness Machine
                        { services: [0x1812] }  // HID (Zwift Click)
                    ];

                    addConnectionLog('🔍 Enhanced Device Discovery: Scanning for fitness devices...', 'info');
                    
                    // Enhanced Multi-Device Pairing (up to 5 devices)
                    for (let attempt = 0; attempt < 5; attempt++) {
                        try {
                            const device = await navigator.bluetooth.requestDevice({
                                filters: enhancedFilters,
                                optionalServices: [
                                    0x1818, 0x1816, 0x180D, 0x1826, 0x1812,
                                    0x180A, 0x180F, // Device Info, Battery
                                    '6e40fec1-b5a3-f393-e0a9-e50e24dcca9e' // Zwift Custom
                                ]
                            });
                            
                            if (device) {
                                addConnectionLog(`✅ Enhanced Discovery: Found ${device.name || 'Unknown Device'}`, 'success');
                                this.bluetoothSerialPorts.set(device.id, device);
                                
                                // Enhanced Connection with Service Discovery
                                const server = await device.gatt.connect();
                                addConnectionLog(`🔗 Enhanced Connection: Connected to ${device.name}`, 'success');
                                
                                // Enhanced Device Type Detection
                                const deviceType = await this.enhancedDeviceTypeDetection(device, server);
                                if (deviceType) {
                                    this.connectedDevices.add(deviceType);
                                    window.deviceConnectionLogger?.logConnection(deviceType, 'connected', device.name);
                                    
                                    // Set up enhanced monitoring
                                    this.setupEnhancedDeviceMonitoring(device, server, deviceType);
                                }
                            }
                        } catch (error) {
                            if (error.name === 'NotFoundError') {
                                addConnectionLog('⚠️ Enhanced Discovery: User cancelled device selection', 'warning');
                                break;
                            } else {
                                addConnectionLog(`⚠️ Enhanced Discovery: Connection attempt failed - ${error.message}`, 'warning');
                            }
                        }
                        
                        if (attempt < 4) await this.delay(1500);
                    }
                    
                } catch (error) {
                    addConnectionLog(`⚠️ Enhanced Bluetooth Serial Pairing: ${error.message}`, 'warning');
                }
            }

            async enhancedDeviceTypeDetection(device, server) {
                const name = (device.name || '').toLowerCase();
                
                // Enhanced Name-Based Detection
                if (name.includes('kickr') || name.includes('wahoo')) return 'kickr';
                if (name.includes('tickr') || name.includes('polar') || name.includes('garmin')) return 'hrm';
                if (name.includes('zwift') || name.includes('click')) return 'zwift-click';
                
                // Enhanced Service-Based Detection
                try {
                    const services = await server.getPrimaryServices();
                    for (const service of services) {
                        const uuid = service.uuid;
                        if (uuid.includes('1826')) return 'kickr'; // Fitness Machine
                        if (uuid.includes('180d')) return 'hrm';   // Heart Rate
                        if (uuid.includes('1812')) return 'zwift-click'; // HID
                    }
                } catch (error) {
                    addConnectionLog(`⚠️ Enhanced Detection: Could not read services from ${device.name}`, 'warning');
                }
                
                return null;
            }

            setupEnhancedDeviceMonitoring(device, server, deviceType) {
                device.addEventListener('gattserverdisconnected', () => {
                    addConnectionLog(`⚠️ Enhanced Monitoring: ${deviceType.toUpperCase()} disconnected`, 'warning');
                    this.connectedDevices.delete(deviceType);
                    
                    if (window.deviceConnectionLogger) {
                        window.deviceConnectionLogger.logConnection(deviceType, 'disconnected');
                    }
                    
                    // Enhanced Auto-Reconnection
                    setTimeout(() => {
                        this.attemptReconnection(device, deviceType);
                    }, 5000);
                });
                
                addConnectionLog(`👀 Enhanced Monitoring: Set up for ${deviceType.toUpperCase()}`, 'info');
            }

            async attemptReconnection(device, deviceType) {
                const retryCount = this.connectionRetries.get(deviceType) || 0;
                
                if (retryCount < this.maxRetries) {
                    addConnectionLog(`🔄 Enhanced Reconnection: Attempting to reconnect ${deviceType.toUpperCase()} (${retryCount + 1}/${this.maxRetries})`, 'info');
                    
                    try {
                        await device.gatt.connect();
                        addConnectionLog(`✅ Enhanced Reconnection: ${deviceType.toUpperCase()} reconnected successfully`, 'success');
                        this.connectedDevices.add(deviceType);
                        this.connectionRetries.delete(deviceType);
                        
                        if (window.deviceConnectionLogger) {
                            window.deviceConnectionLogger.logConnection(deviceType, 'connected', device.name);
                        }
                    } catch (error) {
                        this.connectionRetries.set(deviceType, retryCount + 1);
                        addConnectionLog(`❌ Enhanced Reconnection: ${deviceType.toUpperCase()} reconnection failed`, 'error');
                    }
                } else {
                    addConnectionLog(`❌ Enhanced Reconnection: ${deviceType.toUpperCase()} max retries exceeded`, 'error');
                    this.connectionRetries.delete(deviceType);
                }
            }

            async enhancedAutoConnectDevice(deviceType) {
                if (this.connectedDevices.has(deviceType)) {
                    addConnectionLog(`✅ Enhanced Auto-Connect: ${deviceType.toUpperCase()} already connected`, 'success');
                    return;
                }
                
                this.updateAutoConnectProgress(`🔗 Enhanced connection to ${deviceType}...`);
                addConnectionLog(`🔍 Enhanced Auto-Connect: Connecting ${deviceType.toUpperCase()}...`, 'info');
                
                try {
                    // Enhanced Device Pairing
                    if (typeof pairDevice === 'function') {
                        await pairDevice(deviceType);
                        this.connectedDevices.add(deviceType);
                        addConnectionLog(`✅ Enhanced Auto-Connect: ${deviceType.toUpperCase()} connected successfully`, 'success');
                    }
                } catch (error) {
                    addConnectionLog(`⚠️ Enhanced Auto-Connect: ${deviceType} connection failed - ${error.message}`, 'warning');
                    
                    // Enhanced Fallback Connection
                    await this.enhancedFallbackConnection(deviceType);
                }
            }

            async enhancedFallbackConnection(deviceType) {
                addConnectionLog(`🔄 Enhanced Fallback: Attempting alternative connection for ${deviceType.toUpperCase()}`, 'info');
                
                try {
                    let enhancedFilters = { acceptAllDevices: true, optionalServices: [] };
                    
                    switch (deviceType) {
                        case 'kickr':
                            enhancedFilters = {
                                filters: [
                                    { namePrefix: 'KICKR' }, { namePrefix: 'Wahoo' },
                                    { services: [0x1826] }, { services: [0x1818] }
                                ],
                                optionalServices: [0x1826, 0x1818, 0x1816, 0x180A, 0x180F]
                            };
                            break;
                        case 'hrm':
                            enhancedFilters = {
                                filters: [
                                    { services: [0x180D] }, { namePrefix: 'Polar' },
                                    { namePrefix: 'Garmin' }, { namePrefix: 'TICKR' }
                                ],
                                optionalServices: [0x180D, 0x180A, 0x180F]
                            };
                            break;
                        case 'zwift-click':
                            enhancedFilters = {
                                filters: [
                                    { namePrefix: 'Zwift' }, { namePrefix: 'Click' },
                                    { services: [0x1812] }
                                ],
                                optionalServices: [0x1812, 0x180A, 0x180F]
                            };
                            break;
                    }
                    
                    const device = await navigator.bluetooth.requestDevice(enhancedFilters);
                    const server = await device.gatt.connect();
                    
                    addConnectionLog(`✅ Enhanced Fallback: ${deviceType.toUpperCase()} connected via fallback method`, 'success');
                    this.connectedDevices.add(deviceType);
                    
                    if (window.deviceConnectionLogger) {
                        window.deviceConnectionLogger.logConnection(deviceType, 'connected', device.name);
                    }
                    
                } catch (error) {
                    if (error.name !== 'NotFoundError') {
                        addConnectionLog(`❌ Enhanced Fallback: Failed for ${deviceType.toUpperCase()} - ${error.message}`, 'error');
                    }
                }
            }

            async checkAndLaunchSimulator() {
                this.updateAutoConnectProgress('🚴 Checking for simulator launch...');
                
                // If no real Kickr connected, offer to launch simulator
                if (!this.connectedDevices.has('kickr')) {
                    addConnectionLog('💡 Enhanced System: No Kickr detected, launching enhanced simulator...', 'info');
                    setTimeout(() => {
                        launchEnhancedKickrSimulator();
                    }, 2000);
                }
                
                // Summary of connections
                const connectedCount = this.connectedDevices.size;
                const availableCount = this.bluetoothSerialPorts.size;
                
                addConnectionLog(`📊 Enhanced Summary: ${connectedCount} devices connected, ${availableCount} available`, 'info');
            }

            // Enhanced UI Management
            showAutoConnectStatus() {
                const statusEl = document.getElementById('auto-connect-status');
                if (statusEl) {
                    statusEl.style.display = 'block';
                    statusEl.classList.add('auto-connect-pulse');
                }
            }

            hideAutoConnectStatus() {
                const statusEl = document.getElementById('auto-connect-status');
                if (statusEl) {
                    statusEl.style.display = 'none';
                    statusEl.classList.remove('auto-connect-pulse');
                }
            }

            updateAutoConnectProgress(message) {
                const progressEl = document.getElementById('auto-connect-progress');
                if (progressEl) {
                    progressEl.textContent = message;
                }
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Global Enhanced Auto-Connect Manager
        window.enhancedAutoConnectManager = new EnhancedAutoConnectManager();
    </script>

    <!-- Enhanced Bluetooth Serial Management -->
    <script>
        class EnhancedBluetoothSerialManager {
            constructor() {
                this.enhancedDevicePatterns = [
                    { pattern: /kickr|wahoo|elite|tacx/i, type: 'kickr', services: [0x1826, 0x1818] },
                    { pattern: /tickr|polar|garmin|suunto|stages/i, type: 'hrm', services: [0x180D] },
                    { pattern: /zwift|click|remote/i, type: 'zwift-click', services: [0x1812] }
                ];
                this.pairedDevices = new Map();
                this.deviceCapabilities = new Map();
            }

            async enhancedAutoPairBluetoothSerial() {
                addLog('🤖 Enhanced Auto Bluetooth Serial Pairing Started...');
                
                try {
                    // Enhanced Serial Port Check
                    if ('serial' in navigator) {
                        const ports = await navigator.serial.getPorts();
                        addLog(`📶 Enhanced Serial Bridge: Found ${ports.length} existing permissions`);
                        
                        // Enhanced existing port testing
                        for (const port of ports) {
                            try {
                                await port.open({ baudRate: 115200 }); // Enhanced baud rate
                                addLog('✅ Enhanced Serial: Successfully connected to existing port');
                                await port.close();
                            } catch (error) {
                                addLog(`⚠️ Enhanced Serial: Could not open port - ${error.message}`);
                            }
                        }
                    }
                    
                    // Enhanced Bluetooth Discovery
                    await this.enhancedDiscoverAndPairDevices();
                    
                } catch (error) {
                    addLog(`❌ Enhanced Auto Bluetooth Serial Pairing Failed: ${error.message}`);
                }
            }

            async enhancedDiscoverAndPairDevices() {
                addLog('🔍 Enhanced Discovery: Scanning for fitness devices...');
                
                try {
                    // Enhanced comprehensive filter system
                    const device = await navigator.bluetooth.requestDevice({
                        filters: [
                            // Enhanced Trainer Brands
                            { namePrefix: 'KICKR' }, { namePrefix: 'Wahoo' }, { namePrefix: 'Elite' },
                            { namePrefix: 'Tacx' }, { namePrefix: 'Stages' }, { namePrefix: 'Saris' },
                            // Enhanced HRM Brands
                            { namePrefix: 'TICKR' }, { namePrefix: 'Polar' }, { namePrefix: 'Garmin' },
                            { namePrefix: 'Suunto' }, { namePrefix: 'Coros' }, { namePrefix: 'Wahoo' },
                            // Enhanced Controllers
                            { namePrefix: 'Zwift' }, { namePrefix: 'Click' }, { namePrefix: 'Remote' },
                            // Enhanced Service UUIDs
                            { services: [0x1818] }, // Cycling Power
                            { services: [0x1816] }, // Cycling Speed and Cadence
                            { services: [0x180D] }, // Heart Rate
                            { services: [0x1826] }, // Fitness Machine
                            { services: [0x1812] }  // HID
                        ],
                        optionalServices: [
                            0x1818, 0x1816, 0x180D, 0x1826, 0x1812,
                            0x180A, 0x180F, 0x1824, // Device Info, Battery, Transport Discovery
                            '6e40fec1-b5a3-f393-e0a9-e50e24dcca9e' // Zwift Custom
                        ]
                    });

                    if (device) {
                        addLog(`✅ Enhanced Discovery: Selected ${device.name || 'Unknown Device'}`);
                        
                        // Enhanced connection with capabilities detection
                        const server = await device.gatt.connect();
                        addLog(`🔗 Enhanced Connection: Connected to GATT server`);
                        
                        // Enhanced device identification and capability detection
                        const deviceType = await this.enhancedIdentifyDeviceType(device, server);
                        if (deviceType) {
                            this.pairedDevices.set(deviceType, device);
                            addLog(`📱 Enhanced Identification: ${deviceType.toUpperCase()} with advanced capabilities`);
                            
                            // Enhanced capability detection
                            await this.detectEnhancedCapabilities(device, server, deviceType);
                            
                            // Enhanced UI update
                            if (window.deviceConnectionLogger) {
                                window.deviceConnectionLogger.logConnection(deviceType, 'connected', device.name);
                            }
                            
                            // Enhanced monitoring setup
                            this.setupEnhancedDeviceMonitoring(device, deviceType);
                        }
                        
                        return device;
                    }
                    
                } catch (error) {
                    if (error.name === 'NotFoundError') {
                        addLog('⚠️ Enhanced Discovery: No device selected by user');
                    } else {
                        addLog(`❌ Enhanced Discovery Failed: ${error.message}`);
                    }
                    return null;
                }
            }

            async enhancedIdentifyDeviceType(device, server) {
                const name = (device.name || '').toLowerCase();
                
                // Enhanced pattern matching
                for (const pattern of this.enhancedDevicePatterns) {
                    if (pattern.pattern.test(name)) {
                        return pattern.type;
                    }
                }
                
                // Enhanced service-based identification
                try {
                    const services = await server.getPrimaryServices();
                    for (const service of services) {
                        const uuid = service.uuid;
                        if (uuid.includes('1826') || uuid.includes('1818')) return 'kickr';
                        if (uuid.includes('180d')) return 'hrm';
                        if (uuid.includes('1812')) return 'zwift-click';
                    }
                } catch (error) {
                    addLog(`⚠️ Enhanced Identification: Service detection failed - ${error.message}`);
                }
                
                // Enhanced fallback identification
                if (name.includes('trainer') || name.includes('power')) return 'kickr';
                if (name.includes('heart') || name.includes('hr') || name.includes('bpm')) return 'hrm';
                if (name.includes('button') || name.includes('control') || name.includes('shift')) return 'zwift-click';
                
                return null;
            }

            async detectEnhancedCapabilities(device, server, deviceType) {
                try {
                    const services = await server.getPrimaryServices();
                    const capabilities = [];
                    
                    for (const service of services) {
                        const characteristics = await service.getCharacteristics();
                        
                        for (const characteristic of characteristics) {
                            if (characteristic.properties.read) capabilities.push('read');
                            if (characteristic.properties.write) capabilities.push('write');
                            if (characteristic.properties.notify) capabilities.push('notify');
                            if (characteristic.properties.indicate) capabilities.push('indicate');
                        }
                    }
                    
                    this.deviceCapabilities.set(deviceType, [...new Set(capabilities)]);
                    addLog(`🔧 Enhanced Capabilities: ${deviceType.toUpperCase()} supports ${capabilities.length} features`);
                    
                } catch (error) {
                    addLog(`⚠️ Enhanced Capabilities: Detection failed for ${deviceType} - ${error.message}`);
                }
            }

            setupEnhancedDeviceMonitoring(device, deviceType) {
                device.addEventListener('gattserverdisconnected', () => {
                    addLog(`⚠️ Enhanced Monitoring: ${deviceType.toUpperCase()} disconnected`);
                    this.pairedDevices.delete(deviceType);
                    this.deviceCapabilities.delete(deviceType);
                    
                    if (window.deviceConnectionLogger) {
                        window.deviceConnectionLogger.logConnection(deviceType, 'disconnected');
                    }
                });
                
                addLog(`👀 Enhanced Monitoring: Active for ${deviceType.toUpperCase()}`);
            }

            async enhancedScanAvailableDevices() {
                addLog('🔍 Enhanced Scan: Comprehensive device discovery...');
                document.getElementById('bluetooth-serial-status').textContent = 'Enhanced scanning in progress...';
                
                try {
                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: [
                            0x1818, 0x1816, 0x180D, 0x1826, 0x1812,
                            0x180A, 0x180F, 0x1824
                        ]
                    });

                    if (device) {
                        addLog(`📱 Enhanced Scan: Found ${device.name || 'Unknown'} (${device.id.substring(0, 8)}...)`);
                        
                        // Enhanced service discovery and analysis
                        try {
                            const server = await device.gatt.connect();
                            const services = await server.getPrimaryServices();
                            
                            addLog(`📋 Enhanced Analysis: ${device.name} has ${services.length} services:`);
                            
                            const serviceDetails = {};
                            
                            for (const service of services) {
                                const serviceUuid = service.uuid;
                                let serviceName = 'Unknown Service';
                                
                                // Enhanced service name mapping
                                const enhancedServiceNames = {
                                    '0000180d-0000-1000-8000-00805f9b34fb': 'Heart Rate Service',
                                    '00001818-0000-1000-8000-00805f9b34fb': 'Cycling Power Service',
                                    '00001816-0000-1000-8000-00805f9b34fb': 'Cycling Speed & Cadence',
                                    '00001826-0000-1000-8000-00805f9b34fb': 'Fitness Machine Service',
                                    '00001812-0000-1000-8000-00805f9b34fb': 'Human Interface Device',
                                    '0000180a-0000-1000-8000-00805f9b34fb': 'Device Information',
                                    '0000180f-0000-1000-8000-00805f9b34fb': 'Battery Service',
                                    '00001824-0000-1000-8000-00805f9b34fb': 'Transport Discovery'
                                };
                                
                                serviceName = enhancedServiceNames[serviceUuid] || serviceUuid;
                                serviceDetails[serviceName] = serviceUuid;
                                
                                addLog(`  • ${serviceName}`);
                                
                                // Enhanced characteristic analysis
                                try {
                                    const characteristics = await service.getCharacteristics();
                                    addLog(`    └─ ${characteristics.length} characteristics available`);
                                } catch (charError) {
                                    addLog(`    └─ Characteristics access restricted`);
                                }
                            }
                            
                            document.getElementById('bluetooth-serial-status').textContent = 
                                `Enhanced Discovery: ${device.name} - ${services.length} services analyzed`;
                            
                        } catch (connectError) {
                            addLog(`⚠️ Enhanced Analysis: Connection failed - ${connectError.message}`);
                            document.getElementById('bluetooth-serial-status').textContent = 
                                `Enhanced Discovery: ${device.name} found but analysis limited`;
                        }
                    }
                    
                } catch (error) {
                    if (error.name === 'NotFoundError') {
                        addLog('⚠️ Enhanced Scan: Cancelled by user');
                        document.getElementById('bluetooth-serial-status').textContent = 'Enhanced scan cancelled';
                    } else {
                        addLog(`❌ Enhanced Scan Failed: ${error.message}`);
                        document.getElementById('bluetooth-serial-status').textContent = 
                            `Enhanced scan failed: ${error.message}`;
                    }
                }
            }

            getEnhancedConnectedDevices() {
                return Array.from(this.pairedDevices.entries()).map(([type, device]) => ({
                    type,
                    device,
                    capabilities: this.deviceCapabilities.get(type) || []
                }));
            }
        }

        // Global Enhanced Bluetooth Serial Manager
        window.enhancedBluetoothSerialManager = new EnhancedBluetoothSerialManager();
    </script>

    <!-- Rest of the JavaScript will continue in the next part... -->
