<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Capture Button Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-container { max-width: 600px; margin: 0 auto; }
        .button { padding: 10px 20px; margin: 10px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin-top: 20px; height: 300px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Device Capture Button Test</h1>
        <p>This page tests if the device capture functionality is working correctly.</p>
        
        <button id="capture-specs-btn" class="button">üìä Capture Device Specs</button>
        <button id="clear-log-btn" class="button">Clear Log</button>
        
        <div id="log-content" class="log">Ready to test device capture...\n</div>
    </div>

    <script>
        // Enhanced device monitoring and logging (from main app)
        function addConnectionLog(message, type = 'info') {
            const logContent = document.getElementById('log-content');
            if (!logContent) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = '[' + timestamp + '] ' + message + '\n';
            logContent.textContent += logEntry;
            logContent.scrollTop = logContent.scrollHeight;
            
            console.log(logEntry.trim());
        }
        
        // Device capture functionality (same as in main app)
        function captureDeviceSpecs() {
            addConnectionLog('üìä Starting device specification capture...', 'info');
            
            if (window.antApp && window.antApp.handleCaptureSpecs) {
                addConnectionLog('‚úÖ Using main app capture system', 'success');
                window.antApp.handleCaptureSpecs();
            } else {
                addConnectionLog('‚ö†Ô∏è Main app not available, using fallback capture', 'warning');
                
                // Fallback implementation
                const deviceInfo = {
                    timestamp: new Date().toISOString(),
                    testMode: true,
                    browser: navigator.userAgent,
                    platform: navigator.platform,
                    bluetooth: 'bluetooth' in navigator ? 'Available' : 'Not supported',
                    serial: 'serial' in navigator ? 'Available' : 'Not supported',
                    webusb: 'usb' in navigator ? 'Available' : 'Not supported',
                    geolocation: 'geolocation' in navigator ? 'Available' : 'Not supported',
                    permissions: {},
                    location: window.location.href
                };
                
                // Check Bluetooth permissions if available
                if ('bluetooth' in navigator) {
                    addConnectionLog('üîç Checking Bluetooth device access...', 'info');
                    navigator.bluetooth.getDevices().then(devices => {
                        deviceInfo.bluetoothDevices = devices.map(device => ({
                            name: device.name || 'Unknown',
                            id: device.id,
                            connected: device.gatt ? device.gatt.connected : false
                        }));
                        
                        generateSpecsFile(deviceInfo);
                    }).catch(err => {
                        addConnectionLog('‚ö†Ô∏è Could not access Bluetooth devices: ' + err.message, 'warning');
                        deviceInfo.bluetoothError = err.message;
                        generateSpecsFile(deviceInfo);
                    });
                } else {
                    generateSpecsFile(deviceInfo);
                }
            }
        }
        
        function generateSpecsFile(deviceInfo) {
            const specText = JSON.stringify(deviceInfo, null, 2);
            
            addConnectionLog('üìÑ Device specifications captured:', 'success');
            addConnectionLog('Browser: ' + deviceInfo.browser.split(' ')[0], 'info');
            addConnectionLog('Platform: ' + deviceInfo.platform, 'info');
            addConnectionLog('Bluetooth: ' + deviceInfo.bluetooth, 'info');
            addConnectionLog('Serial: ' + deviceInfo.serial, 'info');
            addConnectionLog('WebUSB: ' + deviceInfo.webusb, 'info');
            
            if (deviceInfo.bluetoothDevices) {
                addConnectionLog('Bluetooth devices found: ' + deviceInfo.bluetoothDevices.length, 'info');
            }
            
            // Create downloadable file
            const blob = new Blob([specText], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'device-specs-test-' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            addConnectionLog('üíæ Specifications saved to downloads folder', 'success');
            addConnectionLog('‚úÖ Device capture test completed successfully!', 'success');
        }
        
        // Initialize test page
        document.addEventListener('DOMContentLoaded', function() {
            addConnectionLog('üß™ Device capture test page initialized', 'info');
            
            // Add capture specs button functionality
            const captureBtn = document.getElementById('capture-specs-btn');
            if (captureBtn) {
                captureBtn.addEventListener('click', captureDeviceSpecs);
                addConnectionLog('‚úÖ Capture specs button event listener added', 'success');
            } else {
                addConnectionLog('‚ùå Could not find capture specs button', 'error');
            }
            
            // Add clear log functionality
            const clearBtn = document.getElementById('clear-log-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    const logContent = document.getElementById('log-content');
                    if (logContent) {
                        logContent.textContent = '';
                        addConnectionLog('üìã Log cleared', 'info');
                    }
                });
                addConnectionLog('‚úÖ Clear log button event listener added', 'success');
            }
            
            addConnectionLog('üöÄ Test system ready - click "Capture Device Specs" to test', 'info');
        });
        
        // Check if main app is available after a delay
        setTimeout(function() {
            if (window.antApp) {
                addConnectionLog('‚úÖ Main ANT+ app detected and available', 'success');
            } else {
                addConnectionLog('‚ÑπÔ∏è Main ANT+ app not detected - using fallback mode', 'info');
            }
        }, 2000);
    </script>
</body>
</html>