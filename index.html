<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANT+ Connection Test - Ultra Fixed Version</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .device-guide {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .device-guide h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .good-devices, .bad-devices {
            margin-bottom: 15px;
        }

        .good-devices h4 {
            color: #28a745;
        }

        .bad-devices h4 {
            color: #dc3545;
        }

        .status-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .connection-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            background: linear-gradient(45deg, #2980b9, #1f639a);
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-usb {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .btn-usb:hover {
            background: linear-gradient(45deg, #c0392b, #a93226);
        }

        .btn-bluetooth {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .btn-test {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
        }

        .btn-test:hover {
            background: linear-gradient(45deg, #27ae60, #229954);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-success { background-color: #2ecc71; }
        .status-error { background-color: #e74c3c; }
        .status-warning { background-color: #f39c12; }
        .status-info { background-color: #3498db; }

        .log-section {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-bottom: 20px;
        }

        .diagnostic-results {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .diagnostic-item {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .diagnostic-item.success { border-left-color: #2ecc71; }
        .diagnostic-item.error { border-left-color: #e74c3c; }
        .diagnostic-item.warning { border-left-color: #f39c12; }

        .help-section {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .help-section h3 {
            color: #2980b9;
            margin-bottom: 15px;
        }

        .help-section ul {
            margin-bottom: 15px;
        }

        .help-section li {
            margin-bottom: 5px;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .error-box {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .success-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß ANT+ Connection Test - Ultra Fixed Version</h1>
            <p>Enhanced device detection and troubleshooting</p>
        </div>

        <div class="device-guide">
            <h3>üìã USB Device Selection Guide</h3>
            <div class="good-devices">
                <h4>‚úÖ SELECT These Devices (ANT+ USB Sticks):</h4>
                <ul>
                    <li><strong>USB Serial Device</strong> - Generic name for most ANT+ sticks</li>
                    <li><strong>Silicon Labs CP210x USB to UART Bridge</strong> - Common ANT+ chip</li>
                    <li><strong>Garmin ANT Agent USB Device</strong> - Official Garmin device</li>
                    <li><strong>ANT USB Stick</strong> - Any device with "ANT" in the name</li>
                </ul>
            </div>
            <div class="bad-devices">
                <h4>‚ùå AVOID These Devices (Not ANT+ Sticks):</h4>
                <ul>
                    <li><strong>Bluetooth Peripheral Device (COM3, COM4, etc.)</strong> - These are Bluetooth, not ANT+</li>
                    <li><strong>JBL TUNE710BT, EDIFIER WH950NB</strong> - Audio devices</li>
                    <li><strong>Wacom Paper Data</strong> - Graphics tablet</li>
                    <li><strong>BT IntuosPro M</strong> - Bluetooth graphics device</li>
                </ul>
            </div>
            <div class="warning-box">
                <strong>‚ö†Ô∏è Important:</strong> If you only see Bluetooth devices in the list, your ANT+ USB stick may not be properly recognized or needs drivers installed.
            </div>
        </div>

        <div class="status-panel">
            <h3>üìä Connection Status</h3>
            <div id="status-display">
                <div><span class="status-indicator status-info"></span>Ready to test connections</div>
            </div>
        </div>

        <div class="connection-buttons">
            <button class="btn btn-test" onclick="runDiagnostics()">üîç Run Diagnostics</button>
            <button class="btn btn-usb" onclick="testUSB()">üîå Test USB ANT+</button>
            <button class="btn btn-bluetooth" onclick="testBluetooth()">üì± Test Bluetooth</button>
            <button class="btn" onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div class="diagnostic-results" id="diagnostic-results" style="display: none;">
            <h3>üîç Diagnostic Results</h3>
            <div id="diagnostic-content"></div>
        </div>

        <div class="log-section" id="log-content">
ANT+ Connection Tester - Ultra Fixed Version
============================================
Enhanced device detection and error handling

üí° Before testing:
1. For USB: Look for "USB Serial Device" or "CP210x" in device list
2. For Bluetooth: Make sure device is in pairing mode
3. Close other apps that might use ANT+ devices

Waiting for user input...
        </div>

        <div class="help-section">
            <h3>üí° Enhanced Troubleshooting Guide</h3>
            
            <h4>üîå USB ANT+ Issues:</h4>
            <ul>
                <li><strong>Only Bluetooth devices appear:</strong> ANT+ USB stick not recognized - install drivers</li>
                <li><strong>No device selector appears:</strong> Use Chrome/Edge browser, enable Web Serial API</li>
                <li><strong>"Port already in use":</strong> Close Zwift, TrainerRoad, Garmin Express</li>
                <li><strong>Connection fails after selection:</strong> Wrong device selected - look for "USB Serial Device"</li>
            </ul>

            <h4>üì± Bluetooth Issues:</h4>
            <ul>
                <li><strong>"Invalid Service name" error:</strong> Browser compatibility issue - try latest Chrome</li>
                <li><strong>No devices found:</strong> Put ANT+ device in pairing mode first</li>
                <li><strong>Permission denied:</strong> Grant location permission (Android) and Bluetooth access</li>
                <li><strong>Connection timeout:</strong> Move closer to device, ensure it's not connected elsewhere</li>
            </ul>

            <h4>üåê Browser & System Requirements:</h4>
            <ul>
                <li><strong>USB ANT+:</strong> Chrome 89+, Edge 89+ (desktop only, no mobile support)</li>
                <li><strong>Bluetooth:</strong> Chrome, Edge, Opera (desktop and mobile)</li>
                <li><strong>Security:</strong> HTTPS required (except localhost)</li>
                <li><strong>Permissions:</strong> Allow serial access and Bluetooth when prompted</li>
            </ul>

            <div class="error-box">
                <strong>‚ùå Your Device List Issue:</strong><br>
                The devices shown in your screenshot (JBL, EDIFIER, Bluetooth COM ports) are NOT ANT+ USB sticks. 
                They are Bluetooth audio devices and virtual COM ports. Your actual ANT+ USB stick is either:
                <ul>
                    <li>Not plugged in properly</li>
                    <li>Not recognized by Windows (needs drivers)</li>
                    <li>Hidden in the device list</li>
                </ul>
            </div>

            <div class="success-box">
                <strong>‚úÖ To Find Your ANT+ Stick:</strong><br>
                1. Unplug and replug your ANT+ USB stick<br>
                2. Try a different USB port (avoid hubs)<br>
                3. Install ANT+ drivers from Garmin or Silicon Labs<br>
                4. Check Windows Device Manager for unrecognized devices<br>
                5. Look for "USB Serial Device" in the connection list
            </div>
        </div>
    </div>

    <script type="module">
        import { logger } from './js/core/logger.js';
        import { platform } from './js/core/platform.js';
        import { ConnectionManager } from './js/connections/connection-manager-fixed.js';

        class ConnectionTester {
            constructor() {
                this.connectionManager = new ConnectionManager();
                this.testResults = {};
                this.logElement = document.getElementById('log-content');
                this.diagnosticElement = document.getElementById('diagnostic-content');
                this.statusElement = document.getElementById('status-display');
            }

            async init() {
                // Initialize logger with DOM element
                logger.init(this.logElement);
                
                // Detect platform
                await platform.detect();
                this.log(`üì± Platform: ${platform.info.name}`);
                this.log(`üåê Browser: ${navigator.userAgent.split(' ').pop()}`);
                this.log('‚úÖ Connection tester initialized');
            }

            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logMessage = `[${timestamp}] ${message}`;
                
                if (this.logElement) {
                    this.logElement.textContent += logMessage + '\n';
                    this.logElement.scrollTop = this.logElement.scrollHeight;
                }
                console.log(logMessage);
            }

            updateStatus(message, type = 'info') {
                if (this.statusElement) {
                    const statusClass = `status-${type}`;
                    this.statusElement.innerHTML = `<div><span class="status-indicator ${statusClass}"></span>${message}</div>`;
                }
            }

            async runDiagnostics() {
                this.log('\nüîç Running Enhanced ANT+ Connection Diagnostics...');
                this.updateStatus('Running diagnostics...', 'info');
                
                try {
                    // Check available connection methods
                    const methods = await this.connectionManager.checkAvailableConnectionMethods();
                    this.log('üìã Available Connection Methods:');
                    this.log(`   USB: ${methods.usb ? '‚úÖ' : '‚ùå'}`);
                    this.log(`   Bluetooth: ${methods.bluetooth ? '‚úÖ' : '‚ùå'}`);
                    
                    if (methods.issues.length > 0) {
                        this.log('‚ö†Ô∏è Issues found:');
                        methods.issues.forEach(issue => this.log(`   ‚Ä¢ ${issue}`));
                    }
                    
                    // Test USB capabilities
                    await this.testUSBCapabilities();
                    
                    // Test Bluetooth capabilities
                    await this.testBluetoothCapabilities();
                    
                    // Display results
                    this.displayDiagnosticResults();
                    this.updateStatus('Diagnostics complete', 'success');
                    
                } catch (error) {
                    this.log(`‚ùå Diagnostic error: ${error.message}`);
                    this.updateStatus('Diagnostic failed', 'error');
                }
            }

            async testUSBCapabilities() {
                this.log('\nüîå Testing USB Capabilities...');
                
                this.testResults.usb = {
                    apiSupported: 'serial' in navigator,
                    browserSupported: navigator.userAgent.includes('Chrome') || navigator.userAgent.includes('Edge'),
                    platform: platform.info.name,
                    httpsSupported: location.protocol === 'https:' || location.hostname === 'localhost',
                    issues: []
                };

                if (!this.testResults.usb.apiSupported) {
                    this.testResults.usb.issues.push('Web Serial API not supported');
                }

                if (!this.testResults.usb.browserSupported) {
                    this.testResults.usb.issues.push('Browser not supported (use Chrome or Edge)');
                }

                if (!this.testResults.usb.httpsSupported) {
                    this.testResults.usb.issues.push('HTTPS required for Web Serial API');
                }

                if (platform.info.isMobile) {
                    this.testResults.usb.issues.push('USB not available on mobile devices');
                }

                const status = this.testResults.usb.issues.length === 0 ? '‚úÖ READY' : '‚ùå ISSUES';
                this.log(`üîå USB ANT+: ${status}`);
                this.testResults.usb.issues.forEach(issue => this.log(`   ‚Ä¢ ${issue}`));

                // Additional guidance for USB device selection
                this.log('\nüí° USB Device Selection Tips:');
                this.log('   ‚úÖ Look for: "USB Serial Device", "CP210x", "ANT USB"');
                this.log('   ‚ùå Avoid: Bluetooth devices, audio devices, graphics tablets');
                this.log('   ‚ö†Ô∏è If no ANT+ device appears: Install drivers or try different USB port');
            }

            async testBluetoothCapabilities() {
                this.log('\nüì± Testing Bluetooth Capabilities...');
                
                this.testResults.bluetooth = {
                    apiSupported: 'bluetooth' in navigator,
                    httpsSupported: location.protocol === 'https:' || location.hostname === 'localhost',
                    bluetoothAvailable: false,
                    locationPermission: 'unknown',
                    issues: []
                };

                if (!this.testResults.bluetooth.apiSupported) {
                    this.testResults.bluetooth.issues.push('Web Bluetooth API not supported');
                }

                if (!this.testResults.bluetooth.httpsSupported) {
                    this.testResults.bluetooth.issues.push('HTTPS required for Bluetooth');
                }

                if (this.testResults.bluetooth.apiSupported) {
                    try {
                        this.testResults.bluetooth.bluetoothAvailable = await navigator.bluetooth.getAvailability();
                        if (!this.testResults.bluetooth.bluetoothAvailable) {
                            this.testResults.bluetooth.issues.push('Bluetooth not available on device');
                        }
                    } catch (error) {
                        this.testResults.bluetooth.issues.push(`Bluetooth check failed: ${error.message}`);
                    }
                }

                // Check location permission on Android
                if (platform.info.isAndroid && 'permissions' in navigator) {
                    try {
                        const result = await navigator.permissions.query({name: 'geolocation'});
                        this.testResults.bluetooth.locationPermission = result.state;
                        if (result.state !== 'granted') {
                            this.testResults.bluetooth.issues.push('Location permission required on Android');
                        }
                    } catch (error) {
                        this.testResults.bluetooth.issues.push('Could not check location permission');
                    }
                }

                const status = this.testResults.bluetooth.issues.length === 0 ? '‚úÖ READY' : '‚ùå ISSUES';
                this.log(`üì± Bluetooth: ${status}`);
                this.testResults.bluetooth.issues.forEach(issue => this.log(`   ‚Ä¢ ${issue}`));
            }

            displayDiagnosticResults() {
                const resultsDiv = document.getElementById('diagnostic-results');
                const contentDiv = this.diagnosticElement;
                
                if (!resultsDiv || !contentDiv) return;
                
                let html = '';
                
                // USB Results
                const usbStatus = this.testResults.usb.issues.length === 0 ? 'success' : 'error';
                html += `<div class="diagnostic-item ${usbStatus}">`;
                html += `<strong>üîå USB ANT+:</strong> ${this.testResults.usb.issues.length === 0 ? 'Ready' : 'Issues Found'}<br>`;
                if (this.testResults.usb.issues.length > 0) {
                    html += `<ul>${this.testResults.usb.issues.map(issue => `<li>${issue}</li>`).join('')}</ul>`;
                }
                html += '</div>';
                
                // Bluetooth Results
                const bluetoothStatus = this.testResults.bluetooth.issues.length === 0 ? 'success' : 'error';
                html += `<div class="diagnostic-item ${bluetoothStatus}">`;
                html += `<strong>üì± Bluetooth:</strong> ${this.testResults.bluetooth.issues.length === 0 ? 'Ready' : 'Issues Found'}<br>`;
                if (this.testResults.bluetooth.issues.length > 0) {
                    html += `<ul>${this.testResults.bluetooth.issues.map(issue => `<li>${issue}</li>`).join('')}</ul>`;
                }
                html += '</div>';
                
                contentDiv.innerHTML = html;
                resultsDiv.style.display = 'block';
            }

            async testUSBConnection() {
                this.log('\nüîå Testing USB Connection...');
                this.log('üìã Remember: Select "USB Serial Device" or "CP210x", NOT Bluetooth devices');
                this.updateStatus('Testing USB connection...', 'info');
                
                try {
                    const connection = await this.connectionManager.connectUSB();
                    this.log('‚úÖ USB connection successful!');
                    this.log(`üìä Device: ${connection.getStatus().type}`);
                    this.updateStatus('USB connection successful!', 'success');
                    
                    // Disconnect after 3 seconds
                    setTimeout(async () => {
                        await this.connectionManager.disconnectUSB();
                        this.log('üîå Test USB connection closed');
                        this.updateStatus('USB test completed', 'info');
                    }, 3000);
                    
                } catch (error) {
                    this.log(`‚ùå USB connection test failed: ${error.message}`);
                    this.updateStatus('USB connection failed', 'error');
                    
                    // Provide specific guidance based on error
                    if (error.message.includes('No port selected')) {
                        this.log('üí° Device Selection Help:');
                        this.log('   ‚Ä¢ Your ANT+ USB stick may not be in the list');
                        this.log('   ‚Ä¢ Install ANT+ drivers from Garmin or Silicon Labs');
                        this.log('   ‚Ä¢ Try different USB port or restart computer');
                        this.log('   ‚Ä¢ Check Windows Device Manager for unrecognized devices');
                    }
                }
            }

            async testBluetoothConnection() {
                this.log('\nüì± Testing Bluetooth Connection...');
                this.log('üí° Make sure your ANT+ device is in pairing mode');
                this.updateStatus('Testing Bluetooth connection...', 'info');
                
                try {
                    const connection = await this.connectionManager.connectBluetooth();
                    this.log('‚úÖ Bluetooth connection successful!');
                    this.log(`üìä Device: ${connection.getStatus().deviceName || 'Unknown'}`);
                    this.updateStatus('Bluetooth connection successful!', 'success');
                    
                    // Disconnect after 3 seconds
                    setTimeout(async () => {
                        await this.connectionManager.disconnectBluetooth();
                        this.log('üì± Test Bluetooth connection closed');
                        this.updateStatus('Bluetooth test completed', 'info');
                    }, 3000);
                    
                } catch (error) {
                    this.log(`‚ùå Bluetooth connection test failed: ${error.message}`);
                    this.updateStatus('Bluetooth connection failed', 'error');
                }
            }

            clearLog() {
                if (this.logElement) {
                    this.logElement.textContent = 'Log cleared.\n\nüí° Enhanced device guidance:\n- USB: Look for "USB Serial Device" or "CP210x"\n- Bluetooth: Put device in pairing mode first\n';
                }
                this.updateStatus('Log cleared', 'info');
            }
        }

        // Initialize tester
        const tester = new ConnectionTester();
        await tester.init();

        // Make functions available globally
        window.runDiagnostics = () => tester.runDiagnostics();
        window.testUSB = () => tester.testUSBConnection();
        window.testBluetooth = () => tester.testBluetoothConnection();
        window.clearLog = () => tester.clearLog();
        window.connectionTester = tester;

        // Auto-run diagnostics on load
        setTimeout(() => {
            tester.log('\nüí° Ready for enhanced testing!');
            tester.log('üìã Key improvements in this version:');
            tester.log('   ‚Ä¢ Better USB device identification');
            tester.log('   ‚Ä¢ Fixed Bluetooth service UUID errors');
            tester.log('   ‚Ä¢ Enhanced error messages and guidance');
            tester.log('   ‚Ä¢ Specific help for your device list issue');
            tester.log('\nClick "Run Diagnostics" to check system compatibility');
        }, 500);
    </script>
</body>
</html>
