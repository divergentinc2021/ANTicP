<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANT+ Connection Test - Fixed Version</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .status-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .connection-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            background: linear-gradient(45deg, #2980b9, #1f639a);
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-usb {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .btn-usb:hover {
            background: linear-gradient(45deg, #c0392b, #a93226);
        }

        .btn-bluetooth {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .btn-test {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
        }

        .btn-test:hover {
            background: linear-gradient(45deg, #27ae60, #229954);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-success { background-color: #2ecc71; }
        .status-error { background-color: #e74c3c; }
        .status-warning { background-color: #f39c12; }
        .status-info { background-color: #3498db; }

        .log-section {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-bottom: 20px;
        }

        .diagnostic-results {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .diagnostic-item {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .diagnostic-item.success { border-left-color: #2ecc71; }
        .diagnostic-item.error { border-left-color: #e74c3c; }
        .diagnostic-item.warning { border-left-color: #f39c12; }

        .help-section {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .help-section h3 {
            color: #2980b9;
            margin-bottom: 15px;
        }

        .help-section ul {
            margin-bottom: 15px;
        }

        .help-section li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß ANT+ Connection Test - Fixed Version</h1>
            <p>Test and diagnose USB ANT+ and Bluetooth connectivity issues</p>
        </div>

        <div class="status-panel">
            <h3>üìä Connection Status</h3>
            <div id="status-display">
                <div><span class="status-indicator status-info"></span>Ready to test connections</div>
            </div>
        </div>

        <div class="connection-buttons">
            <button class="btn btn-test" onclick="runDiagnostics()">üîç Run Diagnostics</button>
            <button class="btn btn-usb" onclick="testUSB()">üîå Test USB ANT+</button>
            <button class="btn btn-bluetooth" onclick="testBluetooth()">üì± Test Bluetooth</button>
            <button class="btn" onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div class="diagnostic-results" id="diagnostic-results" style="display: none;">
            <h3>üîç Diagnostic Results</h3>
            <div id="diagnostic-content"></div>
        </div>

        <div class="log-section" id="log-content">
ANT+ Connection Tester - Fixed Version
======================================
Click "Run Diagnostics" to check your system compatibility
Click "Test USB ANT+" to test serial port connection
Click "Test Bluetooth" to test Bluetooth device pairing

Waiting for user input...
        </div>

        <div class="help-section">
            <h3>üí° Troubleshooting Guide</h3>
            
            <h4>üîå USB ANT+ Issues:</h4>
            <ul>
                <li><strong>No device selector appears:</strong> Make sure you're using Chrome or Edge browser</li>
                <li><strong>Device not in list:</strong> Unplug and replug the ANT+ USB stick</li>
                <li><strong>"Port already in use":</strong> Close other apps like Zwift, TrainerRoad</li>
                <li><strong>Permission denied:</strong> Make sure you're using HTTPS or localhost</li>
            </ul>

            <h4>üì± Bluetooth Issues:</h4>
            <ul>
                <li><strong>No device selector:</strong> Enable Bluetooth in system settings</li>
                <li><strong>Permission denied:</strong> Grant location permission (required on Android)</li>
                <li><strong>Connection fails:</strong> Make sure device is in pairing mode and close to computer</li>
                <li><strong>Not supported:</strong> Use Chrome, Edge, or Opera browser</li>
            </ul>

            <h4>üåê Browser Requirements:</h4>
            <ul>
                <li><strong>USB ANT+:</strong> Chrome 89+, Edge 89+ (desktop only)</li>
                <li><strong>Bluetooth:</strong> Chrome, Edge, Opera (desktop and mobile)</li>
                <li><strong>Security:</strong> HTTPS required (except localhost)</li>
            </ul>
        </div>
    </div>

    <script type="module">
        import { logger } from './js/core/logger.js';
        import { platform } from './js/core/platform.js';
        import { ConnectionManager } from './js/connections/connection-manager-fixed.js';

        class ConnectionTester {
            constructor() {
                this.connectionManager = new ConnectionManager();
                this.testResults = {};
                this.logElement = document.getElementById('log-content');
                this.diagnosticElement = document.getElementById('diagnostic-content');
                this.statusElement = document.getElementById('status-display');
            }

            async init() {
                // Initialize logger with DOM element
                logger.init(this.logElement);
                
                // Detect platform
                await platform.detect();
                this.log(`üì± Platform: ${platform.info.name}`);
                this.log(`üåê Browser: ${navigator.userAgent.split(' ').pop()}`);
                this.log('‚úÖ Connection tester initialized');
            }

            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logMessage = `[${timestamp}] ${message}`;
                
                if (this.logElement) {
                    this.logElement.textContent += logMessage + '\n';
                    this.logElement.scrollTop = this.logElement.scrollHeight;
                }
                console.log(logMessage);
            }

            updateStatus(message, type = 'info') {
                if (this.statusElement) {
                    const statusClass = `status-${type}`;
                    this.statusElement.innerHTML = `<div><span class="status-indicator ${statusClass}"></span>${message}</div>`;
                }
            }

            async runDiagnostics() {
                this.log('\nüîç Running ANT+ Connection Diagnostics...');
                this.updateStatus('Running diagnostics...', 'info');
                
                try {
                    // Check available connection methods
                    const methods = await this.connectionManager.checkAvailableConnectionMethods();
                    this.log('üìã Available Connection Methods:');
                    this.log(`   USB: ${methods.usb ? '‚úÖ' : '‚ùå'}`);
                    this.log(`   Bluetooth: ${methods.bluetooth ? '‚úÖ' : '‚ùå'}`);
                    
                    if (methods.issues.length > 0) {
                        this.log('‚ö†Ô∏è Issues found:');
                        methods.issues.forEach(issue => this.log(`   ‚Ä¢ ${issue}`));
                    }
                    
                    // Test USB capabilities
                    await this.testUSBCapabilities();
                    
                    // Test Bluetooth capabilities
                    await this.testBluetoothCapabilities();
                    
                    // Display results
                    this.displayDiagnosticResults();
                    this.updateStatus('Diagnostics complete', 'success');
                    
                } catch (error) {
                    this.log(`‚ùå Diagnostic error: ${error.message}`);
                    this.updateStatus('Diagnostic failed', 'error');
                }
            }

            async testUSBCapabilities() {
                this.log('\nüîå Testing USB Capabilities...');
                
                this.testResults.usb = {
                    apiSupported: 'serial' in navigator,
                    browserSupported: navigator.userAgent.includes('Chrome') || navigator.userAgent.includes('Edge'),
                    platform: platform.info.name,
                    httpsSupported: location.protocol === 'https:' || location.hostname === 'localhost',
                    issues: []
                };

                if (!this.testResults.usb.apiSupported) {
                    this.testResults.usb.issues.push('Web Serial API not supported');
                }

                if (!this.testResults.usb.browserSupported) {
                    this.testResults.usb.issues.push('Browser not supported (use Chrome or Edge)');
                }

                if (!this.testResults.usb.httpsSupported) {
                    this.testResults.usb.issues.push('HTTPS required for Web Serial API');
                }

                if (platform.info.isMobile) {
                    this.testResults.usb.issues.push('USB not available on mobile devices');
                }

                const status = this.testResults.usb.issues.length === 0 ? '‚úÖ READY' : '‚ùå ISSUES';
                this.log(`üîå USB ANT+: ${status}`);
                this.testResults.usb.issues.forEach(issue => this.log(`   ‚Ä¢ ${issue}`));
            }

            async testBluetoothCapabilities() {
                this.log('\nüì± Testing Bluetooth Capabilities...');
                
                this.testResults.bluetooth = {
                    apiSupported: 'bluetooth' in navigator,
                    httpsSupported: location.protocol === 'https:' || location.hostname === 'localhost',
                    bluetoothAvailable: false,
                    locationPermission: 'unknown',
                    issues: []
                };

                if (!this.testResults.bluetooth.apiSupported) {
                    this.testResults.bluetooth.issues.push('Web Bluetooth API not supported');
                }

                if (!this.testResults.bluetooth.httpsSupported) {
                    this.testResults.bluetooth.issues.push('HTTPS required for Bluetooth');
                }

                if (this.testResults.bluetooth.apiSupported) {
                    try {
                        this.testResults.bluetooth.bluetoothAvailable = await navigator.bluetooth.getAvailability();
                        if (!this.testResults.bluetooth.bluetoothAvailable) {
                            this.testResults.bluetooth.issues.push('Bluetooth not available on device');
                        }
                    } catch (error) {
                        this.testResults.bluetooth.issues.push(`Bluetooth check failed: ${error.message}`);
                    }
                }

                // Check location permission on Android
                if (platform.info.isAndroid && 'permissions' in navigator) {
                    try {
                        const result = await navigator.permissions.query({name: 'geolocation'});
                        this.testResults.bluetooth.locationPermission = result.state;
                        if (result.state !== 'granted') {
                            this.testResults.bluetooth.issues.push('Location permission required on Android');
                        }
                    } catch (error) {
                        this.testResults.bluetooth.issues.push('Could not check location permission');
                    }
                }

                const status = this.testResults.bluetooth.issues.length === 0 ? '‚úÖ READY' : '‚ùå ISSUES';
                this.log(`üì± Bluetooth: ${status}`);
                this.testResults.bluetooth.issues.forEach(issue => this.log(`   ‚Ä¢ ${issue}`));
            }

            displayDiagnosticResults() {
                const resultsDiv = document.getElementById('diagnostic-results');
                const contentDiv = this.diagnosticElement;
                
                if (!resultsDiv || !contentDiv) return;
                
                let html = '';
                
                // USB Results
                const usbStatus = this.testResults.usb.issues.length === 0 ? 'success' : 'error';
                html += `<div class="diagnostic-item ${usbStatus}">`;
                html += `<strong>üîå USB ANT+:</strong> ${this.testResults.usb.issues.length === 0 ? 'Ready' : 'Issues Found'}<br>`;
                if (this.testResults.usb.issues.length > 0) {
                    html += `<ul>${this.testResults.usb.issues.map(issue => `<li>${issue}</li>`).join('')}</ul>`;
                }
                html += '</div>';
                
                // Bluetooth Results
                const bluetoothStatus = this.testResults.bluetooth.issues.length === 0 ? 'success' : 'error';
                html += `<div class="diagnostic-item ${bluetoothStatus}">`;
                html += `<strong>üì± Bluetooth:</strong> ${this.testResults.bluetooth.issues.length === 0 ? 'Ready' : 'Issues Found'}<br>`;
                if (this.testResults.bluetooth.issues.length > 0) {
                    html += `<ul>${this.testResults.bluetooth.issues.map(issue => `<li>${issue}</li>`).join('')}</ul>`;
                }
                html += '</div>';
                
                contentDiv.innerHTML = html;
                resultsDiv.style.display = 'block';
            }

            async testUSBConnection() {
                this.log('\nüîå Testing USB Connection...');
                this.updateStatus('Testing USB connection...', 'info');
                
                try {
                    const connection = await this.connectionManager.connectUSB();
                    this.log('‚úÖ USB connection successful!');
                    this.log(`üìä Device: ${connection.getStatus().type}`);
                    this.updateStatus('USB connection successful!', 'success');
                    
                    // Disconnect after 3 seconds
                    setTimeout(async () => {
                        await this.connectionManager.disconnectUSB();
                        this.log('üîå Test USB connection closed');
                        this.updateStatus('USB test completed', 'info');
                    }, 3000);
                    
                } catch (error) {
                    this.log(`‚ùå USB connection test failed: ${error.message}`);
                    this.updateStatus('USB connection failed', 'error');
                }
            }

            async testBluetoothConnection() {
                this.log('\nüì± Testing Bluetooth Connection...');
                this.updateStatus('Testing Bluetooth connection...', 'info');
                
                try {
                    const connection = await this.connectionManager.connectBluetooth();
                    this.log('‚úÖ Bluetooth connection successful!');
                    this.log(`üìä Device: ${connection.getStatus().deviceName || 'Unknown'}`);
                    this.updateStatus('Bluetooth connection successful!', 'success');
                    
                    // Disconnect after 3 seconds
                    setTimeout(async () => {
                        await this.connectionManager.disconnectBluetooth();
                        this.log('üì± Test Bluetooth connection closed');
                        this.updateStatus('Bluetooth test completed', 'info');
                    }, 3000);
                    
                } catch (error) {
                    this.log(`‚ùå Bluetooth connection test failed: ${error.message}`);
                    this.updateStatus('Bluetooth connection failed', 'error');
                }
            }

            clearLog() {
                if (this.logElement) {
                    this.logElement.textContent = 'Log cleared.\n';
                }
                this.updateStatus('Log cleared', 'info');
            }
        }

        // Initialize tester
        const tester = new ConnectionTester();
        await tester.init();

        // Make functions available globally
        window.runDiagnostics = () => tester.runDiagnostics();
        window.testUSB = () => tester.testUSBConnection();
        window.testBluetooth = () => tester.testBluetoothConnection();
        window.clearLog = () => tester.clearLog();
        window.connectionTester = tester;

        // Auto-run diagnostics on load
        setTimeout(() => {
            tester.log('\nüí° Ready for testing!');
            tester.log('Click "Run Diagnostics" to check system compatibility');
            tester.log('Use "Test USB ANT+" and "Test Bluetooth" to verify connections');
        }, 500);
    </script>
</body>
</html>
