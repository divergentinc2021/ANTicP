<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANT+ WebUSB with Proper Initialization</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .log {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 5px;
            font-family: monospace;
            height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 20px 0;
        }
        .info-box {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîå ANT+ WebUSB with Proper Device Initialization</h1>
        <p>Advanced ANT+ communication with correct transfer rates and device startup</p>
        
        <div class="info-box">
            <h3>üìä ANT+ USB Transfer Rates</h3>
            <p><strong>Your observation is correct!</strong> ANT+ devices use different USB bulk transfer speeds:</p>
            <ul>
                <li><strong>50,000 Hz</strong> - Low speed mode</li>
                <li><strong>57,600 Hz</strong> - Standard ANT+ rate (equivalent to 57.6K baud)</li>
                <li><strong>115,200 Hz</strong> - High speed mode</li>
                <li><strong>2,000,000 Hz</strong> - Very high speed (2MHz)</li>
                <li><strong>3,000,000 Hz</strong> - Maximum speed (3MHz)</li>
            </ul>
            <p><strong>Key:</strong> The device must be initialized and configured to start transmission at the selected rate.</p>
        </div>

        <div class="controls">
            <button class="btn" onclick="connectDevice()">üîå Connect ANT+ Device</button>
            <button class="btn btn-success" onclick="initializeStandardRate()">‚ö° Initialize @ 57.6K</button>
            <button class="btn btn-success" onclick="initializeHighSpeed()">üöÄ Initialize @ 115.2K</button>
            <button class="btn btn-success" onclick="initializeMaxSpeed()">üí® Initialize @ 3MHz</button>
            <button class="btn" onclick="startDataTransmission()">üì° Start Data Transmission</button>
            <button class="btn btn-danger" onclick="disconnectDevice()">üîå Disconnect</button>
            <button class="btn" onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div class="log" id="log">
ANT+ WebUSB Advanced Initialization
===================================
This handles proper ANT+ device startup with configurable transfer rates.

Key improvements:
‚Ä¢ Proper ANT+ initialization sequence
‚Ä¢ Configurable transfer rates (50K - 3MHz)
‚Ä¢ Active device transmission startup
‚Ä¢ Real-time data monitoring

Click "Connect ANT+ Device" to start...
        </div>
    </div>

    <script>
        let device = null;
        let interface0 = null;
        let endpointIn = null;
        let endpointOut = null;
        let isListening = false;
        let transferRate = 57600; // Default ANT+ rate

        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logEl.textContent += logMessage + '\n';
            logEl.scrollTop = logEl.scrollHeight;
            console.log(logMessage);
        }

        async function connectDevice() {
            log('üîå Connecting to ANT+ device...');
            
            try {
                // Request ANT+ device
                device = await navigator.usb.requestDevice({
                    filters: [
                        { vendorId: 0x0FCF, productId: 0x1008 }, // Your ANT USB Stick 2
                        { vendorId: 0x0FCF, productId: 0x1009 }, // ANT USB-m Stick
                        { vendorId: 0x0FCF }, // Any Garmin/Dynastream device
                    ]
                });
                
                log(`‚úÖ Device selected: ${device.productName || 'ANT+ Device'}`);
                log(`üìä Vendor: 0x${device.vendorId.toString(16).padStart(4, '0')}`);
                log(`üìä Product: 0x${device.productId.toString(16).padStart(4, '0')}`);
                
                // Open device
                await device.open();
                log('üîå Device opened successfully');
                
                // Configure device
                if (device.configuration === null) {
                    await device.selectConfiguration(1);
                    log('‚öôÔ∏è Configuration 1 selected');
                }
                
                // Claim interface
                interface0 = device.configuration.interfaces[0];
                await device.claimInterface(interface0.interfaceNumber);
                log(`‚úÖ Interface ${interface0.interfaceNumber} claimed`);
                
                // Find endpoints
                const alt = interface0.alternate;
                endpointOut = alt.endpoints.find(ep => ep.direction === 'out' && ep.type === 'bulk');
                endpointIn = alt.endpoints.find(ep => ep.direction === 'in' && ep.type === 'bulk');
                
                if (!endpointOut || !endpointIn) {
                    throw new Error('Required bulk endpoints not found');
                }
                
                log(`üì§ OUT Endpoint: ${endpointOut.endpointNumber} (${endpointOut.packetSize} bytes)`);
                log(`üì• IN Endpoint: ${endpointIn.endpointNumber} (${endpointIn.packetSize} bytes)`);
                log('');
                log('üéØ Device connected! Now choose initialization rate...');
                
            } catch (error) {
                log(`‚ùå Connection failed: ${error.message}`);
                
                if (error.message.includes('Access denied')) {
                    log('üí° Device may be in use by other software');
                    log('üõë Close Garmin Express, ANT simulators, or training apps');
                }
            }
        }

        async function sendANTMessage(payload) {
            if (!device || !endpointOut) {
                throw new Error('Device not connected');
            }
            
            const SYNC_BYTE = 0xA4;
            const length = payload.length;
            
            // Build ANT+ message: [SYNC][LENGTH][DATA...][CHECKSUM]
            const message = [SYNC_BYTE, length, ...payload];
            
            // Calculate XOR checksum
            let checksum = 0;
            for (let i = 0; i < message.length; i++) {
                checksum ^= message[i];
            }
            message.push(checksum);
            
            // Send message
            const result = await device.transferOut(endpointOut.endpointNumber, new Uint8Array(message));
            
            if (result.status !== 'ok') {
                throw new Error(`Transfer failed: ${result.status}`);
            }
            
            const hex = message.map(b => b.toString(16).padStart(2, '0')).join(' ');
            log(`üì§ ANT+: ${hex}`);
            
            return message;
        }

        async function initializeStandardRate() {
            transferRate = 57600;
            await initializeDevice('Standard Rate (57.6K Hz)');
        }

        async function initializeHighSpeed() {
            transferRate = 115200;
            await initializeDevice('High Speed (115.2K Hz)');
        }

        async function initializeMaxSpeed() {
            transferRate = 3000000;
            await initializeDevice('Maximum Speed (3MHz)');
        }

        async function initializeDevice(rateName) {
            if (!device) {
                log('‚ùå Connect device first');
                return;
            }
            
            try {
                log(`üîß Initializing ANT+ device at ${rateName}...`);
                log(`‚ö° Transfer rate: ${transferRate} Hz`);
                
                // Step 1: Reset the ANT+ system
                log('üîÑ Resetting ANT+ system...');
                await sendANTMessage([0x4A, 0x00]); // System Reset
                await sleep(1000); // Wait for reset
                
                // Step 2: Set network key (ANT+ public network)
                log('üîë Setting ANT+ network key...');
                const networkKey = [0xB9, 0xA5, 0x21, 0xFB, 0xBD, 0x72, 0xC3, 0x45];
                await sendANTMessage([0x46, 0x00, ...networkKey]); // Set Network Key
                await sleep(100);
                
                // Step 3: Configure channels based on transfer rate
                log('üì° Configuring ANT+ channels...');
                
                // Channel 0: FE-C (Fitness Equipment Control) - Higher priority for high speeds
                await sendANTMessage([0x42, 0x00, 0x10, 0x00]); // Assign Channel
                await sendANTMessage([0x51, 0x00, 0x11, 0x05, 0x01]); // Set Channel ID (FE-C)
                await sendANTMessage([0x43, 0x00, 0xF6, 0x1F]); // Set Channel Period (8182 = 4Hz for FE-C)
                
                // Adjust frequency based on transfer rate
                let channelFreq = 57; // Default ANT+ frequency (2457 MHz)
                if (transferRate >= 115200) {
                    channelFreq = 66; // Higher frequency for high speed
                } else if (transferRate >= 2000000) {
                    channelFreq = 78; // Maximum frequency for ultra-high speed
                }
                
                await sendANTMessage([0x45, 0x00, channelFreq]); // Set Channel Frequency
                await sleep(50);
                
                // Channel 1: Heart Rate Monitor
                await sendANTMessage([0x42, 0x01, 0x10, 0x00]); // Assign Channel
                await sendANTMessage([0x51, 0x01, 0x78, 0x05, 0x01]); // Set Channel ID (HRM)
                await sendANTMessage([0x43, 0x01, 0x86, 0x1F]); // Set Channel Period (8070 = 4Hz for HRM)
                await sendANTMessage([0x45, 0x01, channelFreq]); // Set Channel Frequency
                await sleep(50);
                
                // Channel 2: Power Meter (if high speed)
                if (transferRate >= 115200) {
                    await sendANTMessage([0x42, 0x02, 0x10, 0x00]); // Assign Channel
                    await sendANTMessage([0x51, 0x02, 0x0B, 0x05, 0x01]); // Set Channel ID (Power)
                    await sendANTMessage([0x43, 0x02, 0x86, 0x1F]); // Set Channel Period
                    await sendANTMessage([0x45, 0x02, channelFreq]); // Set Channel Frequency
                    await sleep(50);
                }
                
                log(`‚úÖ ANT+ initialization complete at ${rateName}`);
                log('üì° Ready to start data transmission...');
                log('üí° Click "Start Data Transmission" to begin listening');
                
            } catch (error) {
                log(`‚ùå Initialization failed: ${error.message}`);
            }
        }

        async function startDataTransmission() {
            if (!device) {
                log('‚ùå Connect and initialize device first');
                return;
            }
            
            try {
                log('üì° Starting ANT+ data transmission...');
                
                // Open channels to start receiving data
                await sendANTMessage([0x4B, 0x00]); // Open Channel 0 (FE-C)
                await sendANTMessage([0x4B, 0x01]); // Open Channel 1 (HRM)
                
                if (transferRate >= 115200) {
                    await sendANTMessage([0x4B, 0x02]); // Open Channel 2 (Power) if high speed
                }
                
                await sleep(100);
                
                log(`‚úÖ Channels opened for data transmission`);
                log(`‚ö° Transfer rate: ${transferRate} Hz`);
                log('üëÇ Starting continuous data listener...');
                
                // Start listening for data
                isListening = true;
                startDataListener();
                
            } catch (error) {
                log(`‚ùå Failed to start transmission: ${error.message}`);
            }
        }

        async function startDataListener() {
            log('üéß Data listener active - monitoring ANT+ broadcasts...');
            
            while (isListening && device && endpointIn) {
                try {
                    // Read data with timeout based on transfer rate
                    const timeout = Math.max(1, Math.floor(1000 / (transferRate / 1000))); // Adaptive timeout
                    const result = await device.transferIn(endpointIn.endpointNumber, endpointIn.packetSize);
                    
                    if (result.status === 'ok' && result.data && result.data.byteLength > 0) {
                        const data = new Uint8Array(result.data.buffer);
                        processANTData(data);
                    }
                    
                    // Small delay based on transfer rate
                    await sleep(Math.max(1, Math.floor(10 / (transferRate / 57600))));
                    
                } catch (error) {
                    if (isListening) {
                        log(`‚ö†Ô∏è Read error: ${error.message}`);
                        
                        if (error.name === 'NetworkError') {
                            log('üîÑ Attempting to recover connection...');
                            await sleep(1000);
                            continue;
                        } else {
                            log('‚ùå Stopping listener due to persistent errors');
                            break;
                        }
                    }
                }
            }
            
            log('üõë Data listener stopped');
        }

        function processANTData(data) {
            const hex = Array.from(data).map(b => b.toString(16).padStart(2, '0')).join(' ');
            log(`üì¶ ANT+ Data (${transferRate}Hz): ${hex}`);
            
            // Parse ANT+ messages
            for (let i = 0; i < data.length; i++) {
                if (data[i] === 0xA4 && i + 3 < data.length) { // ANT+ sync byte
                    const length = data[i + 1];
                    const messageId = data[i + 2];
                    
                    if (i + length + 4 <= data.length) {
                        const messageData = data.slice(i + 3, i + 3 + length);
                        processANTMessage(messageId, messageData);
                        i += length + 3;
                    }
                }
            }
        }

        function processANTMessage(messageId, data) {
            switch (messageId) {
                case 0x4E: // Broadcast Data
                    if (data.length >= 9) {
                        const channel = data[0];
                        const deviceType = data[8];
                        const deviceId = (data[7] << 8) | data[6];
                        
                        log(`üì° Ch${channel}: Device 0x${deviceType.toString(16)} ID:${deviceId} @ ${transferRate}Hz`);
                        
                        // Parse specific device types
                        if (deviceType === 0x11) { // FE-C Trainer
                            parseTrainerData(data.slice(1, 9));
                        } else if (deviceType === 0x78) { // Heart Rate
                            parseHeartRateData(data.slice(1, 9));
                        } else if (deviceType === 0x0B) { // Power Meter
                            parsePowerData(data.slice(1, 9));
                        }
                    }
                    break;
                    
                case 0x40: // Channel Event
                    if (data.length >= 3) {
                        const channel = data[0];
                        const eventCode = data[2];
                        if (eventCode === 0x01) {
                            log(`‚úÖ Channel ${channel}: Event successful @ ${transferRate}Hz`);
                        }
                    }
                    break;
            }
        }

        function parseTrainerData(payload) {
            if (payload.length >= 8) {
                const power = (payload[6] << 8) | payload[5];
                const speed = ((payload[4] << 8) | payload[3]) * 0.001; // m/s
                log(`üö¥ Trainer: ${power}W, ${(speed * 3.6).toFixed(1)}km/h @ ${transferRate}Hz`);
            }
        }

        function parseHeartRateData(payload) {
            if (payload.length >= 8) {
                const heartRate = payload[7];
                log(`‚ù§Ô∏è Heart Rate: ${heartRate} BPM @ ${transferRate}Hz`);
            }
        }

        function parsePowerData(payload) {
            if (payload.length >= 8) {
                const power = (payload[6] << 8) | payload[5];
                const cadence = payload[3];
                log(`‚ö° Power: ${power}W, Cadence: ${cadence} RPM @ ${transferRate}Hz`);
            }
        }

        async function disconnectDevice() {
            log('üîå Disconnecting ANT+ device...');
            
            isListening = false;
            
            if (device && interface0) {
                try {
                    await device.releaseInterface(interface0.interfaceNumber);
                    await device.close();
                    log('‚úÖ Device disconnected successfully');
                } catch (error) {
                    log(`‚ö†Ô∏è Disconnect error: ${error.message}`);
                }
            }
            
            device = null;
            interface0 = null;
            endpointIn = null;
            endpointOut = null;
        }

        function clearLog() {
            document.getElementById('log').textContent = 'Log cleared.\nANT+ WebUSB Advanced Initialization ready...\n';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Initial message
        log('üîå ANT+ WebUSB Advanced Initialization Ready');
        log('‚ö° Supports transfer rates: 57.6K, 115.2K, 3MHz');
        log('üì° Proper device initialization and data transmission');
        log('üí° Connect device first, then choose initialization rate');
    </script>
</body>
</html>
