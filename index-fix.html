<!-- CRITICAL FIXES SCRIPT - Add this right before closing </body> tag -->
<script>
// OVERRIDE: Fix 24-gear system with 8-level cycling resistance system
console.log('🔧 Loading Critical Fixes for Cycling Resistance System...');

// OVERRIDE 1: Replace the old 24-gear system with 8-level resistance
const cyclingResistanceSystem = {
    currentLevel: 4, // Start at level 4 (moderate)
    minLevel: 1,
    maxLevel: 8,
    
    levels: {
        1: { resistance: '10%', description: 'Recovery - Very Easy', color: '#27ae60', power: 80 },
        2: { resistance: '20%', description: 'Endurance - Easy', color: '#2ecc71', power: 120 },
        3: { resistance: '35%', description: 'Aerobic - Moderate Easy', color: '#3498db', power: 160 },
        4: { resistance: '50%', description: 'Tempo - Moderate', color: '#f39c12', power: 200 },
        5: { resistance: '65%', description: 'Threshold - Hard', color: '#e67e22', power: 250 },
        6: { resistance: '80%', description: 'VO2 Max - Very Hard', color: '#e74c3c', power: 300 },
        7: { resistance: '90%', description: 'Anaerobic - Extremely Hard', color: '#c0392b', power: 350 },
        8: { resistance: '100%', description: 'Maximum - All Out', color: '#8e44ad', power: 400 }
    }
};

// OVERRIDE: Replace changeGear function with cycling resistance control
window.changeGear = function(direction, source = 'virtual') {
    const previousLevel = cyclingResistanceSystem.currentLevel;
    
    if (direction === 'up' && cyclingResistanceSystem.currentLevel < cyclingResistanceSystem.maxLevel) {
        cyclingResistanceSystem.currentLevel++;
    } else if (direction === 'down' && cyclingResistanceSystem.currentLevel > cyclingResistanceSystem.minLevel) {
        cyclingResistanceSystem.currentLevel--;
    }
    
    if (previousLevel !== cyclingResistanceSystem.currentLevel) {
        const levelInfo = cyclingResistanceSystem.levels[cyclingResistanceSystem.currentLevel];
        
        // Update UI with cycling resistance instead of gears
        const gearDisplay = document.getElementById('zwift-gear');
        const frontGear = document.getElementById('zwift-front-gear');
        const rearGear = document.getElementById('zwift-rear-gear');
        
        if (gearDisplay) gearDisplay.textContent = cyclingResistanceSystem.currentLevel;
        if (frontGear) frontGear.textContent = levelInfo.resistance;
        if (rearGear) rearGear.textContent = `${levelInfo.power}W`;
        
        // Update gear labels
        const frontLabel = frontGear?.parentElement.querySelector('.metric-label');
        const rearLabel = rearGear?.parentElement.querySelector('.metric-label');
        if (frontLabel) frontLabel.textContent = 'Resistance';
        if (rearLabel) rearLabel.textContent = 'Target (W)';
        
        // Set target power on Kickr
        const targetPowerEl = document.getElementById('kickr-target-power');
        if (targetPowerEl) {
            targetPowerEl.textContent = levelInfo.power;
            targetPowerEl.style.color = levelInfo.color;
        }
        
        const sourceText = source === 'real' ? '🎮 Real Zwift Click' : '🖱️ Virtual Control';
        addConnectionLog(`🚴 Cycling Level: ${cyclingResistanceSystem.currentLevel} (${levelInfo.resistance} - ${levelInfo.description}) Target: ${levelInfo.power}W via ${sourceText}`, 'info');
        
        // Enhanced visual feedback
        const gearSource = document.getElementById('gear-source');
        if (gearSource) {
            if (source === 'real') {
                gearSource.textContent = '🎮 Real Device Input';
                gearSource.style.color = '#28a745';
                gearSource.style.fontWeight = 'bold';
                
                setTimeout(() => {
                    if (window.zwiftClickHandler && window.zwiftClickHandler.isDeviceConnected()) {
                        gearSource.textContent = '🎮 Real Zwift Click';
                        gearSource.style.fontWeight = 'normal';
                    }
                }, 2000);
            }
        }
        
        // Enhanced button feedback
        const button = direction === 'up' ? 
            document.getElementById('gear-up-btn') : 
            document.getElementById('gear-down-btn');
            
        if (button) {
            button.style.transform = 'scale(0.95)';
            button.style.background = levelInfo.color;
            setTimeout(() => {
                button.style.transform = '';
                button.style.background = '';
            }, 300);
        }
        
        // Update resistance slider if it exists
        const resistanceSlider = document.getElementById('kickr-resistance-slider');
        const resistanceDisplay = document.getElementById('kickr-resistance-display');
        if (resistanceSlider && resistanceDisplay) {
            const sliderValue = (cyclingResistanceSystem.currentLevel - 4); // Center at 0
            resistanceSlider.value = sliderValue;
            resistanceDisplay.textContent = levelInfo.resistance;
            resistanceDisplay.style.color = levelInfo.color;
        }
    }
};

// OVERRIDE 2: Fix Zwift Click UI labels
function updateZwiftClickUI() {
    const gearLabel = document.querySelector('#zwift-click-card .metric-label');
    const labels = document.querySelectorAll('#zwift-click-card .metric-label');
    
    // Update gear display label
    const gearContainer = document.getElementById('zwift-gear')?.parentElement;
    if (gearContainer) {
        const gearText = gearContainer.querySelector('[style*="font-size: 0.9rem"]');
        if (gearText) gearText.textContent = 'Resistance Level';
    }
    
    // Initialize with current level
    const currentLevel = cyclingResistanceSystem.levels[cyclingResistanceSystem.currentLevel];
    const frontGear = document.getElementById('zwift-front-gear');
    const rearGear = document.getElementById('zwift-rear-gear');
    
    if (frontGear && rearGear) {
        frontGear.textContent = currentLevel.resistance;
        rearGear.textContent = `${currentLevel.power}W`;
        
        // Update labels
        const frontLabel = frontGear.parentElement.querySelector('.metric-label');
        const rearLabel = rearGear.parentElement.querySelector('.metric-label');
        if (frontLabel) frontLabel.textContent = 'Resistance';
        if (rearLabel) rearLabel.textContent = 'Target (W)';
    }
    
    // Initialize gear display
    const gearDisplay = document.getElementById('zwift-gear');
    if (gearDisplay) gearDisplay.textContent = cyclingResistanceSystem.currentLevel;
}

// OVERRIDE 3: Fix Enhanced Kickr Handler Data Parsing
class FixedKickrDataHandler {
    constructor() {
        this.lastDistance = 0;
        this.lastTime = Date.now();
        this.sessionStartTime = Date.now();
    }
    
    parseKickrData(dataView) {
        const data = {};
        
        try {
            // Enhanced power parsing (handle both 16-bit and 32-bit formats)
            if (dataView.byteLength >= 8) {
                // Standard Cycling Power Measurement
                const flags = dataView.getUint16(0, true);
                let offset = 2;
                
                // Power is always present
                data.power = dataView.getUint16(offset, true);
                offset += 2;
                
                // Handle additional fields based on flags
                if (flags & 0x01) { // Pedal Power Balance Present
                    offset += 1;
                }
                if (flags & 0x04) { // Accumulated Energy Present
                    offset += 2;
                }
                if (flags & 0x10) { // Wheel Revolution Data Present
                    const wheelRevolutions = dataView.getUint32(offset, true);
                    offset += 4;
                    const lastWheelEventTime = dataView.getUint16(offset, true);
                    offset += 2;
                    
                    // Calculate speed from wheel data
                    const wheelCircumference = 2.105; // Standard road bike wheel (700x25c)
                    const timeDiff = (lastWheelEventTime - this.lastWheelTime) / 1024; // Convert to seconds
                    
                    if (this.lastWheelTime && timeDiff > 0) {
                        const revDiff = wheelRevolutions - this.lastWheelRevolutions;
                        data.speed = (revDiff * wheelCircumference * 3.6) / timeDiff; // km/h
                    }
                    
                    this.lastWheelTime = lastWheelEventTime;
                    this.lastWheelRevolutions = wheelRevolutions;
                }
                if (flags & 0x20) { // Crank Revolution Data Present
                    const crankRevolutions = dataView.getUint16(offset, true);
                    offset += 2;
                    const lastCrankEventTime = dataView.getUint16(offset, true);
                    
                    // Calculate cadence from crank data
                    const timeDiff = (lastCrankEventTime - this.lastCrankTime) / 1024; // Convert to seconds
                    
                    if (this.lastCrankTime && timeDiff > 0) {
                        const revDiff = crankRevolutions - this.lastCrankRevolutions;
                        data.cadence = Math.round((revDiff * 60) / timeDiff); // RPM
                    }
                    
                    this.lastCrankTime = lastCrankEventTime;
                    this.lastCrankRevolutions = crankRevolutions;
                }
            } else if (dataView.byteLength >= 4) {
                // Simple 4-byte power reading
                data.power = dataView.getUint16(2, true);
            }
            
            // Calculate speed from power if not available from wheel data
            if (!data.speed && data.power > 0) {
                // Estimate speed using power-to-speed approximation
                // Formula: Speed ≈ ∛(Power × efficiency / drag coefficient)
                const efficiency = 0.22; // 22% efficiency typical for cycling
                const dragCoeff = 0.004; // Typical aerodynamic drag
                data.speed = Math.pow(data.power * efficiency / dragCoeff, 1/3) * 3.6;
            }
            
            // Calculate distance
            const currentTime = Date.now();
            const timeDiffSeconds = (currentTime - this.lastTime) / 1000;
            
            if (data.speed && timeDiffSeconds > 0) {
                const distanceIncrement = (data.speed * timeDiffSeconds) / 3600; // km
                this.lastDistance += distanceIncrement;
                data.distance = parseFloat(this.lastDistance.toFixed(2));
            }
            
            // Calculate session time
            data.time = Math.floor((currentTime - this.sessionStartTime) / 1000);
            
            this.lastTime = currentTime;
            
        } catch (error) {
            console.error('Fixed Kickr data parsing error:', error);
            addConnectionLog(`❌ Data parsing error: ${error.message}`, 'error');
        }
        
        return data;
    }
    
    updateKickrDisplay(data) {
        // Power
        if (data.power !== undefined) {
            const powerValue = document.getElementById('kickr-power-value');
            if (powerValue) {
                powerValue.textContent = data.power;
                powerValue.style.color = data.power > 200 ? '#e74c3c' : '#f39c12';
            }
        }
        
        // Speed
        if (data.speed !== undefined) {
            const speedValue = document.getElementById('kickr-speed-value');
            if (speedValue) {
                speedValue.textContent = data.speed.toFixed(1);
                speedValue.style.color = '#9b59b6';
            }
        }
        
        // Distance
        if (data.distance !== undefined) {
            const distanceValue = document.getElementById('kickr-distance-value');
            if (distanceValue) {
                distanceValue.textContent = data.distance.toFixed(2);
                distanceValue.style.color = '#1abc9c';
            }
        }
        
        // Cadence
        if (data.cadence !== undefined) {
            const cadenceValue = document.getElementById('kickr-cadence-value');
            if (cadenceValue) {
                cadenceValue.textContent = data.cadence;
                cadenceValue.style.color = '#3498db';
            }
        }
        
        // Time
        if (data.time !== undefined) {
            const timeValue = document.getElementById('kickr-time-value');
            if (timeValue) {
                const minutes = Math.floor(data.time / 60);
                const seconds = data.time % 60;
                timeValue.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                timeValue.style.color = '#34495e';
            }
        }
        
        // Resistance
        const currentLevel = cyclingResistanceSystem.levels[cyclingResistanceSystem.currentLevel];
        const resistanceValue = document.getElementById('kickr-resistance-value');
        if (resistanceValue) {
            resistanceValue.textContent = currentLevel.resistance;
            resistanceValue.style.color = currentLevel.color;
        }
        
        // Update last update time
        const lastUpdate = document.getElementById('kickr-last-update');
        if (lastUpdate) {
            lastUpdate.textContent = `🚴 Live: ${new Date().toLocaleTimeString()}`;
            lastUpdate.style.color = '#28a745';
        }
        
        // Log significant updates
        if (data.power && data.power > 0) {
            addConnectionLog(`🚴 Kickr Data: ${data.power}W, ${data.speed ? data.speed.toFixed(1) + ' km/h' : 'speed calc'}, ${data.distance ? data.distance.toFixed(2) + ' km' : 'dist calc'}`, 'info');
        }
    }
}

// OVERRIDE 4: Enhanced Kickr pairing function
window.pairEnhancedKickr = async function() {
    console.log('🚴 Enhanced Kickr pairing with fixed data handling...');
    
    if (!navigator.bluetooth) {
        addConnectionLog('❌ Bluetooth not available', 'error');
        return;
    }
    
    try {
        addConnectionLog('🔍 Scanning for Wahoo Kickr Core with enhanced filters...', 'info');
        
        const device = await navigator.bluetooth.requestDevice({
            filters: [
                { namePrefix: 'KICKR' },
                { namePrefix: 'Wahoo' },
                { services: [0x1826] }, // Fitness Machine Service
                { services: [0x1818] }  // Cycling Power Service
            ],
            optionalServices: [
                0x1826, // Fitness Machine Service
                0x1818, // Cycling Power Service  
                0x1816, // Cycling Speed and Cadence
                0x180A, // Device Information
                0x180F  // Battery Service
            ]
        });
        
        addConnectionLog(`✅ Found device: ${device.name || 'Kickr Core'}`, 'success');
        window.deviceConnectionLogger.logConnection('kickr', 'connecting');
        
        const server = await device.gatt.connect();
        addConnectionLog('🔗 Connected to Kickr Core', 'success');
        
        // Initialize fixed data handler
        const dataHandler = new FixedKickrDataHandler();
        
        // Enhanced service discovery and data setup
        const services = await server.getPrimaryServices();
        addConnectionLog(`📋 Found ${services.length} services`, 'info');
        
        let dataCharacteristic = null;
        
        // Try Cycling Power Service first (0x1818)
        try {
            const powerService = await server.getPrimaryService(0x1818);
            const powerCharacteristic = await powerService.getCharacteristic(0x2A63); // Cycling Power Measurement
            
            await powerCharacteristic.startNotifications();
            addConnectionLog('📡 Monitoring Cycling Power data', 'success');
            
            powerCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
                const data = dataHandler.parseKickrData(event.target.value);
                dataHandler.updateKickrDisplay(data);
            });
            
            dataCharacteristic = powerCharacteristic;
            
        } catch (powerError) {
            console.log('Power service not available, trying fitness machine...');
            
            try {
                const fitnessService = await server.getPrimaryService(0x1826);
                const fitnessCharacteristic = await fitnessService.getCharacteristic(0x2ACD); // Fitness Machine Status
                
                await fitnessCharacteristic.startNotifications();
                addConnectionLog('📡 Monitoring Fitness Machine data', 'success');
                
                fitnessCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
                    const data = dataHandler.parseKickrData(event.target.value);
                    dataHandler.updateKickrDisplay(data);
                });
                
                dataCharacteristic = fitnessCharacteristic;
                
            } catch (fitnessError) {
                addConnectionLog('⚠️ No standard power/fitness services found, using raw data', 'warning');
            }
        }
        
        // Enhanced disconnect handling
        device.addEventListener('gattserverdisconnected', () => {
            addConnectionLog('⚠️ Enhanced Kickr disconnected', 'warning');
            window.deviceConnectionLogger.logConnection('kickr', 'disconnected');
            
            const lastUpdate = document.getElementById('kickr-last-update');
            if (lastUpdate) {
                lastUpdate.textContent = '🔌 Kickr disconnected - ready to reconnect';
                lastUpdate.style.color = '#dc3545';
            }
        });
        
        // Store for disconnect function
        window.kickrDevice = device;
        window.deviceConnectionLogger.logConnection('kickr', 'connected', device.name);
        
        const lastUpdate = document.getElementById('kickr-last-update');
        if (lastUpdate) {
            lastUpdate.textContent = '🚴 Enhanced Kickr connected and monitoring data';
            lastUpdate.style.color = '#28a745';
        }
        
    } catch (error) {
        if (error.name === 'NotFoundError') {
            addConnectionLog('⚠️ No Kickr device selected', 'warning');
        } else {
            addConnectionLog(`❌ Enhanced Kickr pairing failed: ${error.message}`, 'error');
            window.deviceConnectionLogger.logConnection('kickr', 'error', error.message);
        }
    }
};

// OVERRIDE 5: Disconnect function
window.disconnectEnhancedKickr = function() {
    if (window.kickrDevice && window.kickrDevice.gatt.connected) {
        window.kickrDevice.gatt.disconnect();
        addConnectionLog('🔌 Enhanced Kickr disconnected', 'warning');
    }
    
    window.deviceConnectionLogger.logConnection('kickr', 'disconnected');
    
    // Reset display values
    const resetIds = ['kickr-power-value', 'kickr-speed-value', 'kickr-distance-value', 'kickr-cadence-value'];
    resetIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.textContent = '---';
    });
    
    const timeValue = document.getElementById('kickr-time-value');
    if (timeValue) timeValue.textContent = '00:00';
    
    const lastUpdate = document.getElementById('kickr-last-update');
    if (lastUpdate) {
        lastUpdate.textContent = '🚴 Ready to connect Enhanced Kickr';
        lastUpdate.style.color = '#6c757d';
    }
};

// Apply all fixes when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔧 Applying Critical Fixes...');
    
    setTimeout(() => {
        updateZwiftClickUI();
        
        // Initialize cycling resistance system
        const currentLevel = cyclingResistanceSystem.levels[cyclingResistanceSystem.currentLevel];
        const targetPowerEl = document.getElementById('kickr-target-power');
        if (targetPowerEl) {
            targetPowerEl.textContent = currentLevel.power;
            targetPowerEl.style.color = currentLevel.color;
        }
        
        console.log('✅ Critical Fixes Applied Successfully');
        addConnectionLog('🔧 Critical Fixes Applied: Cycling Resistance System + Enhanced Data Parsing', 'success');
        addConnectionLog('🚴 System now uses 8-level resistance instead of 24 gears', 'info');
        addConnectionLog('📡 Enhanced Kickr data parsing for proper speed, distance, and power mapping', 'info');
    }, 500);
});

console.log('✅ Critical Fixes Loaded Successfully');
</script>
