name: ANT+ Bridge Build and Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.9'

jobs:
  # Build downloadable packages only (no deployment conflicts)
  build-packages:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # Don't cancel other jobs if one fails
      matrix:
        os: [ubuntu-latest, windows-latest, macos-13]  # Use macos-13 to avoid migration
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        # Remove cache since we don't have package-lock.json
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Create package.json if missing
      run: |
        if [ ! -f package.json ]; then
          cat > package.json << 'EOF'
        {
          "name": "ant-bridge-server",
          "version": "1.0.0",
          "description": "ANT+ Middleware Bridge Server",
          "main": "ant-bridge-server.js",
          "scripts": {
            "start": "node ant-bridge-server.js"
          },
          "dependencies": {
            "ws": "^8.14.0"
          },
          "keywords": ["ant+", "bridge", "websocket"],
          "author": "",
          "license": "MIT"
        }
        EOF
        fi
      shell: bash
    
    - name: Install dependencies
      run: |
        npm install
        pip install pyserial pyinstaller
    
    - name: Create platform-specific package
      run: |
        mkdir -p dist/${{ matrix.os }}
        cp ant-bridge-server.js dist/${{ matrix.os }}/ || echo "ant-bridge-server.js not found, skipping"
        cp package.json dist/${{ matrix.os }}/
        cp README.md dist/${{ matrix.os }}/ || echo "README.md not found, creating basic one"
        if [ ! -f dist/${{ matrix.os }}/README.md ]; then
          cat > dist/${{ matrix.os }}/README.md << 'EOF'
        # ANT+ Bridge Server
        
        ## Setup
        1. Install Node.js and Python
        2. Run setup script for your platform
        3. Start server: `npm start`
        4. Connect browser to `ws://localhost:8888`
        EOF
        fi
      shell: bash
    
    - name: Create Windows installer (Windows only)
      if: matrix.os == 'windows-latest'
      run: |
        echo '@echo off' > dist/${{ matrix.os }}/setup.bat
        echo 'echo Installing ANT+ Bridge...' >> dist/${{ matrix.os }}/setup.bat
        echo 'npm install' >> dist/${{ matrix.os }}/setup.bat
        echo 'pip install pyserial' >> dist/${{ matrix.os }}/setup.bat
        echo 'echo Setup complete! Run "npm start" to start the server.' >> dist/${{ matrix.os }}/setup.bat
        echo 'pause' >> dist/${{ matrix.os }}/setup.bat
      shell: cmd
    
    - name: Create Unix installer (Linux/Mac)
      if: matrix.os != 'windows-latest'
      run: |
        cat > dist/${{ matrix.os }}/setup.sh << 'EOF'
        #!/bin/bash
        echo "Installing ANT+ Bridge..."
        npm install
        pip install pyserial
        echo "Setup complete! Run 'npm start' to start the server."
        EOF
        chmod +x dist/${{ matrix.os }}/setup.sh
      shell: bash
    
    - name: Create archive
      run: |
        cd dist
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          powershell Compress-Archive -Path "${{ matrix.os }}/*" -DestinationPath "ant-bridge-${{ matrix.os }}.zip"
        else
          tar -czf ant-bridge-${{ matrix.os }}.tar.gz ${{ matrix.os }}/*
        fi
      shell: bash
    
    - name: Upload package artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ant-bridge-${{ matrix.os }}
        path: dist/ant-bridge-${{ matrix.os }}.*

  # Update deployment info for your existing Railway deployment
  update-deployment-info:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # Fetch full history
    
    - name: Configure Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Create deployment info for GitHub Pages
      run: |
        mkdir -p _data
        cat > _data/deployment.json << EOF
        {
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "version": "v${{ github.run_number }}",
          "railway_deployment": {
            "url": "https://web-production-f8ebc.up.railway.app",
            "websocket": "wss://web-production-f8ebc.up.railway.app",
            "status": "deployed",
            "platform": "railway"
          },
          "local_bridge": {
            "websocket": "ws://localhost:8888",
            "platforms": ["windows", "linux", "macos"]
          },
          "test_pages": {
            "railway_bridge": "your-railway-bridge.html",
            "local_bridge": "ant-bridge-client.html",
            "config_checker": "railway-config-checker.html"
          }
        }
        EOF
    
    - name: Create deployment status page
      run: |
        cat > deployment-status.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>ANT+ Bridge Deployment Status</title>
            <style>
                body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                .status-good { color: #28a745; }
                .status-warning { color: #ffc107; }
                .deployment-card { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; }
                .btn { background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 5px; }
            </style>
        </head>
        <body>
            <h1>ğŸš‚ ANT+ Bridge Deployment Status</h1>
            
            <div class="deployment-card">
                <h2>ğŸŒ Railway Cloud Deployment</h2>
                <p><strong>Status:</strong> <span class="status-good">âœ… Live</span></p>
                <p><strong>URL:</strong> <a href="https://web-production-f8ebc.up.railway.app">web-production-f8ebc.up.railway.app</a></p>
                <p><strong>WebSocket:</strong> wss://web-production-f8ebc.up.railway.app</p>
                <p><strong>Features:</strong> Global access, demo data, interface testing</p>
                <a href="your-railway-bridge.html" class="btn">ğŸš‚ Test Railway Bridge</a>
            </div>
            
            <div class="deployment-card">
                <h2>ğŸ  Local Bridge Setup</h2>
                <p><strong>Status:</strong> <span class="status-warning">âš™ï¸ Manual Setup Required</span></p>
                <p><strong>WebSocket:</strong> ws://localhost:8888</p>
                <p><strong>Features:</strong> Real ANT+ device access, all transfer rates</p>
                <a href="#downloads" class="btn">ğŸ“¦ Download Local Bridge</a>
                <a href="ant-bridge-client.html" class="btn">ğŸ  Test Local Bridge</a>
            </div>
            
            <div class="deployment-card">
                <h2>ğŸ”§ Configuration Tools</h2>
                <a href="railway-config-checker.html" class="btn">ğŸ” Railway Config Checker</a>
                <a href="ant-bridge-automator.html" class="btn">ğŸ¤– Bridge Automator</a>
            </div>
            
            <div id="downloads">
                <h2>ğŸ“¦ Download Local Bridge</h2>
                <p>Download the bridge server to run on your computer with ANT+ USB device:</p>
                <div id="download-links">
                    <p>Latest release downloads will be available after GitHub Actions completes.</p>
                </div>
            </div>
            
            <script>
                // Auto-update download links from GitHub releases
                const repoPath = window.location.pathname.split('/').slice(1, 3).join('/');
                fetch(`https://api.github.com/repos/${repoPath}/releases/latest`)
                .then(response => response.json())
                .then(data => {
                    const downloadsDiv = document.getElementById('download-links');
                    if (data.assets && data.assets.length > 0) {
                        let html = '<h4>Available Downloads:</h4>';
                        data.assets.forEach(asset => {
                            html += `<a href="${asset.browser_download_url}" class="btn">ğŸ“± ${asset.name}</a>`;
                        });
                        downloadsDiv.innerHTML = html;
                    } else {
                        downloadsDiv.innerHTML = '<p>No releases available yet. Check back after first deployment.</p>';
                    }
                })
                .catch(() => {
                    document.getElementById('download-links').innerHTML = '<p>Visit the <a href="../../releases">Releases page</a> for downloads.</p>';
                });
            </script>
        </body>
        </html>
        EOF
    
    - name: Update GitHub Pages with deployment info
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        destination_dir: .
        keep_files: true
        force_orphan: true  # Create orphan branch if needed

  # Create GitHub release with packages (no deployment conflicts)
  create-release:
    needs: [build-packages]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && !cancelled()  # Run even if some packages failed
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        merge-multiple: true  # Merge all artifacts into one directory
    
    - name: List downloaded artifacts
      run: |
        echo "Downloaded artifacts:"
        find ./artifacts -type f -name "*.zip" -o -name "*.tar.gz" | head -10
    
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2  # Use modern release action
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        name: ANT+ Bridge v${{ github.run_number }}
        body: |
          ## ANT+ Middleware Bridge Release
          
          ### ğŸš‚ Railway Cloud Deployment
          **Live at:** https://web-production-f8ebc.up.railway.app  
          **WebSocket:** wss://web-production-f8ebc.up.railway.app  
          **Test Page:** [Railway Bridge Test](https://your-username.github.io/your-repo/your-railway-bridge.html)
          
          ### ğŸ“¦ Local Bridge Downloads
          For computers with ANT+ USB devices:
          
          ### ğŸ¯ Quick Start
          1. **Test Railway Bridge:** Use the cloud deployment for interface testing
          2. **Download Local Bridge:** For real ANT+ device access
          3. **Setup Instructions:** Extract and run setup script
          
          ### âœ¨ Features
          - âœ… All 5 ANT+ transfer rates (50K - 3MHz)
          - âœ… Real-time device data streaming  
          - âœ… Cloud and local deployment options
          - âœ… Cross-platform compatibility
          - âœ… WebSocket-based communication
        draft: false
        prerelease: false
        files: |
          ./artifacts/ant-bridge-*.zip
          ./artifacts/ant-bridge-*.tar.gz
        fail_on_unmatched_files: false  # Don't fail if some files are missing
