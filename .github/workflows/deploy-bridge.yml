name: ANT+ Bridge Build and Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Add permissions for GitHub token
permissions:
  contents: write      # For creating releases
  pages: write         # For GitHub Pages
  id-token: write      # For GitHub Pages
  actions: read        # For downloading artifacts

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.9'

jobs:
  # Build downloadable packages only (no deployment conflicts)
  build-packages:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # Don't cancel other jobs if one fails
      matrix:
        os: [ubuntu-latest, windows-latest, macos-13]  # Use macos-13 to avoid migration
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        # Remove cache since we don't have package-lock.json
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Create package.json if missing
      run: |
        if [ ! -f package.json ]; then
          cat > package.json << 'EOF'
        {
          "name": "ant-bridge-server",
          "version": "1.0.0",
          "description": "ANT+ Middleware Bridge Server",
          "main": "ant-bridge-server.js",
          "scripts": {
            "start": "node ant-bridge-server.js"
          },
          "dependencies": {
            "ws": "^8.14.0"
          },
          "keywords": ["ant+", "bridge", "websocket"],
          "author": "",
          "license": "MIT"
        }
        EOF
        fi
      shell: bash
    
    - name: Install dependencies
      run: |
        npm install
        pip install pyserial pyinstaller
    
    - name: Create platform-specific package
      run: |
        mkdir -p dist/${{ matrix.os }}
        cp ant-bridge-server.js dist/${{ matrix.os }}/ || echo "ant-bridge-server.js not found, skipping"
        cp package.json dist/${{ matrix.os }}/
        cp README.md dist/${{ matrix.os }}/ || echo "README.md not found, creating basic one"
        if [ ! -f dist/${{ matrix.os }}/README.md ]; then
          cat > dist/${{ matrix.os }}/README.md << 'EOF'
        # ANT+ Bridge Server
        
        ## Setup
        1. Install Node.js and Python
        2. Run setup script for your platform
        3. Start server: `npm start`
        4. Connect browser to `ws://localhost:8888`
        EOF
        fi
      shell: bash
    
    - name: Create Windows installer (Windows only)
      if: matrix.os == 'windows-latest'
      run: |
        echo '@echo off' > dist/${{ matrix.os }}/setup.bat
        echo 'echo Installing ANT+ Bridge...' >> dist/${{ matrix.os }}/setup.bat
        echo 'npm install' >> dist/${{ matrix.os }}/setup.bat
        echo 'pip install pyserial' >> dist/${{ matrix.os }}/setup.bat
        echo 'echo Setup complete! Run "npm start" to start the server.' >> dist/${{ matrix.os }}/setup.bat
        echo 'pause' >> dist/${{ matrix.os }}/setup.bat
      shell: cmd
    
    - name: Create Unix installer (Linux/Mac)
      if: matrix.os != 'windows-latest'
      run: |
        cat > dist/${{ matrix.os }}/setup.sh << 'EOF'
        #!/bin/bash
        echo "Installing ANT+ Bridge..."
        npm install
        pip install pyserial
        echo "Setup complete! Run 'npm start' to start the server."
        EOF
        chmod +x dist/${{ matrix.os }}/setup.sh
      shell: bash
    
    - name: Create archive
      run: |
        cd dist
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          powershell Compress-Archive -Path "${{ matrix.os }}/*" -DestinationPath "ant-bridge-${{ matrix.os }}.zip"
        else
          tar -czf ant-bridge-${{ matrix.os }}.tar.gz ${{ matrix.os }}/*
        fi
      shell: bash
    
    - name: Upload package artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ant-bridge-${{ matrix.os }}
        path: dist/ant-bridge-${{ matrix.os }}.*

  # Update deployment info for your existing Railway deployment
  update-deployment-info:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # Fetch full history
    
    - name: Configure Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Create deployment files
      run: |
        # Create deployment info JSON
        mkdir -p _data
        cat > _data/deployment.json << EOF
        {
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "version": "v${{ github.run_number }}",
          "railway_deployment": {
            "url": "https://web-production-f8ebc.up.railway.app",
            "websocket": "wss://web-production-f8ebc.up.railway.app",
            "status": "deployed",
            "platform": "railway"
          },
          "local_bridge": {
            "websocket": "ws://localhost:8888",
            "platforms": ["windows", "linux", "macos"]
          },
          "test_pages": {
            "railway_bridge": "your-railway-bridge.html",
            "local_bridge": "ant-bridge-client.html",
            "config_checker": "railway-config-checker.html"
          }
        }
        EOF
        
        # Create simple deployment status page
        cat > deployment-status.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>ANT+ Bridge Status</title>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                .card { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; }
                .btn { background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 5px; }
                .status-good { color: #28a745; font-weight: bold; }
            </style>
        </head>
        <body>
            <h1>ðŸš‚ ANT+ Bridge Status</h1>
            
            <div class="card">
                <h2>Railway Cloud Deployment</h2>
                <p><strong>Status:</strong> <span class="status-good">âœ… Live</span></p>
                <p><strong>URL:</strong> <a href="https://web-production-f8ebc.up.railway.app">web-production-f8ebc.up.railway.app</a></p>
                <p><strong>WebSocket:</strong> wss://web-production-f8ebc.up.railway.app</p>
                <a href="your-railway-bridge.html" class="btn">Test Railway Bridge</a>
            </div>
            
            <div class="card">
                <h2>Local Bridge Downloads</h2>
                <p>Download packages for local ANT+ device access:</p>
                <div id="downloads">Loading...</div>
            </div>
            
            <script>
                // Load download links
                fetch('https://api.github.com/repos/' + window.location.pathname.split('/')[1] + '/' + window.location.pathname.split('/')[2] + '/releases/latest')
                .then(r => r.json())
                .then(data => {
                    let html = '';
                    if (data.assets) {
                        data.assets.forEach(asset => {
                            html += '<a href="' + asset.browser_download_url + '" class="btn">ðŸ“± ' + asset.name + '</a>';
                        });
                    }
                    document.getElementById('downloads').innerHTML = html || 'No downloads available yet.';
                })
                .catch(() => {
                    document.getElementById('downloads').innerHTML = 'Visit <a href="../../releases">Releases</a> for downloads.';
                });
            </script>
        </body>
        </html>
        EOF
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: .
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  # Create GitHub release with packages (no deployment conflicts)
  create-release:
    needs: [build-packages]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && !cancelled()  # Run even if some packages failed
    permissions:
      contents: write
      actions: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        merge-multiple: true  # Merge all artifacts into one directory
    
    - name: List downloaded artifacts
      run: |
        echo "Downloaded artifacts:"
        find ./artifacts -type f -name "*.zip" -o -name "*.tar.gz" | head -10
        ls -la ./artifacts/
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.run_number }}
        name: ANT+ Bridge v${{ github.run_number }}
        body: |
          ## ANT+ Middleware Bridge Release v${{ github.run_number }}
          
          ### ðŸš‚ Railway Cloud Deployment
          **Live at:** https://web-production-f8ebc.up.railway.app  
          **WebSocket:** wss://web-production-f8ebc.up.railway.app  
          
          ### ðŸ“¦ Local Bridge Downloads
          Download and run on your computer for real ANT+ device access:
          
          ### ðŸŽ¯ Quick Start
          1. **Test Railway Bridge:** Use cloud deployment for interface testing
          2. **Download Local Bridge:** For real ANT+ device access  
          3. **Extract & Run:** Follow setup instructions in package
          
          ### âœ¨ Features
          - âœ… All 5 ANT+ transfer rates (50K - 3MHz)
          - âœ… Real-time device data streaming  
          - âœ… Cloud and local deployment options
          - âœ… Cross-platform compatibility
          - âœ… WebSocket-based communication
          
          Generated on: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        draft: false
        prerelease: false
        files: |
          ./artifacts/ant-bridge-*.zip
          ./artifacts/ant-bridge-*.tar.gz
        fail_on_unmatched_files: false
        token: ${{ secrets.GITHUB_TOKEN }}
